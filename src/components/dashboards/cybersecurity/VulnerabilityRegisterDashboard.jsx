"use client";

import React, { useState } from "react";
import { Plus, Trash2, AlertTriangle, Calendar } from "lucide-react";

const SEVERITIES = ["Low", "Medium", "High", "Critical"];
const STATUSES = ["Open", "In progress", "Resolved", "Deferred"];

export default function VulnerabilityRegisterDashboard() {
  const [vulnerabilities, setVulnerabilities] = useState([
    {
      id: 1,
      system: "Web Application",
      weakness: "SQL injection in login form",
      severity: "High",
      status: "Open",
      reported: "2024-01-10",
    },
    {
      id: 2,
      system: "API Gateway",
      weakness: "Missing rate limiting",
      severity: "Medium",
      status: "In progress",
      reported: "2024-01-12",
    },
  ]);

  const addVulnerability = () => {
    setVulnerabilities([
      ...vulnerabilities,
      {
        id: Date.now(),
        system: "",
        weakness: "",
        severity: "Medium",
        status: "Open",
        reported: new Date().toISOString().split("T")[0],
      },
    ]);
  };

  const updateVulnerability = (id, field, value) => {
    setVulnerabilities(
      vulnerabilities.map((v) => (v.id === id ? { ...v, [field]: value } : v))
    );
  };

  const removeVulnerability = (id) => {
    setVulnerabilities(vulnerabilities.filter((v) => v.id !== id));
  };

  const getOverdue = () => {
    const now = new Date();
    return vulnerabilities.filter((v) => {
      const reported = new Date(v.reported);
      const daysOld = (now - reported) / (1000 * 60 * 60 * 24);
      return v.status !== "Resolved" && daysOld > 30;
    });
  };

  return (
    <div className="flex flex-col gap-6 rounded-2xl bg-slate-950/80 p-4 text-slate-50 shadow-sm ring-1 ring-slate-800 md:flex-row md:p-5">
      {/* Left: register */}
      <div className="flex flex-1 flex-col gap-4">
        <div>
          <h3 className="text-sm font-semibold tracking-tight text-slate-50">
            Vulnerability register
          </h3>
          <p className="mt-1 text-xs text-slate-300">
            Record vulnerabilities with system, weakness, severity and status. Track which ones need
            attention.
          </p>
        </div>

        <div className="rounded-xl bg-slate-900/80 p-3 ring-1 ring-slate-800">
          <div className="mb-2 flex items-center justify-between">
            <label className="text-xs font-medium text-slate-200">Vulnerabilities</label>
            <button
              onClick={addVulnerability}
              className="rounded bg-sky-600 px-2 py-1 text-[0.65rem] font-medium text-white transition hover:bg-sky-700"
            >
              <Plus size={12} className="inline" /> Add
            </button>
          </div>
          <div className="space-y-2">
            {vulnerabilities.map((vuln) => (
              <div
                key={vuln.id}
                className="grid grid-cols-6 gap-2 rounded-lg border border-slate-700 bg-slate-950/80 p-2"
              >
                <input
                  type="text"
                  value={vuln.system}
                  onChange={(e) => updateVulnerability(vuln.id, "system", e.target.value)}
                  placeholder="System..."
                  className="rounded border border-slate-600 bg-slate-800 px-2 py-1 text-[0.7rem] text-slate-50 placeholder:text-slate-500 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
                />
                <input
                  type="text"
                  value={vuln.weakness}
                  onChange={(e) => updateVulnerability(vuln.id, "weakness", e.target.value)}
                  placeholder="Weakness..."
                  className="rounded border border-slate-600 bg-slate-800 px-2 py-1 text-[0.7rem] text-slate-50 placeholder:text-slate-500 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
                />
                <select
                  value={vuln.severity}
                  onChange={(e) => updateVulnerability(vuln.id, "severity", e.target.value)}
                  className="rounded border border-slate-600 bg-slate-800 px-2 py-1 text-[0.7rem] text-slate-50 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
                >
                  {SEVERITIES.map((s) => (
                    <option key={s} value={s}>
                      {s}
                    </option>
                  ))}
                </select>
                <select
                  value={vuln.status}
                  onChange={(e) => updateVulnerability(vuln.id, "status", e.target.value)}
                  className="rounded border border-slate-600 bg-slate-800 px-2 py-1 text-[0.7rem] text-slate-50 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
                >
                  {STATUSES.map((s) => (
                    <option key={s} value={s}>
                      {s}
                    </option>
                  ))}
                </select>
                <input
                  type="date"
                  value={vuln.reported}
                  onChange={(e) => updateVulnerability(vuln.id, "reported", e.target.value)}
                  className="rounded border border-slate-600 bg-slate-800 px-2 py-1 text-[0.7rem] text-slate-50 focus:border-sky-400 focus:outline-none focus:ring-1 focus:ring-sky-400"
                />
                <button
                  onClick={() => removeVulnerability(vuln.id)}
                  className="rounded p-1 text-slate-400 transition hover:text-red-400"
                >
                  <Trash2 size={12} />
                </button>
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* Right: summary */}
      <div className="flex w-full max-w-xs flex-col gap-4 md:max-w-sm">
        <div className="rounded-2xl bg-slate-900/80 p-4 ring-1 ring-slate-800">
          <div className="mb-3 flex items-center gap-2">
            <AlertTriangle size={18} className="text-sky-400" />
            <h4 className="text-xs font-semibold text-slate-100">Summary</h4>
          </div>
          <div className="space-y-2 text-xs">
            <div className="flex justify-between">
              <span className="text-slate-400">Total vulnerabilities</span>
              <span className="font-semibold text-slate-100">{vulnerabilities.length}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-slate-400">Open</span>
              <span className="font-semibold text-slate-100">
                {vulnerabilities.filter((v) => v.status === "Open").length}
              </span>
            </div>
            <div className="flex justify-between">
              <span className="text-slate-400">High/Critical</span>
              <span className="font-semibold text-red-300">
                {vulnerabilities.filter((v) => v.severity === "High" || v.severity === "Critical").length}
              </span>
            </div>
          </div>
        </div>

        {getOverdue().length > 0 && (
          <div className="rounded-2xl border border-orange-500/50 bg-orange-500/10 p-3 ring-1 ring-orange-500/30">
            <div className="mb-2 flex items-center gap-2">
              <Calendar size={16} className="text-orange-400" />
              <h4 className="text-xs font-semibold text-orange-300">Overdue</h4>
            </div>
            <div className="space-y-1 text-[0.7rem] text-orange-200">
              {getOverdue().map((v) => (
                <div key={v.id}>
                  â€¢ <strong>{v.system || "Unnamed"}</strong> - {v.weakness || "Unknown"} (reported{" "}
                  {v.reported})
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

