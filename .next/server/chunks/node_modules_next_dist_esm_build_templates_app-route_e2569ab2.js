;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="e5e7d491-0524-80e4-d5f7-1d98d2f7272d")}catch(e){}}();
module.exports=[658497,e=>{"use strict";var t=e.i(747909),s=e.i(174017),n=e.i(996250),a=e.i(759756),i=e.i(561916),r=e.i(114444),o=e.i(837092),l=e.i(869741),d=e.i(316795),u=e.i(487718),p=e.i(995169),c=e.i(47587),m=e.i(666012),f=e.i(570101),h=e.i(626937),g=e.i(10372),w=e.i(193695);e.i(52474);var R=e.i(600220),v=e.i(89171),y=e.i(757660),A=e.i(568212),I=e.i(124594),x=e.i(895968),S=e.i(936426),N=e.i(657194),q=e.i(199355),E=e.i(51662),C=e.i(986225);let O=new Set(["cybersecurity"]),T=new Set(["foundations","applied","practice"]),b={foundations:[{domain:"basics",count:10},{domain:"identity",count:10},{domain:"network",count:10},{domain:"crypto",count:8},{domain:"risk",count:6},{domain:"response",count:6}],applied:[{domain:"web",count:16},{domain:"api",count:10},{domain:"auth",count:8},{domain:"secrets",count:6},{domain:"cloud",count:5},{domain:"logging",count:5}],practice:[{domain:"sdlc",count:10},{domain:"zero-trust",count:8},{domain:"runtime",count:8},{domain:"vulnerability",count:8},{domain:"detection",count:8},{domain:"governance",count:8}]};function M(e){for(let t of String(e||"").split(",").map(e=>e.trim()).filter(Boolean))if(t.startsWith("domain:"))return t.slice(7);return""}function P(e){let t=e.slice();for(let e=t.length-1;e>0;e-=1){let s=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[s],t[s]=n}return t}function k(e){try{let t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}async function _(e){return(0,x.withRequestLogging)(e,{route:"POST /api/assessments/start"},async()=>{let t=(0,S.requireSameOrigin)(e);if(t)return t;let s=(0,N.rateLimit)(e,{keyPrefix:"assessments-start",limit:20,windowMs:6e4});if(s)return s;let n=await (0,y.getServerSession)(A.authOptions).catch(()=>null),a=n?.user?.id||"";if(!a)return v.NextResponse.json({message:"Unauthorized"},{status:401});let i=await e.json().catch(()=>null),r="string"==typeof i?.courseId?i.courseId.trim():"",o="string"==typeof i?.levelId?i.levelId.trim():"",l="string"==typeof i?.certificateName?i.certificateName.trim():"";if(!r||!O.has(r))return v.NextResponse.json({message:"Invalid courseId"},{status:400});if(!o||!T.has(o))return v.NextResponse.json({message:"Invalid levelId"},{status:400});if(!l||l.length<2||l.length>120)return v.NextResponse.json({message:"Name required"},{status:400});let d=await I.prisma.learnerProfile.findUnique({where:{userId:a},select:{certificateName:!0}});if(d&&d.certificateName!==l)return v.NextResponse.json({message:"Name does not match locked value"},{status:409});d||await I.prisma.learnerProfile.create({data:{userId:a,certificateName:l},select:{userId:!0}});let u=(0,E.getAssessmentAttemptCredits)({courseId:r,levelId:o}),p=await (0,q.enforceCreditGate)(u,1);if(!p.ok)return(0,q.creditGateErrorResponse)(p);let c=await I.prisma.assessment.findUnique({where:{courseId_levelId:{courseId:r,levelId:o}},select:{id:!0,passThreshold:!0,timeLimit:!0}});if(!c)return v.NextResponse.json({message:"Assessment not found"},{status:404});let m=c.timeLimit??75,f=new Date,h=(0,C.getActiveCourseVersion)(r),g=`v:${h}`,w=await I.prisma.assessmentAttempt.findMany({where:{userId:a,assessmentId:c.id,courseVersion:h},orderBy:{completedAt:"desc"},take:2,select:{questionIds:!0}}),R=w[0]?.questionIds?k(w[0].questionIds):[],x=new Set;if(w[1]?.questionIds)for(let e of k(w[1].questionIds||"[]"))x.add(String(e));let _=await I.prisma.assessmentSession.findUnique({where:{userId_assessmentId:{userId:a,assessmentId:c.id}},select:{id:!0,questionIds:!0,startedAt:!0,expiresAt:!0}});if(_&&_.expiresAt.getTime()>f.getTime()){let e=JSON.parse(_.questionIds||"[]"),t=new Map((await I.prisma.question.findMany({where:{id:{in:e}},select:{id:!0,question:!0,options:!0,type:!0}})).map(e=>[e.id,e])),s=e.map(e=>t.get(e)).filter(Boolean);return v.NextResponse.json({sessionId:_.id,startedAt:_.startedAt.toISOString(),expiresAt:_.expiresAt.toISOString(),timeLimitMinutes:m,passThreshold:c.passThreshold,requiredCredits:u,questions:s.map(e=>({id:e.id,type:e.type,question:e.question,options:e.options?JSON.parse(e.options):null}))},{status:200})}_&&await I.prisma.assessmentSession.delete({where:{userId_assessmentId:{userId:a,assessmentId:c.id}}});let U=await I.prisma.question.findMany({where:{assessmentId:c.id,AND:[{tags:{contains:g}},{tags:{contains:"published"}}]},select:{id:!0,tags:!0},take:500});if(U.length<150)return v.NextResponse.json({message:"Not enough questions available for randomised attempts"},{status:503});let j=new Map,D=U.map(e=>({id:e.id,tags:String(e.tags||"")}));for(let e of D){let t=M(e.tags);if(!t)continue;let s=j.get(t)||[];s.push(e.id),j.set(t,s)}let H=[],B=new Set,$=b[o]||[];function F(e,t){let s=P(e),n=s.filter(e=>!B.has(e)&&!x.has(e)),a=s.filter(e=>!B.has(e)),i=[];for(let e of n){if(i.length>=t)break;i.push(e)}if(i.length<t)for(let e of a){if(i.length>=t)break;i.includes(e)||i.push(e)}return i}let L=[];if(R.length){let e=await I.prisma.assessmentAttempt.findFirst({where:{userId:a,assessmentId:c.id,courseVersion:h},orderBy:{completedAt:"desc"},select:{id:!0}});if(e?.id){let t=P((await I.prisma.assessmentAttemptItem.findMany({where:{attemptId:e.id,correct:!1},select:{questionId:!0},take:200})).map(e=>e.questionId)).filter(e=>D.some(t=>t.id===e));L.push(...t.slice(0,15))}if(L.length<15)for(let e of P(R.map(e=>String(e)))){if(L.length>=15)break;!L.includes(e)&&D.some(t=>t.id===e)&&L.push(e)}}let K=new Map;if(L.length){for(let e of D.filter(e=>L.includes(e.id))){let t=M(e.tags);t&&K.set(t,(K.get(t)||0)+1)}for(let e of L)H.push(e),B.add(e);for(let e of R.map(e=>String(e)))B.has(e)||x.add(e)}for(let e of $){let t=K.get(e.domain)||0,s=Math.max(0,e.count-t);for(let t of F(j.get(e.domain)||[],s))B.has(t)||(H.push(t),B.add(t))}if(H.length<50)for(let e of F(D.map(e=>e.id),50-H.length))B.has(e)||(H.push(e),B.add(e));if(H.length<50)return v.NextResponse.json({message:"Not enough questions available"},{status:503});let G=P(H).slice(0,50),J=new Date,V=new Date(J.getTime()+6e4*m),z=await I.prisma.assessmentSession.create({data:{userId:a,assessmentId:c.id,questionIds:JSON.stringify(G),startedAt:J,expiresAt:V},select:{id:!0,startedAt:!0,expiresAt:!0}}),W=new Map((await I.prisma.question.findMany({where:{id:{in:G}},select:{id:!0,question:!0,options:!0,type:!0}})).map(e=>[e.id,e])),X=G.map(e=>W.get(e)).filter(Boolean);return v.NextResponse.json({sessionId:z.id,startedAt:z.startedAt.toISOString(),expiresAt:z.expiresAt.toISOString(),timeLimitMinutes:m,passThreshold:c.passThreshold,requiredCredits:u,questions:X.map(e=>({id:e.id,type:e.type,question:e.question,options:e.options?JSON.parse(e.options):null}))},{status:200})})}e.s(["POST",()=>_],754296);var U=e.i(754296);let j=new t.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/assessments/start/route",pathname:"/api/assessments/start",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/assessments/start/route.ts",nextConfigOutput:"",userland:U}),{workAsyncStorage:D,workUnitAsyncStorage:H,serverHooks:B}=j;function $(){return(0,n.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:H})}async function F(e,t,n){j.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/assessments/start/route";v=v.replace(/\/index$/,"")||"/";let y=await j.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:A,params:I,nextConfig:x,parsedUrl:S,isDraftMode:N,prerenderManifest:q,routerServerContext:E,isOnDemandRevalidate:C,revalidateOnlyGenerated:O,resolvedPathname:T,clientReferenceManifest:b,serverActionsManifest:M}=y,P=(0,l.normalizeAppPath)(v),k=!!(q.dynamicRoutes[P]||q.routes[T]),_=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,S,!1):t.end("This page could not be found"),null);if(k&&!N){let e=!!q.routes[T],t=q.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await _();throw new w.NoFallbackError}}let U=null;!k||j.isDev||N||(U="/index"===(U=T)?"/":U);let D=!0===j.isDev||!k,H=k&&!D;M&&b&&(0,r.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:b,serverActionsManifest:M,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:M})});let B=e.method||"GET",$=(0,i.getTracer)(),F=$.getActiveScopeSpan(),L={params:I,prerenderManifest:q,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,n)=>j.onRequestError(e,t,n,E)},sharedContext:{buildId:A}},K=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),J=u.NextRequestAdapter.fromNodeNextRequest(K,(0,u.signalFromNodeResponse)(t));try{let r=async e=>j.handle(J,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=$.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=s.get("next.route");if(n){let t=`${B} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${v}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var i,l;let d=async({previousCacheEntry:s})=>{try{if(!o&&C&&O&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await r(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!k)return await (0,m.sendResponse)(K,G,i,L.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:n}}}}catch(t){throw(null==s?void 0:s.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},E),t}},u=await j.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:q,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:o});if(!k)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&k||p.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(K,G,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};F?await l(F):await $.withPropagatedContext(e.headers,()=>$.trace(p.BaseServerSpan.handleRequest,{spanName:`${B} ${v}`,kind:i.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},l))}catch(t){if(t instanceof w.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})}),k)throw t;return await (0,m.sendResponse)(K,G,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>$,"routeModule",()=>j,"serverHooks",()=>B,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>H],658497)}];

//# debugId=e5e7d491-0524-80e4-d5f7-1d98d2f7272d
//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e2569ab2.js.map