{
  "version": 3,
  "sources": [],
  "debugId": "64a2e25e-01e7-c839-5c7f-5d02bd825567",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../src/lib/security/rateLimit.ts","../../../src/lib/security/adminAuth.ts","../../../src/lib/admin/supportStore.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport crypto from \"crypto\";\n\ntype Options = {\n  keyPrefix: string;\n  limit: number;\n  windowMs: number;\n  keySuffix?: string;\n  message?: string;\n};\n\ntype Entry = { count: number; resetAt: number };\n\nconst buckets = new Map<string, Entry>();\n\nfunction hash(value: string) {\n  return crypto.createHash(\"sha256\").update(value).digest(\"hex\").slice(0, 24);\n}\n\nfunction getClientKey(req: Request, keySuffix?: string) {\n  // Privacy: we do not persist IPs; we only keep a short-lived hash in memory.\n  const forwarded = req.headers.get(\"x-forwarded-for\") || \"\";\n  const ip = forwarded.split(\",\")[0]?.trim() || req.headers.get(\"x-real-ip\") || \"unknown\";\n  const ua = req.headers.get(\"user-agent\") || \"unknown\";\n  return hash(`${ip}|${ua}|${keySuffix || \"\"}`);\n}\n\nexport function rateLimit(req: Request, opts: Options) {\n  const now = Date.now();\n  const key = `${opts.keyPrefix}:${getClientKey(req, opts.keySuffix)}`;\n  const existing = buckets.get(key);\n  if (!existing || existing.resetAt <= now) {\n    buckets.set(key, { count: 1, resetAt: now + opts.windowMs });\n    return null;\n  }\n  existing.count += 1;\n  if (existing.count > opts.limit) {\n    const retryAfter = Math.max(1, Math.ceil((existing.resetAt - now) / 1000));\n    return NextResponse.json(\n      { error: opts.message || \"Too many requests. Please try again shortly.\" },\n      { status: 429, headers: { \"retry-after\": String(retryAfter) } }\n    );\n  }\n  return null;\n}\n\n\n","import { NextResponse } from \"next/server\";\nimport { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth/options\";\nimport { requireAdminPermission, type AdminPermission } from \"@/lib/admin/rbac\";\n\nexport async function requireAdminJson(permission: AdminPermission = \"VIEW_SYSTEM\") {\n  const session = await getServerSession(authOptions).catch(() => null);\n  if (!session?.user) {\n    return { ok: false as const, response: NextResponse.json({ error: \"Unauthorized\" }, { status: 401 }) };\n  }\n  try {\n    const { role } = requireAdminPermission(session.user, permission);\n    return { ok: true as const, session, role };\n  } catch (err: any) {\n    const status = typeof err?.status === \"number\" ? err.status : 403;\n    return { ok: false as const, response: NextResponse.json({ error: \"Forbidden\" }, { status }) };\n  }\n}\n\n\n","import { prisma } from \"@/lib/db/prisma\";\n\nexport type SupportStatus = \"open\" | \"in_progress\" | \"resolved\";\n\nexport type SupportTicketListItem = {\n  id: string;\n  userId: string | null;\n  name: string | null;\n  email: string | null;\n  category: string;\n  status: SupportStatus;\n  createdAt: string;\n  updatedAt: string;\n};\n\nfunction toIso(d: any) {\n  try {\n    return new Date(d).toISOString();\n  } catch {\n    return new Date(0).toISOString();\n  }\n}\n\nexport async function listSupportTicketsAdminSafe(opts: {\n  status?: SupportStatus | null;\n  category?: string | null;\n  take: number;\n  cursor?: string | null;\n  sort: \"newest\" | \"oldest\";\n}) {\n  const take = Math.max(1, Math.min(50, opts.take));\n  const where: any = {};\n  if (opts.status) where.status = opts.status;\n  if (opts.category) where.category = String(opts.category);\n\n  const orderBy = opts.sort === \"oldest\" ? { createdAt: \"asc\" as const } : { createdAt: \"desc\" as const };\n\n  const rows = await (prisma as any).supportTicket.findMany({\n    where,\n    take: take + 1,\n    ...(opts.cursor ? { cursor: { id: opts.cursor }, skip: 1 } : {}),\n    orderBy,\n    select: {\n      id: true,\n      userId: true,\n      name: true,\n      email: true,\n      category: true,\n      status: true,\n      createdAt: true,\n      updatedAt: true,\n    },\n  });\n\n  const next = rows.length > take ? rows[take] : null;\n  const slice = rows.slice(0, take);\n  return {\n    items: slice.map((r: any) => ({\n      id: String(r.id),\n      userId: r.userId ? String(r.userId) : null,\n      name: r.name ? String(r.name) : null,\n      email: r.email ? String(r.email) : null,\n      category: String(r.category || \"\"),\n      status: r.status as SupportStatus,\n      createdAt: toIso(r.createdAt),\n      updatedAt: toIso(r.updatedAt),\n    })) satisfies SupportTicketListItem[],\n    nextCursor: next ? String(next.id) : null,\n  };\n}\n\nexport async function getSupportTicketAdminSafe(id: string) {\n  const row = await (prisma as any).supportTicket.findUnique({\n    where: { id },\n    select: {\n      id: true,\n      userId: true,\n      name: true,\n      email: true,\n      category: true,\n      message: true,\n      status: true,\n      createdAt: true,\n      updatedAt: true,\n      attachments: { select: { id: true, fileName: true, mimeType: true, sizeBytes: true, storageKey: true, createdAt: true } },\n      notes: { select: { id: true, adminUserId: true, note: true, createdAt: true }, orderBy: { createdAt: \"desc\" as const } },\n    },\n  });\n  if (!row) return null;\n  return {\n    id: String(row.id),\n    userId: row.userId ? String(row.userId) : null,\n    name: row.name ? String(row.name) : null,\n    email: row.email ? String(row.email) : null,\n    category: String(row.category || \"\"),\n    message: String(row.message || \"\"),\n    status: row.status as SupportStatus,\n    createdAt: toIso(row.createdAt),\n    updatedAt: toIso(row.updatedAt),\n    attachments: (row.attachments || []).map((a: any) => ({\n      id: String(a.id),\n      fileName: String(a.fileName),\n      mimeType: String(a.mimeType),\n      sizeBytes: Number(a.sizeBytes),\n      storageKey: a.storageKey ? String(a.storageKey) : null,\n      createdAt: toIso(a.createdAt),\n    })),\n    notes: (row.notes || []).map((n: any) => ({ id: String(n.id), adminUserId: String(n.adminUserId), note: String(n.note), createdAt: toIso(n.createdAt) })),\n  };\n}\n\nexport async function setSupportTicketStatus(id: string, status: SupportStatus) {\n  await (prisma as any).supportTicket.update({ where: { id }, data: { status } });\n}\n\nexport async function addSupportTicketNote(id: string, adminUserId: string, note: string) {\n  await (prisma as any).supportTicketNote.create({ data: { ticketId: id, adminUserId, note } });\n}\n\n\n"],"names":[],"mappings":"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"}}]
}