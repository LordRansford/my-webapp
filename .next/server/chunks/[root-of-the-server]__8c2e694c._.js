;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="b538c792-4b79-83dd-9ca0-ee24ca236e58")}catch(e){}}();
module.exports=[814747,(e,t,s)=>{t.exports=e.x("path",()=>require("path"))},522734,(e,t,s)=>{t.exports=e.x("fs",()=>require("fs"))},29173,(e,t,s)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},254799,(e,t,s)=>{t.exports=e.x("crypto",()=>require("crypto"))},902157,(e,t,s)=>{t.exports=e.x("node:fs",()=>require("node:fs"))},750227,(e,t,s)=>{t.exports=e.x("node:path",()=>require("node:path"))},464592,e=>{"use strict";let t=new Set(["authorization","cookie","set-cookie","stripe-signature","secret","token","password","apiKey","apikey","client_secret"]);function s(e,s,n){let r={level:e,event:String(s||"").slice(0,80),ts:new Date().toISOString(),...function e(s,n=0){if(n>4)return"[TRUNCATED]";if(null==s)return s;if(Array.isArray(s))return s.slice(0,20).map(t=>e(t,n+1));if("object"!=typeof s)return s;let r={};for(let[a,i]of Object.entries(s)){let s=String(a),o=s.toLowerCase();if(t.has(o)||o.includes("secret")||o.includes("token")||o.includes("password")){r[s]=null==i?i:("string"==typeof i&&i.length,"[REDACTED]");continue}r[s]=e(i,n+1)}return r}(n&&"object"==typeof n?n:{})};"error"===e?console.error(r):"warn"===e?console.warn(r):console.log(r)}function n(e,t){s("info",e,t)}function r(e,t){s("warn",e,t)}e.s(["logInfo",()=>n,"logWarn",()=>r])},534189,e=>{"use strict";var t=e.i(902157),s=e.i(750227);let n=process.env.ANALYTICS_STORE_PATH||"data/learning-analytics.json",r={users:{}};function a(){try{let e=s.default.isAbsolute(n)?n:s.default.join(process.cwd(),n);if(!t.default.existsSync(e))return r;let a=t.default.readFileSync(e,"utf8");return JSON.parse(a)}catch{return r}}function i(e,r){let i,o,l,u=a(),d=u.users[e]||{userId:e,events:[],updatedAt:new Date().toISOString()},c=(r||[]).filter(Boolean).map(e=>({...e,timestamp:e.timestamp||new Date().toISOString()})).slice(0,200),p={userId:e,updatedAt:new Date().toISOString(),events:[...d.events,...c].slice(-2e3)};return u.users[e]=p,i=s.default.isAbsolute(n)?n:s.default.join(process.cwd(),n),o=s.default.dirname(i),t.default.existsSync(o)||t.default.mkdirSync(o,{recursive:!0}),l=`${i}.tmp`,t.default.writeFileSync(l,JSON.stringify(u,null,2),"utf8"),t.default.renameSync(l,i),p}function o(e){return a().users[e]||{userId:e,events:[],updatedAt:new Date().toISOString()}}function l(){let e=Object.values(a().users),t={sectionsStarted:0,sectionsCompleted:0,quizAttempts:0,quizCompleted:0,toolUsed:0},s=new Map,n=new Map,r=new Map;for(let a of e)for(let e of a.events){if("section_started"===e.type&&(t.sectionsStarted+=1),"section_completed"===e.type&&(t.sectionsCompleted+=1),"quiz_attempted"===e.type&&(t.quizAttempts+=1),"quiz_completed"===e.type&&(t.quizCompleted+=1),"tool_used"===e.type&&(t.toolUsed+=1),e.sectionId&&e.trackId&&e.levelId){let t=`${e.trackId}:${e.levelId}:${e.sectionId}`;s.set(t,(s.get(t)||0)+1)}if(e.quizId){let t=n.get(e.quizId)||{attempts:0,completed:0};"quiz_attempted"===e.type&&(t.attempts+=1),"quiz_completed"===e.type&&(t.completed+=1),n.set(e.quizId,t)}e.toolId&&r.set(e.toolId,(r.get(e.toolId)||0)+1)}let i=[...s.entries()].sort((e,t)=>t[1]-e[1]).slice(0,20).map(([e,t])=>({key:e,count:t}));return{totals:t,topSections:i,lowestQuizCompletion:[...n.entries()].map(([e,t])=>({quizId:e,attempts:t.attempts,completed:t.completed,completionRate:t.attempts?t.completed/t.attempts:0})).filter(e=>e.attempts>=5).sort((e,t)=>e.completionRate-t.completionRate).slice(0,20),mostUsedTools:[...r.entries()].sort((e,t)=>t[1]-e[1]).slice(0,20).map(([e,t])=>({toolId:e,count:t})),usersTracked:e.length}}e.s(["appendAnalyticsEvents",()=>i,"getOwnerAnalyticsSummary",()=>l,"getUserAnalytics",()=>o])},884393,e=>{"use strict";let t=e.r(534189),s=t.appendAnalyticsEvents,n=t.getUserAnalytics;t.getOwnerAnalyticsSummary,e.s(["appendAnalyticsEvents",0,s,"getUserAnalytics",0,n])},283120,e=>{"use strict";var t=e.i(926747),s=e.i(190406),n=e.i(244898),r=e.i(262950),a=e.i(828414),i=e.i(489521),o=e.i(192489),l=e.i(884393);let u=new Map;async function d(e,t){var s;let n,r;if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});let d=await (0,a.getServerSession)(e,t,i.authOptions),c=d?.user?.id;if(!c)return t.status(401).json({message:"Authentication required"});let p=e.headers["x-forwarded-for"]||e.socket.remoteAddress||"anon";if(s=`analytics:${p}:${c}`,n=Date.now(),r=u.get(s)||{count:0,start:n},n-r.start>6e4?(u.set(s,{count:1,start:n}),!1):r.count>=60||(r.count+=1,u.set(s,r),!1))return t.status(429).json({message:"Rate limit exceeded"});let m=(0,o.getUserById)(c);if(!m)return t.status(404).json({message:"User not found"});if(!(m.consent||{}).cpdDataUseAcceptedAt)return t.status(403).json({message:"Consent required"});let f="string"==typeof e.body?JSON.parse(e.body):e.body,y=Array.isArray(f?.events)?f.events:[];return 0===y.length?t.status(400).json({message:"No events"}):((0,l.appendAnalyticsEvents)(c,y.map(e=>({type:e.type,timestamp:e.timestamp||new Date().toISOString(),trackId:e.trackId,levelId:e.levelId,sectionId:e.sectionId,quizId:e.quizId,success:"boolean"==typeof e.success?e.success:void 0,toolId:e.toolId}))),t.status(200).json({ok:!0}))}e.s(["default",()=>d],660588);var c=e.i(660588),p=e.i(7031),m=e.i(181927),f=e.i(846432);let y=(0,r.hoist)(c,"default"),g=(0,r.hoist)(c,"config"),v=new n.PagesAPIRouteModule({definition:{kind:s.RouteKind.PAGES_API,page:"/api/analytics/events",pathname:"/api/analytics/events",bundlePath:"",filename:""},userland:c,distDir:".next",relativeProjectDir:""});async function S(e,s,n){v.isDev&&(0,f.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/analytics/events";r=r.replace(/\/index$/,"")||"/";let a=await v.prepare(e,s,{srcPage:r});if(!a){s.statusCode=400,s.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve());return}let{query:i,params:o,prerenderManifest:l,routerServerContext:u}=a;try{let t=e.method||"GET",n=(0,p.getTracer)(),a=n.getActiveScopeSpan(),d=v.instrumentationOnRequestError.bind(v),c=async a=>v.render(e,s,{query:{...i,...o},params:o,allowedRevalidateHeaderKeys:[],multiZoneDraftMode:!1,trustHostHeader:!1,previewProps:l.preview,propagateError:!1,dev:v.isDev,page:"/api/analytics/events",internalRevalidate:null==u?void 0:u.revalidate,onError:(...t)=>d(e,...t)}).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":s.statusCode,"next.rsc":!1});let e=n.getRootSpanAttributes();if(!e)return;if(e.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${e.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=e.get("next.route");if(i){let e=`${t} ${i}`;a.setAttributes({"next.route":i,"http.route":i,"next.span_name":e}),a.updateName(e)}else a.updateName(`${t} ${r}`)});a?await c(a):await n.withPropagatedContext(e.headers,()=>n.trace(m.BaseServerSpan.handleRequest,{spanName:`${t} ${r}`,kind:p.SpanKind.SERVER,attributes:{"http.method":t,"http.target":e.url}},c))}catch(e){if(v.isDev)throw e;(0,t.sendError)(s,500,"Internal Server Error")}finally{null==n.waitUntil||n.waitUntil.call(n,Promise.resolve())}}e.s(["config",0,g,"default",0,y,"handler",()=>S],283120)}];

//# debugId=b538c792-4b79-83dd-9ca0-ee24ca236e58
//# sourceMappingURL=%5Broot-of-the-server%5D__8c2e694c._.js.map