;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="cd760ae8-1553-da0d-6d1e-ba8d57d80837")}catch(e){}}();
module.exports=[392647,e=>{"use strict";var t=e.i(902157),r=e.i(750227);let a=process.env.ANALYTICS_STORE_PATH||"data/learning-analytics.json",n={users:{}};function i(){try{let e=r.default.isAbsolute(a)?a:r.default.join(process.cwd(),a);if(!t.default.existsSync(e))return n;let i=t.default.readFileSync(e,"utf8");return JSON.parse(i)}catch{return n}}function s(e,n){let s,o,l,d=i(),u=d.users[e]||{userId:e,events:[],updatedAt:new Date().toISOString()},c=(n||[]).filter(Boolean).map(e=>({...e,timestamp:e.timestamp||new Date().toISOString()})).slice(0,200),p={userId:e,updatedAt:new Date().toISOString(),events:[...u.events,...c].slice(-2e3)};return d.users[e]=p,s=r.default.isAbsolute(a)?a:r.default.join(process.cwd(),a),o=r.default.dirname(s),t.default.existsSync(o)||t.default.mkdirSync(o,{recursive:!0}),l=`${s}.tmp`,t.default.writeFileSync(l,JSON.stringify(d,null,2),"utf8"),t.default.renameSync(l,s),p}function o(e){return i().users[e]||{userId:e,events:[],updatedAt:new Date().toISOString()}}function l(){let e=Object.values(i().users),t={sectionsStarted:0,sectionsCompleted:0,quizAttempts:0,quizCompleted:0,toolUsed:0},r=new Map,a=new Map,n=new Map;for(let i of e)for(let e of i.events){if("section_started"===e.type&&(t.sectionsStarted+=1),"section_completed"===e.type&&(t.sectionsCompleted+=1),"quiz_attempted"===e.type&&(t.quizAttempts+=1),"quiz_completed"===e.type&&(t.quizCompleted+=1),"tool_used"===e.type&&(t.toolUsed+=1),e.sectionId&&e.trackId&&e.levelId){let t=`${e.trackId}:${e.levelId}:${e.sectionId}`;r.set(t,(r.get(t)||0)+1)}if(e.quizId){let t=a.get(e.quizId)||{attempts:0,completed:0};"quiz_attempted"===e.type&&(t.attempts+=1),"quiz_completed"===e.type&&(t.completed+=1),a.set(e.quizId,t)}e.toolId&&n.set(e.toolId,(n.get(e.toolId)||0)+1)}let s=[...r.entries()].sort((e,t)=>t[1]-e[1]).slice(0,20).map(([e,t])=>({key:e,count:t}));return{totals:t,topSections:s,lowestQuizCompletion:[...a.entries()].map(([e,t])=>({quizId:e,attempts:t.attempts,completed:t.completed,completionRate:t.attempts?t.completed/t.attempts:0})).filter(e=>e.attempts>=5).sort((e,t)=>e.completionRate-t.completionRate).slice(0,20),mostUsedTools:[...n.entries()].sort((e,t)=>t[1]-e[1]).slice(0,20).map(([e,t])=>({toolId:e,count:t})),usersTracked:e.length}}e.s(["appendAnalyticsEvents",()=>s,"getOwnerAnalyticsSummary",()=>l,"getUserAnalytics",()=>o])},604791,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),i=e.i(561916),s=e.i(114444),o=e.i(837092),l=e.i(869741),d=e.i(316795),u=e.i(487718),c=e.i(995169),p=e.i(47587),m=e.i(666012),f=e.i(570101),h=e.i(626937),g=e.i(10372),v=e.i(193695);e.i(52474);var R=e.i(600220),w=e.i(757660),S=e.i(568212),I=e.i(936426),y=e.i(657194),A=e.i(996388),E=e.i(519193),C=e.i(816654);let O=e.r(392647);O.appendAnalyticsEvents;let x=O.getUserAnalytics;O.getOwnerAnalyticsSummary;var _=e.i(946628),T=e.i(400652),N=e.i(124594),q=e.i(986225);async function b(e){return(0,A.handleAppRoute)(e,{route:"POST /api/learning/records/refresh"},async({requestId:t})=>{let r=(0,I.requireSameOrigin)(e);if(r)return r;let a=(0,y.rateLimit)(e,{keyPrefix:"learning-records-refresh",limit:20,windowMs:6e4});if(a)return a;let n=await (0,w.getServerSession)(S.authOptions);if(!n?.user?.id)throw new E.AppError({code:"UNAUTHORIZED",status:401,message:"Unauthorized",exposeMessage:"Unauthorized"});let i=await e.json().catch(()=>null),s=String(i?.courseId||"").trim(),o=String(i?.levelId||"").trim();if(!s||!o)throw new E.AppError({code:"VALIDATION_ERROR",status:400,message:"Missing courseId or levelId",exposeMessage:"Missing courseId or levelId"});let l=function(e){let{userId:t,courseId:r,levelId:a}=e,n=(0,C.getCpdState)(t),i=n?.stateJson?JSON.parse(n.stateJson):{sections:[],activity:[]},s=x(t),o="cybersecurity"===r?"cyber":"software-architecture"===r?"software-architecture":"digitalisation"===r?"digitalisation":"data"===r?"data":"ai",l=new Set((i.sections||[]).filter(e=>e.trackId===o&&e.levelId===a&&e.completed&&"overall"!==e.sectionId).map(e=>`${o}:${a}:${String(e.sectionId)}`)),d=new Set((s.events||[]).filter(e=>"section_completed"===e.type&&e.trackId===o&&e.levelId===a).map(e=>`${o}:${a}:${String(e.sectionId)}`)),u=new Set([...l].filter(e=>d.has(e))),c=new Set((s.events||[]).filter(e=>"quiz_completed"===e.type&&e.trackId===o&&e.levelId===a).map(e=>String(e.quizId||"")).filter(Boolean)),p=new Set((s.events||[]).filter(e=>"tool_used"===e.type&&e.trackId===o&&e.levelId===a).map(e=>String(e.toolId||"")).filter(Boolean)),m=new Set((i?.sections||[]).filter(e=>e.trackId===o&&e.levelId===a&&"overall"!==e.sectionId).map(e=>String(e.sectionId))).size,f=(0,T.getCourseLevelMeta)(r,a),h=Math.round(60*(Number(f?.estimatedHours||0)||0)),g=(0,_.deriveLearningRecord)({userId:t,courseId:r,levelId:a,totalSections:m,completedSectionKeys:u,quizIdsCompleted:c,toolIdsUsed:p,estimatedMinutes:h}),v=(0,_.upsertLearningRecord)(g);if("completed"===v.completionStatus){let e=`${r}:${a}`,n=(0,q.getActiveCourseVersion)(r);N.prisma.courseCompletion.upsert({where:{userId_courseId_courseVersion:{userId:t,courseId:e,courseVersion:n}},create:{userId:t,courseId:e,courseVersion:n,completedAt:new Date(v.completionDate||new Date().toISOString()),passed:!0},update:{passed:!0}}).catch(()=>null)}return v}({userId:n.user.id,courseId:s,levelId:o});return(0,A.jsonOk)({record:l},{status:200,requestId:t})})}e.s(["POST",()=>b],11171);var P=e.i(11171);let M=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/learning/records/refresh/route",pathname:"/api/learning/records/refresh",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/learning/records/refresh/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:U,workUnitAsyncStorage:k,serverHooks:D}=M;function $(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:k})}async function H(e,t,a){M.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/learning/records/refresh/route";w=w.replace(/\/index$/,"")||"/";let S=await M.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:I,params:y,nextConfig:A,parsedUrl:E,isDraftMode:C,prerenderManifest:O,routerServerContext:x,isOnDemandRevalidate:_,revalidateOnlyGenerated:T,resolvedPathname:N,clientReferenceManifest:q,serverActionsManifest:b}=S,P=(0,l.normalizeAppPath)(w),U=!!(O.dynamicRoutes[P]||O.routes[N]),k=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,E,!1):t.end("This page could not be found"),null);if(U&&!C){let e=!!O.routes[N],t=O.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await k();throw new v.NoFallbackError}}let D=null;!U||M.isDev||C||(D="/index"===(D=N)?"/":D);let $=!0===M.isDev||!U,H=U&&!$;b&&q&&(0,s.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:q,serverActionsManifest:b,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:b})});let z=e.method||"GET",j=(0,i.getTracer)(),L=j.getActiveScopeSpan(),F={params:y,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>M.onRequestError(e,t,a,x)},sharedContext:{buildId:I}},B=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),V=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let s=async e=>M.handle(V,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${z} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${z} ${w}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&_&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!U)return await (0,m.sendResponse)(B,K,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await M.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:_})},x),t}},u=await M.handleResponse({req:e,nextConfig:A,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!U)return null;if((null==u||null==(i=u.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",_?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&U||c.delete(g.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(B,K,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};L?await l(L):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${z} ${w}`,kind:i.SpanKind.SERVER,attributes:{"http.method":z,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await M.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:_})}),U)throw t;return await (0,m.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>$,"routeModule",()=>M,"serverHooks",()=>D,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>k],604791)}];

//# debugId=cd760ae8-1553-da0d-6d1e-ba8d57d80837
//# sourceMappingURL=_569ea114._.js.map