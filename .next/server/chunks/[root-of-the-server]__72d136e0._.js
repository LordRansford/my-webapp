;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="741d3519-6b2f-cf81-1e38-0040a9f4f2e8")}catch(e){}}();
module.exports=[254799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},648389,e=>{"use strict";var t=e.i(522734),a=e.i(814747);let r=a.default.join(process.cwd(),"data","audit"),n=a.default.join(r,"credits.jsonl");function i(e){try{t.default.existsSync(r)||t.default.mkdirSync(r,{recursive:!0});let a={...e,id:`${Date.now()}-${Math.random().toString(36).substring(7)}`,timestamp:new Date().toISOString()},i=JSON.stringify(a)+"\n";t.default.appendFileSync(n,i,"utf-8")}catch(e){console.error("Failed to log credit audit event:",e)}}function s(e){try{if(!t.default.existsSync(n))return[];let a=t.default.readFileSync(n,"utf-8").trim().split("\n").filter(Boolean).map(e=>JSON.parse(e));return e?.userId&&(a=a.filter(t=>t.userId===e.userId)),e?.type&&(a=a.filter(t=>t.type===e.type)),e?.startDate&&(a=a.filter(t=>new Date(t.timestamp)>=e.startDate)),e?.endDate&&(a=a.filter(t=>new Date(t.timestamp)<=e.endDate)),a.sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime()),e?.limit&&(a=a.slice(0,e.limit)),a}catch(e){return console.error("Failed to read credit audit log:",e),[]}}e.s(["logCreditEvent",()=>i,"readCreditAuditLog",()=>s])},333248,e=>{"use strict";var t=e.i(522734),a=e.i(814747),r=e.i(254799),n=e.i(648389);let i=a.default.join(process.cwd(),"data","credits.json");function s(){try{if(t.default.existsSync(i)){let e=t.default.readFileSync(i,"utf-8");return JSON.parse(e)}}catch(e){console.error("Failed to load credits store:",e)}return{users:{}}}function o(e){try{let r=a.default.dirname(i);t.default.existsSync(r)||t.default.mkdirSync(r,{recursive:!0}),t.default.writeFileSync(i,JSON.stringify(e,null,2))}catch(e){throw console.error("Failed to save credits store:",e),e}}async function c(t){try{let{getOrCreateCredits:a}=await e.A(118191);return(await a(t)).balance??0}catch(a){let e=s().users[t];return e?.balance??0}}function d(e){return s().users[e]||null}function l(e,t,a){return{userId:e,balance:t,monthlyAllocation:t,dailyCap:a,transactions:[{id:r.default.randomUUID(),userId:e,type:"monthly_allocation",amount:t,timestamp:new Date().toISOString()}],lastUpdated:new Date().toISOString()}}function u(e,t,a="purchase",i){let c=s(),d=c.users[e];d||(d=l(e,0,0),c.users[e]=d);let f={id:r.default.randomUUID(),userId:e,type:a,amount:t,timestamp:new Date().toISOString(),metadata:i};return d.balance+=t,d.transactions.push(f),d.lastUpdated=new Date().toISOString(),d.transactions.length>1e3&&(d.transactions=d.transactions.slice(-1e3)),o(c),(0,n.logCreditEvent)({type:"credit_granted",userId:e,credits:t,balance:d.balance,metadata:{type:a,...i}}),{success:!0,newBalance:d.balance,transactionId:f.id}}async function f(t,a,i,c,d){try{let{getOrCreateCredits:n,createCreditUsageEvent:s}=await e.A(118191),{prisma:o}=await e.A(119949),l=await n(t);if(l.balance<a)throw Error("Insufficient credits");let u=l.balance-a;return await o.credits.update({where:{userId:t},data:{balance:u}}),await s({userId:t,toolId:i,consumed:a,units:1,freeUnits:0,paidUnits:a,runId:c||null,actualCredits:a,estimatedCredits:d&&"object"==typeof d&&"estimated"in d?d.estimated:void 0,durationMs:d&&"object"==typeof d&&"usage"in d&&d.usage&&"object"==typeof d.usage&&"durationMs"in d.usage?d.usage.durationMs:void 0}),{success:!0,newBalance:u,transactionId:c||r.default.randomUUID()}}catch(e){console.warn("Prisma credit consumption failed, using file-based:",e)}let l=s(),u=l.users[t];if(!u)throw Error("User credits not initialized");if(u.balance<a)throw Error("Insufficient credits");let f={id:r.default.randomUUID(),userId:t,type:"consumption",amount:-a,toolId:i,runId:c,timestamp:new Date().toISOString(),metadata:d};return u.balance-=a,u.transactions.push(f),u.lastUpdated=new Date().toISOString(),o(l),(0,n.logCreditEvent)({type:"credit_charged",userId:t,toolId:i,runId:c,credits:a,balance:u.balance,metadata:d}),{success:!0,newBalance:u.balance,transactionId:f.id}}function m(e,t,a,n,i){let c=s(),d=c.users[e];if(!d)throw Error("User credits not initialized");let l={id:r.default.randomUUID(),userId:e,type:"refund",amount:t,timestamp:new Date().toISOString(),metadata:{...i,originalTransactionId:a,reason:n}};return d.balance+=t,d.transactions.push(l),d.lastUpdated=new Date().toISOString(),o(c),{success:!0,newBalance:d.balance,transactionId:l.id}}async function p(t){try{let{prisma:a}=await e.A(119949),r=new Date;return r.setHours(0,0,0,0),(await a.creditUsageEvent.findMany({where:{userId:t,occurredAt:{gte:r}},select:{consumed:!0}})).reduce((e,t)=>e+(t.consumed||0),0)}catch(e){console.warn("Prisma daily credits query failed, using file-based:",e)}let a=s().users[t];if(!a)return 0;let r=new Date;return r.setHours(0,0,0,0),r.toISOString(),a.transactions.filter(e=>new Date(e.timestamp)>=r&&"consumption"===e.type&&e.amount<0).reduce((e,t)=>e+Math.abs(t.amount),0)}async function y(t){try{let{prisma:a}=await e.A(119949),r=new Date,n=new Date(r.getFullYear(),r.getMonth(),1);return(await a.creditUsageEvent.findMany({where:{userId:t,occurredAt:{gte:n}},select:{consumed:!0}})).reduce((e,t)=>e+(t.consumed||0),0)}catch(e){console.warn("Prisma monthly credits query failed, using file-based:",e)}let a=s().users[t];if(!a)return 0;let r=new Date,n=new Date(r.getFullYear(),r.getMonth(),1);return a.transactions.filter(e=>new Date(e.timestamp)>=n&&"consumption"===e.type&&e.amount<0).reduce((e,t)=>e+Math.abs(t.amount),0)}function w(e,t,a){let r=s(),n=r.users[e];if(n){let r=t-n.monthlyAllocation;r>0&&u(e,r,"monthly_allocation",{reason:"Plan upgrade"}),n.monthlyAllocation=t,n.dailyCap=a,n.lastUpdated=new Date().toISOString()}else n=l(e,t,a),r.users[e]=n;o(r)}function g(e,t=100){let a=s().users[e];return a?a.transactions.slice(-t).reverse():[]}e.s(["addCredits",()=>u,"consumeCredits",()=>f,"getCreditBalance",()=>c,"getDailyCreditsConsumed",()=>p,"getMonthlyCreditsConsumed",()=>y,"getTransactionHistory",()=>g,"getUserCredits",()=>d,"refundCredits",()=>m,"updateUserPlanLimits",()=>w])},118191,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__dc62c65e._.js"].map(t=>e.l(t))).then(()=>t(685750)))},119949,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__f33e27fb._.js"].map(t=>e.l(t))).then(()=>t(124594)))}];

//# debugId=741d3519-6b2f-cf81-1e38-0040a9f4f2e8
//# sourceMappingURL=%5Broot-of-the-server%5D__72d136e0._.js.map