{
  "version": 3,
  "sources": [],
  "debugId": "2137b713-dae8-5b51-2a9d-5999efd09d56",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../src/lib/admin/supportStore.ts","../../../../src/app/admin/support/page.tsx"],"sourcesContent":["import { prisma } from \"@/lib/db/prisma\";\n\nexport type SupportStatus = \"open\" | \"in_progress\" | \"resolved\";\n\nexport type SupportTicketListItem = {\n  id: string;\n  userId: string | null;\n  name: string | null;\n  email: string | null;\n  category: string;\n  status: SupportStatus;\n  createdAt: string;\n  updatedAt: string;\n};\n\nfunction toIso(d: any) {\n  try {\n    return new Date(d).toISOString();\n  } catch {\n    return new Date(0).toISOString();\n  }\n}\n\nexport async function listSupportTicketsAdminSafe(opts: {\n  status?: SupportStatus | null;\n  category?: string | null;\n  take: number;\n  cursor?: string | null;\n  sort: \"newest\" | \"oldest\";\n}) {\n  const take = Math.max(1, Math.min(50, opts.take));\n  const where: any = {};\n  if (opts.status) where.status = opts.status;\n  if (opts.category) where.category = String(opts.category);\n\n  const orderBy = opts.sort === \"oldest\" ? { createdAt: \"asc\" as const } : { createdAt: \"desc\" as const };\n\n  const rows = await (prisma as any).supportTicket.findMany({\n    where,\n    take: take + 1,\n    ...(opts.cursor ? { cursor: { id: opts.cursor }, skip: 1 } : {}),\n    orderBy,\n    select: {\n      id: true,\n      userId: true,\n      name: true,\n      email: true,\n      category: true,\n      status: true,\n      createdAt: true,\n      updatedAt: true,\n    },\n  });\n\n  const next = rows.length > take ? rows[take] : null;\n  const slice = rows.slice(0, take);\n  return {\n    items: slice.map((r: any) => ({\n      id: String(r.id),\n      userId: r.userId ? String(r.userId) : null,\n      name: r.name ? String(r.name) : null,\n      email: r.email ? String(r.email) : null,\n      category: String(r.category || \"\"),\n      status: r.status as SupportStatus,\n      createdAt: toIso(r.createdAt),\n      updatedAt: toIso(r.updatedAt),\n    })) satisfies SupportTicketListItem[],\n    nextCursor: next ? String(next.id) : null,\n  };\n}\n\nexport async function getSupportTicketAdminSafe(id: string) {\n  const row = await (prisma as any).supportTicket.findUnique({\n    where: { id },\n    select: {\n      id: true,\n      userId: true,\n      name: true,\n      email: true,\n      category: true,\n      message: true,\n      status: true,\n      createdAt: true,\n      updatedAt: true,\n      attachments: { select: { id: true, fileName: true, mimeType: true, sizeBytes: true, storageKey: true, createdAt: true } },\n      notes: { select: { id: true, adminUserId: true, note: true, createdAt: true }, orderBy: { createdAt: \"desc\" as const } },\n    },\n  });\n  if (!row) return null;\n  return {\n    id: String(row.id),\n    userId: row.userId ? String(row.userId) : null,\n    name: row.name ? String(row.name) : null,\n    email: row.email ? String(row.email) : null,\n    category: String(row.category || \"\"),\n    message: String(row.message || \"\"),\n    status: row.status as SupportStatus,\n    createdAt: toIso(row.createdAt),\n    updatedAt: toIso(row.updatedAt),\n    attachments: (row.attachments || []).map((a: any) => ({\n      id: String(a.id),\n      fileName: String(a.fileName),\n      mimeType: String(a.mimeType),\n      sizeBytes: Number(a.sizeBytes),\n      storageKey: a.storageKey ? String(a.storageKey) : null,\n      createdAt: toIso(a.createdAt),\n    })),\n    notes: (row.notes || []).map((n: any) => ({ id: String(n.id), adminUserId: String(n.adminUserId), note: String(n.note), createdAt: toIso(n.createdAt) })),\n  };\n}\n\nexport async function setSupportTicketStatus(id: string, status: SupportStatus) {\n  await (prisma as any).supportTicket.update({ where: { id }, data: { status } });\n}\n\nexport async function addSupportTicketNote(id: string, adminUserId: string, note: string) {\n  await (prisma as any).supportTicketNote.create({ data: { ticketId: id, adminUserId, note } });\n}\n\n\n","export const metadata = {\n  title: \"Admin: Support\",\n  robots: { index: false, follow: false },\n};\n\nimport Link from \"next/link\";\nimport { listSupportTicketsAdminSafe } from \"@/lib/admin/supportStore\";\n\nfunction toHuman(iso: string) {\n  try {\n    return new Date(iso).toLocaleString();\n  } catch {\n    return iso;\n  }\n}\n\nexport default async function AdminSupportPage({\n  searchParams,\n}: {\n  searchParams: Promise<{ status?: string; category?: string; cursor?: string; sort?: string }>;\n}) {\n  const sp = await searchParams;\n  const status = (sp.status === \"open\" || sp.status === \"in_progress\" || sp.status === \"resolved\" ? sp.status : null) as any;\n  const category = (sp.category || \"\").trim() || null;\n  const cursor = sp.cursor || null;\n  const sort = sp.sort === \"oldest\" ? \"oldest\" : \"newest\";\n\n  const { items, nextCursor } = await listSupportTicketsAdminSafe({ status, category, cursor, take: 20, sort });\n\n  return (\n    <main className=\"mx-auto max-w-6xl px-4 py-10 md:px-6 lg:px-8 space-y-6\">\n      <h1 className=\"text-2xl font-semibold text-slate-900\">Support</h1>\n      <p className=\"text-slate-700\">Triage support tickets. No deletion. Status changes and notes are audited.</p>\n\n      <form className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm flex flex-wrap gap-3 items-end\" action=\"/admin/support\">\n        <label className=\"space-y-1\">\n          <span className=\"text-xs font-semibold text-slate-700\">Status</span>\n          <select name=\"status\" defaultValue={sp.status || \"\"} className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900\">\n            <option value=\"\">All</option>\n            <option value=\"open\">open</option>\n            <option value=\"in_progress\">in_progress</option>\n            <option value=\"resolved\">resolved</option>\n          </select>\n        </label>\n        <label className=\"min-w-[240px] flex-1 space-y-1\">\n          <span className=\"text-xs font-semibold text-slate-700\">Category</span>\n          <input name=\"category\" defaultValue={category || \"\"} placeholder=\"Optional\" className=\"w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900\" />\n        </label>\n        <label className=\"space-y-1\">\n          <span className=\"text-xs font-semibold text-slate-700\">Sort</span>\n          <select name=\"sort\" defaultValue={sort} className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900\">\n            <option value=\"newest\">newest</option>\n            <option value=\"oldest\">oldest</option>\n          </select>\n        </label>\n        <button type=\"submit\" className=\"rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800\">\n          Apply\n        </button>\n      </form>\n\n      <div className=\"overflow-x-auto rounded-2xl border border-slate-200 bg-white shadow-sm\">\n        <table className=\"min-w-full text-sm\">\n          <thead className=\"bg-slate-50 text-slate-700\">\n            <tr>\n              {[\"Ticket ID\", \"Category\", \"Status\", \"Email\", \"Created\", \"Updated\"].map((h) => (\n                <th key={h} className=\"px-4 py-3 text-left text-xs font-semibold\">\n                  {h}\n                </th>\n              ))}\n            </tr>\n          </thead>\n          <tbody>\n            {items.map((t) => (\n              <tr key={t.id} className=\"border-t border-slate-100\">\n                <td className=\"px-4 py-3 font-mono text-xs text-slate-700\">{t.id}</td>\n                <td className=\"px-4 py-3 text-slate-900\">\n                  <Link href={`/admin/support/${encodeURIComponent(t.id)}`} className=\"font-semibold text-emerald-700 hover:underline\">\n                    {t.category}\n                  </Link>\n                </td>\n                <td className=\"px-4 py-3 text-slate-900\">{t.status}</td>\n                <td className=\"px-4 py-3 text-slate-700\">{t.email || \"Unknown\"}</td>\n                <td className=\"px-4 py-3 text-slate-700\">{toHuman(t.createdAt)}</td>\n                <td className=\"px-4 py-3 text-slate-700\">{toHuman(t.updatedAt)}</td>\n              </tr>\n            ))}\n            {items.length === 0 ? (\n              <tr>\n                <td colSpan={6} className=\"px-4 py-8 text-center text-slate-600\">\n                  No tickets found.\n                </td>\n              </tr>\n            ) : null}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"flex items-center justify-between\">\n        <p className=\"text-xs text-slate-600\">Tickets are immutable records. Only status and internal notes can change.</p>\n        {nextCursor ? (\n          <Link\n            href={`/admin/support?status=${encodeURIComponent(sp.status || \"\")}&category=${encodeURIComponent(category || \"\")}&sort=${encodeURIComponent(sort)}&cursor=${encodeURIComponent(\n              nextCursor\n            )}`}\n            className=\"rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-400\"\n          >\n            Next page\n          </Link>\n        ) : (\n          <span className=\"text-xs text-slate-500\">End</span>\n        )}\n      </div>\n    </main>\n  );\n}\n\n\n"],"names":[],"mappings":"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"}}]
}