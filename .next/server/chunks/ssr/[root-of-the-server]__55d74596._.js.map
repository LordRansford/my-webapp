{
  "version": 3,
  "sources": [],
  "debugId": "bc3e474c-4346-448b-b6cd-ce6634cce54d",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../src/lib/admin/usersStore.ts","../../../../src/app/admin/users/page.tsx"],"sourcesContent":["import { prisma } from \"@/lib/db/prisma\";\nimport type { AdminRole } from \"@/lib/admin/rbac\";\n\nexport type AdminUserListItem = {\n  userId: string;\n  email: string;\n  role: AdminRole | \"NONE\";\n  accountStatus: \"active\" | \"suspended\" | \"pending\";\n  createdAt: string;\n  lastActiveAt: string;\n};\n\nfunction toIso(d: any) {\n  try {\n    return new Date(d).toISOString();\n  } catch {\n    return new Date(0).toISOString();\n  }\n}\n\nexport type UserSortKey = \"created\" | \"lastActive\" | \"role\";\nexport type SortDir = \"asc\" | \"desc\";\n\nexport async function listUsersAdminSafe(opts: {\n  search?: string;\n  take: number;\n  cursor?: string | null;\n  sortKey: UserSortKey;\n  sortDir: SortDir;\n}): Promise<{ items: AdminUserListItem[]; nextCursor: string | null }> {\n  const take = Math.max(1, Math.min(50, opts.take));\n  const search = (opts.search || \"\").trim().toLowerCase();\n\n  const where = search\n    ? {\n        OR: [{ email: { contains: search } }],\n      }\n    : {};\n\n  const orderBy =\n    opts.sortKey === \"created\"\n      ? { createdAt: opts.sortDir }\n      : opts.sortKey === \"lastActive\"\n        ? { lastActiveAt: opts.sortDir }\n        : [{ adminRole: opts.sortDir }, { createdAt: \"desc\" as const }];\n\n  const rows = await (prisma as any).userIdentity.findMany({\n    where,\n    take: take + 1,\n    ...(opts.cursor ? { cursor: { id: opts.cursor }, skip: 1 } : {}),\n    orderBy,\n    select: {\n      id: true,\n      email: true,\n      adminRole: true,\n      accountStatus: true,\n      createdAt: true,\n      lastActiveAt: true,\n    },\n  });\n\n  const next = rows.length > take ? rows[take] : null;\n  const slice = rows.slice(0, take);\n  const items: AdminUserListItem[] = slice.map((r: any) => ({\n    userId: String(r.id),\n    email: String(r.email || \"\"),\n    role: (r.adminRole as AdminRole) || \"NONE\",\n    accountStatus: (r.accountStatus as any) || \"active\",\n    createdAt: toIso(r.createdAt),\n    lastActiveAt: toIso(r.lastActiveAt),\n  }));\n\n  return { items, nextCursor: next ? String(next.id) : null };\n}\n\nexport async function getUserAdminSafe(userId: string) {\n  const row = await (prisma as any).userIdentity.findUnique({\n    where: { id: userId },\n    select: {\n      id: true,\n      email: true,\n      adminRole: true,\n      accountStatus: true,\n      createdAt: true,\n      lastActiveAt: true,\n    },\n  });\n  if (!row) return null;\n  return {\n    userId: String(row.id),\n    email: String(row.email || \"\"),\n    role: (row.adminRole as AdminRole) || \"NONE\",\n    accountStatus: (row.accountStatus as any) || \"active\",\n    createdAt: toIso(row.createdAt),\n    lastActiveAt: toIso(row.lastActiveAt),\n  } satisfies AdminUserListItem;\n}\n\nexport async function setUserAdminRole(userId: string, role: AdminRole | null) {\n  await (prisma as any).userIdentity.update({\n    where: { id: userId },\n    data: { adminRole: role },\n  });\n}\n\nexport async function setUserAccountStatus(userId: string, status: \"active\" | \"suspended\" | \"pending\") {\n  await (prisma as any).userIdentity.update({\n    where: { id: userId },\n    data: { accountStatus: status },\n  });\n}\n\n\n","export const metadata = {\n  title: \"Admin: Users\",\n  robots: { index: false, follow: false },\n};\n\nimport Link from \"next/link\";\nimport { listUsersAdminSafe } from \"@/lib/admin/usersStore\";\n\nfunction toHuman(iso: string) {\n  try {\n    return new Date(iso).toLocaleString();\n  } catch {\n    return iso;\n  }\n}\n\nexport default async function AdminUsersPage({\n  searchParams,\n}: {\n  searchParams: Promise<{ search?: string; cursor?: string; sort?: string; dir?: string }>;\n}) {\n  const sp = await searchParams;\n  const search = (sp.search || \"\").trim();\n  const cursor = sp.cursor || null;\n  const sort = (sp.sort as any) || \"created\";\n  const dir = (sp.dir as any) || \"desc\";\n\n  const { items, nextCursor } = await listUsersAdminSafe({\n    search,\n    cursor,\n    take: 20,\n    sortKey: sort === \"lastActive\" || sort === \"role\" ? sort : \"created\",\n    sortDir: dir === \"asc\" ? \"asc\" : \"desc\",\n  });\n\n  return (\n    <main className=\"mx-auto max-w-6xl px-4 py-10 md:px-6 lg:px-8 space-y-6\">\n      <h1 className=\"text-2xl font-semibold text-slate-900\">Users</h1>\n      <p className=\"text-slate-700\">Search, review, and open a user for safe role and status changes.</p>\n\n      <form className=\"rounded-2xl border border-slate-200 bg-white p-4 shadow-sm flex flex-wrap gap-3 items-end\" action=\"/admin/users\">\n        <label className=\"min-w-[240px] flex-1 space-y-1\">\n          <span className=\"text-xs font-semibold text-slate-700\">Search</span>\n          <input\n            name=\"search\"\n            defaultValue={search}\n            placeholder=\"Search by email\"\n            className=\"w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2\"\n          />\n        </label>\n        <label className=\"space-y-1\">\n          <span className=\"text-xs font-semibold text-slate-700\">Sort</span>\n          <select\n            name=\"sort\"\n            defaultValue={sort}\n            className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2\"\n          >\n            <option value=\"created\">Created</option>\n            <option value=\"lastActive\">Last active</option>\n            <option value=\"role\">Role</option>\n          </select>\n        </label>\n        <label className=\"space-y-1\">\n          <span className=\"text-xs font-semibold text-slate-700\">Direction</span>\n          <select\n            name=\"dir\"\n            defaultValue={dir}\n            className=\"rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-slate-400 focus-visible:ring-offset-2\"\n          >\n            <option value=\"desc\">Descending</option>\n            <option value=\"asc\">Ascending</option>\n          </select>\n        </label>\n        <button type=\"submit\" className=\"rounded-full bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800\">\n          Apply\n        </button>\n      </form>\n\n      <div className=\"overflow-x-auto rounded-2xl border border-slate-200 bg-white shadow-sm\">\n        <table className=\"min-w-full text-sm\">\n          <thead className=\"bg-slate-50 text-slate-700\">\n            <tr>\n              {[\"User ID\", \"Email\", \"Role\", \"Status\", \"Created\", \"Last active\"].map((h) => (\n                <th key={h} className=\"px-4 py-3 text-left text-xs font-semibold\">\n                  {h}\n                </th>\n              ))}\n            </tr>\n          </thead>\n          <tbody>\n            {items.map((u) => (\n              <tr key={u.userId} className=\"border-t border-slate-100\">\n                <td className=\"px-4 py-3 font-mono text-xs text-slate-700\">{u.userId}</td>\n                <td className=\"px-4 py-3 text-slate-900\">\n                  <Link href={`/admin/users/${encodeURIComponent(u.userId)}`} className=\"font-semibold text-emerald-700 hover:underline\">\n                    {u.email}\n                  </Link>\n                </td>\n                <td className=\"px-4 py-3 text-slate-900\">{u.role}</td>\n                <td className=\"px-4 py-3 text-slate-900\">{u.accountStatus}</td>\n                <td className=\"px-4 py-3 text-slate-700\">{toHuman(u.createdAt)}</td>\n                <td className=\"px-4 py-3 text-slate-700\">{toHuman(u.lastActiveAt)}</td>\n              </tr>\n            ))}\n            {items.length === 0 ? (\n              <tr>\n                <td colSpan={6} className=\"px-4 py-8 text-center text-slate-600\">\n                  No users found.\n                </td>\n              </tr>\n            ) : null}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"flex items-center justify-between\">\n        <p className=\"text-xs text-slate-600\">Only safe fields are shown. Admin actions require a reason and are audited.</p>\n        {nextCursor ? (\n          <Link\n            href={`/admin/users?search=${encodeURIComponent(search)}&sort=${encodeURIComponent(sort)}&dir=${encodeURIComponent(dir)}&cursor=${encodeURIComponent(\n              nextCursor\n            )}`}\n            className=\"rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-400\"\n          >\n            Next page\n          </Link>\n        ) : (\n          <span className=\"text-xs text-slate-500\">End</span>\n        )}\n      </div>\n    </main>\n  );\n}\n\n\n"],"names":[],"mappings":"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"}}]
}