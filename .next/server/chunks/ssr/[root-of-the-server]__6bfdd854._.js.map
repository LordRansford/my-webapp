{
  "version": 3,
  "sources": [],
  "debugId": "d339f2ff-314f-9f6b-c6e9-4f926f9933cd",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../src/app/admin/billing/page.tsx","../../../../src/config/pricing.ts"],"sourcesContent":["import Link from \"next/link\";\nimport { prisma } from \"@/lib/db/prisma\";\nimport { PRICING_CONFIG } from \"@/config/pricing\";\n\nexport const dynamic = \"force-dynamic\";\n\nexport const metadata = {\n  title: \"Admin: Billing overview\",\n  robots: { index: false, follow: false },\n};\n\nfunction formatPence(pence: number) {\n  const pounds = (pence / 100).toFixed(2);\n  return `Â£${pounds}`;\n}\n\nexport default async function AdminBillingOverviewPage() {\n  // Build-time safety: these tables may not exist in CI/preview builds.\n  // Render a stable zero-state instead of crashing the build.\n  let totalUsers = 0;\n  let usersWithBalanceCount = 0;\n  let outstandingPence = 0;\n  let spent7 = 0;\n  let spent30 = 0;\n  let topTools: { toolId: string; paid: number }[] = [];\n\n  try {\n    totalUsers = await (prisma as any).userIdentity.count();\n  } catch {\n    totalUsers = 0;\n  }\n\n  try {\n    const grouped = await (prisma as any).creditLedgerEvent.groupBy({\n      by: [\"userId\"],\n      _sum: { amountPence: true },\n    });\n    usersWithBalanceCount = (grouped || []).filter((g: any) => Number(g?._sum?.amountPence || 0) > 0).length;\n    outstandingPence = (grouped || []).reduce((acc: number, g: any) => acc + Number(g?._sum?.amountPence || 0), 0);\n  } catch {\n    usersWithBalanceCount = 0;\n    outstandingPence = 0;\n  }\n\n  const now = Date.now();\n  try {\n    const agg7 = await (prisma as any).creditLedgerEvent.aggregate({\n      where: { type: \"credit_spent\", createdAt: { gte: new Date(now - 7 * 24 * 60 * 60 * 1000) } },\n      _sum: { amountPence: true },\n    });\n    spent7 = Math.max(0, Number(agg7?._sum?.amountPence || 0) * -1);\n  } catch {\n    spent7 = 0;\n  }\n\n  try {\n    const agg30 = await (prisma as any).creditLedgerEvent.aggregate({\n      where: { type: \"credit_spent\", createdAt: { gte: new Date(now - 30 * 24 * 60 * 60 * 1000) } },\n      _sum: { amountPence: true },\n    });\n    spent30 = Math.max(0, Number(agg30?._sum?.amountPence || 0) * -1);\n  } catch {\n    spent30 = 0;\n  }\n\n  try {\n    const groupedTools = await (prisma as any).toolRun.groupBy({\n      by: [\"toolId\"],\n      where: { createdAt: { gte: new Date(now - 30 * 24 * 60 * 60 * 1000) } },\n      _sum: { paidTierChargedPence: true },\n      orderBy: { _sum: { paidTierChargedPence: \"desc\" } },\n      take: 5,\n    });\n    topTools = (groupedTools || []).map((t: any) => ({\n      toolId: String(t.toolId),\n      paid: Number(t?._sum?.paidTierChargedPence || 0),\n    }));\n  } catch {\n    topTools = [];\n  }\n\n  return (\n    <main className=\"mx-auto max-w-6xl px-4 py-10 md:px-6 lg:px-8 space-y-6\">\n      <header className=\"space-y-2\">\n        <p className=\"text-xs font-semibold text-slate-600\">Billing</p>\n        <h1 className=\"text-2xl font-semibold text-slate-900\">Billing overview</h1>\n        <p className=\"text-slate-700\">\n          Read-only visibility for credits, usage, and Stripe readiness. Payments remain disabled.\n        </p>\n        <div className=\"flex flex-wrap gap-2\">\n          <Link href=\"/admin/billing/credits\" className=\"rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-400\">\n            Credits ledger\n          </Link>\n          <Link href=\"/admin/billing/usage\" className=\"rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-400\">\n            Usage and costs\n          </Link>\n          <Link href=\"/admin/billing/stripe\" className=\"rounded-full border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-900 hover:border-slate-400\">\n            Stripe readiness\n          </Link>\n        </div>\n      </header>\n\n      <section className=\"grid gap-3 sm:grid-cols-2 lg:grid-cols-4\">\n        {[\n          { label: \"Total users\", value: String(totalUsers) },\n          { label: \"Users with balance > 0\", value: String(usersWithBalanceCount) },\n          { label: \"Total credit outstanding\", value: formatPence(outstandingPence) },\n          { label: \"Total credit spent (30d)\", value: formatPence(spent30) },\n        ].map((x) => (\n          <div key={x.label} className=\"rounded-2xl border border-slate-200 bg-white p-5 shadow-sm\">\n            <p className=\"text-xs font-semibold text-slate-700\">{x.label}</p>\n            <p className=\"mt-2 text-3xl font-semibold text-slate-900\">{x.value}</p>\n          </div>\n        ))}\n      </section>\n\n      <section className=\"grid gap-3 md:grid-cols-2\">\n        <div className=\"rounded-3xl border border-slate-200 bg-white p-6 shadow-sm space-y-3\">\n          <h2 className=\"text-lg font-semibold text-slate-900\">Spend windows</h2>\n          <div className=\"grid gap-3 sm:grid-cols-2\">\n            <div className=\"rounded-2xl border border-slate-200 bg-slate-50/70 p-4\">\n              <p className=\"text-xs font-semibold text-slate-700\">Spent (7d)</p>\n              <p className=\"mt-2 text-2xl font-semibold text-slate-900\">{formatPence(spent7)}</p>\n            </div>\n            <div className=\"rounded-2xl border border-slate-200 bg-slate-50/70 p-4\">\n              <p className=\"text-xs font-semibold text-slate-700\">Spent (30d)</p>\n              <p className=\"mt-2 text-2xl font-semibold text-slate-900\">{formatPence(spent30)}</p>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"rounded-3xl border border-slate-200 bg-white p-6 shadow-sm space-y-3\">\n          <h2 className=\"text-lg font-semibold text-slate-900\">Top tools by paid cost (30d)</h2>\n          {topTools.length ? (\n            <ul className=\"space-y-2 text-sm text-slate-800\">\n              {topTools.map((t) => (\n                <li key={t.toolId} className=\"flex items-center justify-between rounded-2xl border border-slate-200 bg-slate-50/70 px-4 py-3\">\n                  <span className=\"font-semibold\">{t.toolId}</span>\n                  <span className=\"text-slate-700\">{formatPence(Number(t.paid || 0))}</span>\n                </li>\n              ))}\n            </ul>\n          ) : (\n            <p className=\"text-sm text-slate-600\">No paid usage recorded yet.</p>\n          )}\n        </div>\n      </section>\n\n      <section className=\"rounded-3xl border border-slate-200 bg-white p-6 shadow-sm space-y-3\">\n        <h2 className=\"text-lg font-semibold text-slate-900\">Pricing configuration (read only)</h2>\n        <p className=\"text-sm text-slate-700\">These values are the server-side source of truth for later billing work.</p>\n        <pre className=\"overflow-auto rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs text-slate-800\">\n{JSON.stringify(PRICING_CONFIG, null, 2)}\n        </pre>\n      </section>\n    </main>\n  );\n}\n\n\n","export const PRICING_CONFIG = {\n  freeTierComputeUnitsPerRun: 120,\n  freeTierMaxInputBytes: 200_000,\n  paidTierComputeUnitPricePence: 1,\n  minPurchasePence: 1000,\n  maxInputBytesPaid: 2_000_000,\n  maxComputeUnitsPaid: 5_000,\n} as const;\n\n\n"],"names":[],"mappings":"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"}}]
}