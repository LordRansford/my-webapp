{
  "version": 3,
  "sources": [],
  "debugId": "ba85a92c-a832-89f3-ef20-f996779e573e",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../src/app/admin/template-downloads/page.tsx","../../../../src/lib/templates/store.ts"],"sourcesContent":["import { cookies } from \"next/headers\";\nimport { listDownloads } from \"@/lib/templates/store\";\n\nconst ADMIN_KEY = process.env.ADMIN_DASHBOARD_TOKEN;\n\nasync function isAuthorised() {\n  if (!ADMIN_KEY) return false;\n  const token = (await cookies()).get?.(\"admin_token\")?.value;\n  return token === ADMIN_KEY;\n}\n\nexport const dynamic = \"force-dynamic\";\n\nexport default async function TemplateDownloadsAdminPage() {\n  if (!ADMIN_KEY) {\n    return (\n      <main className=\"mx-auto max-w-4xl p-6\">\n        <h1 className=\"text-2xl font-semibold text-slate-900\">Admin not configured</h1>\n        <p className=\"text-sm text-slate-700\">Set ADMIN_DASHBOARD_TOKEN and admin_token cookie to view this page.</p>\n      </main>\n    );\n  }\n\n  const authorised = await isAuthorised();\n  if (!authorised) {\n    return (\n      <main className=\"mx-auto max-w-4xl p-6\">\n        <h1 className=\"text-2xl font-semibold text-slate-900\">Access denied</h1>\n        <p className=\"text-sm text-slate-700\">Provide the admin_token cookie that matches ADMIN_DASHBOARD_TOKEN.</p>\n      </main>\n    );\n  }\n\n  const downloads = listDownloads({}, 200);\n\n  return (\n    <main className=\"mx-auto max-w-5xl p-6 space-y-4\">\n      <header className=\"space-y-1\">\n        <p className=\"text-sm font-semibold uppercase tracking-wide text-slate-600\">Admin</p>\n        <h1 className=\"text-2xl font-semibold text-slate-900\">Template downloads</h1>\n        <p className=\"text-sm text-slate-700\">Latest download attempts for templates.</p>\n      </header>\n\n      <div className=\"overflow-x-auto rounded-2xl border border-slate-200 bg-white shadow-sm\">\n        <table className=\"min-w-full text-sm text-left text-slate-800\">\n          <thead className=\"bg-slate-50 text-sm font-semibold uppercase tracking-wide text-slate-600\">\n            <tr>\n              <th className=\"px-4 py-2\">When</th>\n              <th className=\"px-4 py-2\">Template</th>\n              <th className=\"px-4 py-2\">Use</th>\n              <th className=\"px-4 py-2\">Support</th>\n              <th className=\"px-4 py-2\">Signature</th>\n              <th className=\"px-4 py-2\">User</th>\n            </tr>\n          </thead>\n          <tbody>\n            {downloads.map((d) => (\n              <tr key={d.downloadId} className=\"border-t border-slate-100\">\n                <td className=\"px-4 py-2 text-slate-700\">{new Date(d.issuedAt).toLocaleString()}</td>\n                <td className=\"px-4 py-2\">{d.templateId}</td>\n                <td className=\"px-4 py-2\">{d.requestedUse}</td>\n                <td className=\"px-4 py-2\">{d.supportMethod}</td>\n                <td className=\"px-4 py-2\">{d.signaturePolicyApplied}</td>\n                <td className=\"px-4 py-2 text-sm text-slate-600\">{d.userId || d.anonymousUserId || \"anon\"}</td>\n              </tr>\n            ))}\n            {!downloads.length && (\n              <tr>\n                <td className=\"px-4 py-3 text-sm text-slate-600\" colSpan={6}>\n                  No downloads recorded yet.\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n    </main>\n  );\n}\n","import { readJsonFile, writeJsonFile } from \"@/lib/storage/jsonFile\";\n\nconst TEMPLATE_STORE_PATH = process.env.TEMPLATE_STORE_PATH || \"data/templates-store.json\";\n\nexport type PermissionScope = \"commercial_remove_signature\";\n\nexport type PermissionToken = {\n  tokenId: string;\n  userId?: string | null;\n  anonymousUserId?: string | null;\n  templateId?: string | null;\n  scope: PermissionScope;\n  issuedAt: string;\n  expiresAt?: string | null;\n  issuedBy: string;\n  notes?: string | null;\n};\n\nexport type DownloadRecord = {\n  downloadId: string;\n  templateId: string;\n  fileVariantId?: string | null;\n  userId?: string | null;\n  anonymousUserId?: string | null;\n  requestedUse: string;\n  supportMethod: string;\n  donationId?: string | null;\n  permissionTokenId?: string | null;\n  issuedAt: string;\n  signaturePolicyApplied: \"kept\" | \"removed\";\n};\n\nexport type DonationRecord = {\n  donationId: string;\n  userId?: string | null;\n  anonymousUserId?: string | null;\n  amount: number;\n  currency: string;\n  status: string;\n  donatedAt: string;\n};\n\ntype TemplateStore = {\n  permissionTokens: PermissionToken[];\n  downloads: DownloadRecord[];\n  donations: DonationRecord[];\n};\n\nconst empty: TemplateStore = { permissionTokens: [], downloads: [], donations: [] };\n\nfunction load() {\n  return readJsonFile<TemplateStore>(TEMPLATE_STORE_PATH, empty);\n}\n\nfunction save(store: TemplateStore) {\n  writeJsonFile(TEMPLATE_STORE_PATH, store);\n}\n\nexport function savePermissionToken(token: PermissionToken) {\n  const s = load();\n  const normalized = {\n    ...token,\n    userId: token.userId || null,\n    anonymousUserId: token.anonymousUserId || null,\n    templateId: token.templateId || null,\n    expiresAt: token.expiresAt || null,\n    notes: token.notes || null,\n  };\n  s.permissionTokens = s.permissionTokens.filter((t) => t.tokenId !== token.tokenId);\n  s.permissionTokens.push(normalized);\n  save(s);\n}\n\nexport function getActivePermissionTokens(params: { userId?: string | null; anonymousUserId?: string | null; templateId?: string | null }) {\n  const { userId, anonymousUserId, templateId } = params;\n  const nowIso = new Date().toISOString();\n  const s = load();\n  return s.permissionTokens\n    .filter((t) => (t.userId && t.userId === (userId || null)) || (t.anonymousUserId && t.anonymousUserId === (anonymousUserId || null)))\n    .filter((t) => !t.templateId || t.templateId === (templateId || null))\n    .filter((t) => !t.expiresAt || t.expiresAt > nowIso);\n}\n\nexport function listPermissionTokens(limit = 200) {\n  const s = load();\n  return [...s.permissionTokens].sort((a, b) => (b.issuedAt || \"\").localeCompare(a.issuedAt || \"\")).slice(0, limit);\n}\n\nexport function deletePermissionToken(tokenId: string) {\n  const s = load();\n  s.permissionTokens = s.permissionTokens.filter((t) => t.tokenId !== tokenId);\n  save(s);\n}\n\nexport function saveDownload(record: DownloadRecord) {\n  const s = load();\n  s.downloads.push({\n    ...record,\n    fileVariantId: record.fileVariantId || null,\n    userId: record.userId || null,\n    anonymousUserId: record.anonymousUserId || null,\n    donationId: record.donationId || null,\n    permissionTokenId: record.permissionTokenId || null,\n  });\n  save(s);\n}\n\nexport function listDownloads(filters: { templateId?: string; requestedUse?: string } = {}, limit = 200) {\n  const s = load();\n  return [...s.downloads]\n    .filter((d) => (filters.templateId ? d.templateId === filters.templateId : true))\n    .filter((d) => (filters.requestedUse ? d.requestedUse === filters.requestedUse : true))\n    .sort((a, b) => (b.issuedAt || \"\").localeCompare(a.issuedAt || \"\"))\n    .slice(0, limit);\n}\n\nexport function saveDonation(record: DonationRecord) {\n  const s = load();\n  const normalized = { ...record, userId: record.userId || null, anonymousUserId: record.anonymousUserId || null };\n  s.donations = s.donations.filter((d) => d.donationId !== record.donationId);\n  s.donations.push(normalized);\n  save(s);\n}\n\nexport function getLatestCompletedDonation(params: { userId?: string | null; anonymousUserId?: string | null }) {\n  const s = load();\n  return (\n    [...s.donations]\n      .filter((d) => d.status === \"completed\")\n      .filter((d) => (d.userId && d.userId === (params.userId || null)) || (d.anonymousUserId && d.anonymousUserId === (params.anonymousUserId || null)))\n      .sort((a, b) => (b.donatedAt || \"\").localeCompare(a.donatedAt || \"\"))[0] || null\n  );\n}\n"],"names":[],"mappings":"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"}}]
}