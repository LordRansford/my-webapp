{
  "version": 3,
  "sources": [],
  "debugId": "1061c40d-6c7c-4d0f-5d72-d2a2bb968e7c",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../../src/lib/db/prisma.ts","../../../../src/app/verify/certificate/id/%5BcertificateId%5D/page.tsx","../../../../src/lib/storage/certificates.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n// Default DB for local dev when env is missing.\n// This keeps local dev lightweight and avoids \"silent\" runtime failures.\nif (!process.env.DATABASE_URL) {\n  process.env.DATABASE_URL = \"file:./data/dev.db\";\n}\n\ndeclare global {\n  var __prisma: PrismaClient | undefined;\n}\n\nexport const prisma: PrismaClient =\n  global.__prisma ||\n  new PrismaClient({\n    log: [\"error\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") {\n  global.__prisma = prisma;\n}\n\n\n","import crypto from \"node:crypto\";\nimport { prisma } from \"@/lib/db/prisma\";\nimport { getCertificatePdfBytes } from \"@/lib/storage/certificates\";\n\nexport const dynamic = \"force-dynamic\";\n\nfunction sha256Hex(bytes: Uint8Array) {\n  return crypto.createHash(\"sha256\").update(Buffer.from(bytes)).digest(\"hex\");\n}\n\nfunction getMetaString(meta: any, key: string) {\n  const v = meta && typeof meta === \"object\" ? meta[key] : null;\n  return typeof v === \"string\" ? v : \"\";\n}\n\nfunction getMetaNumber(meta: any, key: string): number | null {\n  const v = meta && typeof meta === \"object\" ? meta[key] : null;\n  const n = typeof v === \"number\" ? v : Number(v);\n  return Number.isFinite(n) ? n : null;\n}\n\nexport default async function VerifyCertificateByIdPage(props: { params: Promise<{ certificateId: string }> }) {\n  const { certificateId } = await props.params;\n  const id = String(certificateId || \"\").trim();\n\n  const issuanceModel = (prisma as any).certificateIssuance as {\n    findUnique: (args: any) => Promise<any>;\n  };\n\n  const issuance = await issuanceModel.findUnique({ where: { certificateId: id } });\n  if (!issuance) {\n    return (\n      <main className=\"mx-auto max-w-2xl p-6\">\n        <h1 className=\"text-2xl font-semibold\">Certificate verification</h1>\n        <p className=\"mt-4 rounded-lg border border-slate-200 bg-white p-4 text-sm text-slate-700\">Certificate not found or invalid</p>\n      </main>\n    );\n  }\n\n  let integrityOk = false;\n  try {\n    const bytes = await getCertificatePdfBytes({ key: issuance.pdfStorageKey });\n    const computed = sha256Hex(bytes);\n    integrityOk = computed === issuance.pdfSha256;\n  } catch {\n    integrityOk = false;\n  }\n\n  if (!integrityOk) {\n    return (\n      <main className=\"mx-auto max-w-2xl p-6\">\n        <h1 className=\"text-2xl font-semibold\">Certificate verification</h1>\n        <p className=\"mt-4 rounded-lg border border-rose-200 bg-rose-50 p-4 text-sm text-rose-800\">Certificate integrity check failed</p>\n      </main>\n    );\n  }\n\n  const meta = issuance.metadata || {};\n  const holderName = getMetaString(meta, \"learnerName\") || \"Learner\";\n  const courseTitle = getMetaString(meta, \"courseTitle\") || issuance.courseId;\n  const cpdHours = getMetaNumber(meta, \"cpdHours\");\n  const issuedAt = issuance.issuedAt ? new Date(issuance.issuedAt).toISOString().slice(0, 10) : \"\";\n  const revoked = Boolean(issuance.revokedAt);\n  const verifiedAt = new Date().toISOString().slice(0, 19).replace(\"T\", \" \") + \" UTC\";\n\n  return (\n    <main className=\"mx-auto max-w-2xl p-6\">\n      <div className=\"rounded-2xl border border-slate-200 bg-white p-6\">\n        <div className=\"flex flex-col gap-1\">\n          <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-600\">Issued by RansfordsNotes</div>\n          <h1 className=\"text-2xl font-semibold text-slate-900\">Certificate verification</h1>\n          <div className=\"mt-2 text-sm text-slate-600\">Verified at {verifiedAt}</div>\n        </div>\n\n        <div className=\"mt-6 grid gap-4\">\n          <div className=\"rounded-lg border border-slate-200 p-4\">\n            <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-600\">Status</div>\n            <div className={`mt-1 text-base font-semibold ${revoked ? \"text-rose-700\" : \"text-emerald-700\"}`}>\n              {revoked ? \"Revoked\" : \"Valid\"}\n            </div>\n            {revoked ? <div className=\"mt-2 text-sm text-slate-700\">This certificate has been revoked and is no longer valid.</div> : null}\n          </div>\n\n          <div className=\"rounded-lg border border-slate-200 p-4\">\n            <div className=\"grid gap-3 sm:grid-cols-2\">\n              <div>\n                <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-600\">Certificate holder</div>\n                <div className=\"mt-1 text-sm font-semibold text-slate-900\">{holderName}</div>\n              </div>\n              <div>\n                <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-600\">Course</div>\n                <div className=\"mt-1 text-sm font-semibold text-slate-900\">{courseTitle}</div>\n                <div className=\"text-xs text-slate-600\">{issuance.courseId}</div>\n              </div>\n              <div>\n                <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-600\">CPD hours</div>\n                <div className=\"mt-1 text-sm font-semibold text-slate-900\">{cpdHours && cpdHours > 0 ? cpdHours : \"Not specified\"}</div>\n              </div>\n              <div>\n                <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-600\">Issue date</div>\n                <div className=\"mt-1 text-sm font-semibold text-slate-900\">{issuedAt || \"Unknown\"}</div>\n              </div>\n            </div>\n\n            <div className=\"mt-4 border-t border-slate-200 pt-4\">\n              <div className=\"text-xs font-semibold uppercase tracking-wide text-slate-600\">Certificate ID</div>\n              <div className=\"mt-1 font-mono text-sm text-slate-900\">{issuance.certificateId}</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </main>\n  );\n}\n\n\n","import fs from \"node:fs\";\nimport path from \"node:path\";\n\ntype PutParams = { key: string; bytes: Uint8Array; contentType: string };\ntype GetUrlParams = { key: string; expiresInSeconds: number };\n\nconst BLOB_BASE = \"https://blob.vercel-storage.com\";\n\nfunction getLocalDir() {\n  return path.join(process.cwd(), \"prisma\", \"data\", \"certificates\");\n}\n\nfunction requireKey(key: string) {\n  const k = String(key || \"\").trim();\n  if (!k || k.includes(\"..\")) throw new Error(\"Invalid storage key\");\n  return k.replace(/^\\//, \"\");\n}\n\nexport async function putCertificatePdf(params: PutParams): Promise<{ key: string }> {\n  const key = requireKey(params.key);\n  const token = process.env.BLOB_READ_WRITE_TOKEN || \"\";\n\n  if (token) {\n    // Private upload to Vercel Blob via simple HTTP API.\n    const url = `${BLOB_BASE}/${encodeURIComponent(key)}`;\n    const res = await fetch(url, {\n      method: \"PUT\",\n      headers: {\n        authorization: `Bearer ${token}`,\n        \"content-type\": params.contentType,\n        // default access is private\n      },\n      body: params.bytes as any,\n    });\n    if (!res.ok) throw new Error(\"CERT_STORAGE_PUT_FAILED\");\n    return { key };\n  }\n\n  // Local dev fallback: store on disk.\n  const dir = getLocalDir();\n  fs.mkdirSync(dir, { recursive: true });\n  fs.writeFileSync(path.join(dir, key), Buffer.from(params.bytes));\n  return { key };\n}\n\nexport async function getCertificatePdfUrl(params: GetUrlParams): Promise<{ url: string }> {\n  const key = requireKey(params.key);\n  const token = process.env.BLOB_READ_WRITE_TOKEN || \"\";\n\n  if (token) {\n    // We do not rely on signed URLs here; instead, download is mediated by our API endpoint.\n    // Return a stable internal URL (expires is handled by our auth gate, not the blob).\n    return { url: `/api/certificates/download?key=${encodeURIComponent(key)}` };\n  }\n\n  return { url: `/api/certificates/download?key=${encodeURIComponent(key)}` };\n}\n\nexport async function getCertificatePdfBytes(params: { key: string }): Promise<Uint8Array> {\n  const key = requireKey(params.key);\n  const token = process.env.BLOB_READ_WRITE_TOKEN || \"\";\n\n  if (token) {\n    const url = `${BLOB_BASE}/${encodeURIComponent(key)}`;\n    const res = await fetch(url, { headers: { authorization: `Bearer ${token}` } });\n    if (!res.ok) throw new Error(\"CERT_STORAGE_GET_FAILED\");\n    const ab = await res.arrayBuffer();\n    return new Uint8Array(ab);\n  }\n\n  const p = path.join(getLocalDir(), key);\n  if (!fs.existsSync(p)) throw new Error(\"CERT_STORAGE_NOT_FOUND\");\n  return new Uint8Array(fs.readFileSync(p));\n}\n\n\n"],"names":[],"mappings":"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"}}]
}