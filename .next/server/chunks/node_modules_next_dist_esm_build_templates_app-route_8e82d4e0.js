;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="f3f10682-11ba-addd-148b-0f43aeb45515")}catch(e){}}();
module.exports=[75138,e=>{"use strict";var t=e.i(747909),r=e.i(174017),s=e.i(996250),i=e.i(759756),n=e.i(561916),a=e.i(114444),o=e.i(837092),l=e.i(869741),d=e.i(316795),c=e.i(487718),u=e.i(995169),p=e.i(47587),h=e.i(666012),m=e.i(570101),f=e.i(626937),g=e.i(10372),y=e.i(193695);e.i(52474);var w=e.i(600220),R=e.i(89171),v=e.i(757660),b=e.i(568212),I=e.i(124594),A=e.i(895968),x=e.i(936426),C=e.i(657194),S=e.i(199355),E=e.i(356846),T=e.i(685750),N=e.i(51662),q=e.i(338303),O=e.i(986225);function M(e){try{return JSON.stringify(e??null)}catch{return"{}"}}function P(e){if(null==e)return null;if("number"==typeof e||"string"==typeof e||Array.isArray(e))return e;if("object"==typeof e){let t=e.choice;if("number"==typeof t||"string"==typeof t||Array.isArray(t))return t}return null}async function k(e){return(0,A.withRequestLogging)(e,{route:"POST /api/assessments/submit"},async()=>{let t=(0,x.requireSameOrigin)(e);if(t)return t;let r=(0,C.rateLimit)(e,{keyPrefix:"assessments-submit",limit:20,windowMs:6e4});if(r)return r;let s=await (0,v.getServerSession)(b.authOptions).catch(()=>null),i=s?.user?.id||"";if(!i)return R.NextResponse.json({message:"Unauthorized"},{status:401});let n=await e.json().catch(()=>null),a="string"==typeof n?.sessionId?n.sessionId.trim():"",o=n?.answers&&"object"==typeof n.answers?n.answers:null;if(!a||!o)return R.NextResponse.json({message:"Invalid request"},{status:400});let l=await I.prisma.assessmentSession.findUnique({where:{id:a},select:{id:!0,userId:!0,assessmentId:!0,questionIds:!0,startedAt:!0,expiresAt:!0}});if(!l||l.userId!==i)return R.NextResponse.json({message:"Session not found"},{status:404});let d=new Date;if(l.expiresAt.getTime()<=d.getTime())return await I.prisma.assessmentSession.delete({where:{id:l.id}}).catch(()=>null),R.NextResponse.json({message:"Session expired"},{status:409});let c=await I.prisma.assessment.findUnique({where:{id:l.assessmentId},select:{id:!0,courseId:!0,levelId:!0,passThreshold:!0,timeLimit:!0}});if(!c)return await I.prisma.assessmentSession.delete({where:{id:l.id}}).catch(()=>null),R.NextResponse.json({message:"Assessment not found"},{status:404});let u=(0,N.getAssessmentAttemptCredits)({courseId:c.courseId,levelId:c.levelId}),p=await (0,S.enforceCreditGate)(u,1);if(!p.ok)return(0,S.creditGateErrorResponse)(p);let h=JSON.parse(l.questionIds||"[]"),m=new Map((await I.prisma.question.findMany({where:{id:{in:h}},select:{id:!0,question:!0,options:!0,correctAnswer:!0,explanation:!0,optionRationales:!0,tags:!0,type:!0}})).map(e=>[e.id,e])),f=h.map(e=>m.get(e)).filter(Boolean),g=function(e){let t=0,r=[];for(let s of e.questions){let i=e.answers[s.id],n=P(i),a=JSON.parse(s.correctAnswer),o=!1;"number"==typeof a&&"number"==typeof n&&n===a&&(o=!0),"string"==typeof a&&"string"==typeof n&&n===a&&(o=!0),Array.isArray(a)&&Array.isArray(n)&&a.slice().sort().join("|")===n.slice().sort().join("|")&&(o=!0),o&&(t+=1),r.push({questionId:s.id,correct:o,answer:i})}let s=e.questions.length||1,i=Math.round(t/s*100);return{correct:t,total:s,percent:i,perQuestion:r}}({questions:f,answers:o}),y=g.percent>=c.passThreshold,w=Math.max(0,Math.round((d.getTime()-l.startedAt.getTime())/1e3)),A=(0,O.getActiveCourseVersion)(c.courseId);if(!(await (0,E.deductCreditsFromLots)({userId:i,credits:u})).ok)return R.NextResponse.json({message:"Insufficient credits"},{status:402});let k=await I.prisma.assessmentAttempt.create({data:{userId:i,assessmentId:c.id,courseVersion:A,questionIds:l.questionIds||"[]",score:g.percent,passed:y,answers:M(o),timeSpent:w},select:{id:!0,score:!0,passed:!0,completedAt:!0}});Array.isArray(g.perQuestion)&&g.perQuestion.length&&await I.prisma.assessmentAttemptItem.createMany({data:g.perQuestion.map(e=>({attemptId:k.id,questionId:e.questionId,correct:!!e.correct,answer:void 0===e.answer?null:M(e.answer)})),skipDuplicates:!0}).catch(()=>null),await I.prisma.assessmentSession.delete({where:{id:l.id}}).catch(()=>null),await (0,T.createCreditUsageEvent)({userId:i,toolId:"assessment-attempt",consumed:u,units:u,freeUnits:0,paidUnits:u,runId:k.id,baseFree:!1,estimatedCredits:u,actualCredits:u,meteringUnit:"fixed",durationMs:1e3*w,inputBytes:0,outputBytes:0,freeTierAppliedMs:0,paidMs:0}).catch(()=>null);let U=e.headers.get("x-forwarded-for")||"",_=U.split(",")[0]?.trim()||e.headers.get("x-real-ip")||null,j=e.headers.get("user-agent")||null;await (0,q.recordEvidence)({userId:i,courseId:c.courseId,evidenceType:"quiz",payload:{kind:"assessment",levelId:c.levelId,assessmentId:c.id,attemptId:k.id,score:k.score,passed:k.passed,timeSpentSeconds:w},requestMeta:{ip:_,userAgent:j}}).catch(()=>null);let D=!1;if(y){let e=`${c.courseId}:${c.levelId}`;await I.prisma.courseCompletion.upsert({where:{userId_courseId_courseVersion:{userId:i,courseId:e,courseVersion:A}},create:{userId:i,courseId:e,courseVersion:A,completedAt:d,score:g.percent,passed:!0},update:{completedAt:d,score:g.percent,passed:!0}}).catch(()=>null),D=!0}let H=new Map,$=f.map(e=>{let t=o[e.id],r=P(t),s=JSON.parse(e.correctAnswer),i="number"==typeof s&&"number"==typeof r&&r===s||"string"==typeof s&&"string"==typeof r&&r===s||Array.isArray(s)&&Array.isArray(r)&&s.slice().sort().join("|")===r.slice().sort().join("|"),n=function(e){for(let t of String(e||"").split(",").map(e=>e.trim()).filter(Boolean))if(t.startsWith("domain:"))return t.slice(7);return""}(e.tags)||"other",a=H.get(n)||{correct:0,total:0};return a.total+=1,i&&(a.correct+=1),H.set(n,a),{id:e.id,question:e.question,options:e.options?JSON.parse(e.options):null,userAnswer:t,correctAnswer:s,correct:i,explanation:e.explanation,optionRationales:e.optionRationales?JSON.parse(e.optionRationales):null,tags:e.tags,type:e.type}}),L=Array.from(H.entries()).map(([e,t])=>{let r=t.total?Math.round(t.correct/t.total*100):0;return{domain:e,correct:t.correct,total:t.total,percent:r}}).sort((e,t)=>e.percent-t.percent),B=L.filter(e=>e.total>=3&&e.percent<c.passThreshold).map(e=>e.domain),F=function(e){let t=String(e.levelId||""),r=[];r.push({title:"CPD prep pack",href:"/cybersecurity/cpd-prep",why:"Structured revision workflows that do not mirror the live bank"}),r.push({title:"Pricing",href:"/pricing",why:"CPD, certificates, donations, and compute credits"}),r.push({title:"Return to course notes",href:"foundations"===t?"/cybersecurity/beginner":"applied"===t?"/cybersecurity/intermediate":"/cybersecurity/advanced",why:"Target revision using the course path"});let s={risk:{title:"Risk register builder",href:"/tools/cyber/risk-register-builder",why:"Train prioritisation and mitigation clarity"},detection:{title:"Incident post mortem builder",href:"/tools/cyber/incident-post-mortem-builder",why:"Practice timeline, containment, and follow up actions"},logging:{title:"Incident post mortem builder",href:"/tools/cyber/incident-post-mortem-builder",why:"Translate logs into an investigation narrative"},web:{title:"Threat modelling lite",href:"/tools/cyber/threat-modelling-lite",why:"Rehearse common web abuse cases and mitigations"},api:{title:"Threat modelling lite",href:"/tools/cyber/threat-modelling-lite",why:"Rehearse unsafe endpoint patterns and controls"},auth:{title:"Threat modelling lite",href:"/tools/cyber/threat-modelling-lite",why:"Rehearse auth vs authorisation failure patterns"},identity:{title:"Threat modelling lite",href:"/tools/cyber/threat-modelling-lite",why:"Rehearse sessions, cookies, and access boundaries"},governance:{title:"Decision log generator",href:"/tools/software-architecture/decision-log-generator",why:"Write defensible decisions and evidence"},sdlc:{title:"Decision log generator",href:"/tools/software-architecture/decision-log-generator",why:"Capture verification steps and trade offs"},basics:{title:"Entropy and hashing",href:"/tools/cyber/entropy-hashing",why:"Reinforce core primitives with safe practice"},crypto:{title:"RSA lab",href:"/tools/cyber/rsa-lab",why:"Reinforce asymmetric crypto concepts safely"},network:{title:"Certificate viewer",href:"/tools/cyber/certificate-viewer",why:"Build confidence with browser trust cues"}};for(let t of e.weakDomains.slice(0,3)){let e=s[String(t||"").trim()];e&&r.push(e)}let i=new Set;return r.filter(e=>!(!e.href||i.has(e.href))&&(i.add(e.href),!0))}({levelId:c.levelId,weakDomains:B});return R.NextResponse.json({ok:!0,attempt:{id:k.id,score:k.score,passed:k.passed,completedAt:k.completedAt.toISOString(),timeSpentSeconds:w},assessment:{courseId:c.courseId,levelId:c.levelId,passThreshold:c.passThreshold,timeLimitMinutes:c.timeLimit??75},completionWritten:D,certificateCourseId:y?`${c.courseId}:${c.levelId}`:null,domainReport:L,nextSteps:F,review:$},{status:200})})}e.s(["POST",()=>k],58890);var U=e.i(58890);let _=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/assessments/submit/route",pathname:"/api/assessments/submit",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/assessments/submit/route.ts",nextConfigOutput:"",userland:U}),{workAsyncStorage:j,workUnitAsyncStorage:D,serverHooks:H}=_;function $(){return(0,s.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:D})}async function L(e,t,s){_.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/assessments/submit/route";R=R.replace(/\/index$/,"")||"/";let v=await _.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:b,params:I,nextConfig:A,parsedUrl:x,isDraftMode:C,prerenderManifest:S,routerServerContext:E,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,resolvedPathname:q,clientReferenceManifest:O,serverActionsManifest:M}=v,P=(0,l.normalizeAppPath)(R),k=!!(S.dynamicRoutes[P]||S.routes[q]),U=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,x,!1):t.end("This page could not be found"),null);if(k&&!C){let e=!!S.routes[q],t=S.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await U();throw new y.NoFallbackError}}let j=null;!k||_.isDev||C||(j="/index"===(j=q)?"/":j);let D=!0===_.isDev||!k,H=k&&!D;M&&O&&(0,a.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:O,serverActionsManifest:M,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:M})});let $=e.method||"GET",L=(0,n.getTracer)(),B=L.getActiveScopeSpan(),F={params:I,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>_.onRequestError(e,t,s,E)},sharedContext:{buildId:b}},K=new d.NodeNextRequest(e),J=new d.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(t));try{let a=async e=>_.handle(G,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${$} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${R}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&T&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await a(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let l=F.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let d=F.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(K,J,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,s=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},E),t}},c=await _.handleResponse({req:e,nextConfig:A,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:N,responseGenerator:d,waitUntil:s.waitUntil,isMinimalMode:o});if(!k)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&k||u.delete(g.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(K,J,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};B?await l(B):await L.withPropagatedContext(e.headers,()=>L.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${R}`,kind:n.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),k)throw t;return await (0,h.sendResponse)(K,J,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>$,"routeModule",()=>_,"serverHooks",()=>H,"workAsyncStorage",()=>j,"workUnitAsyncStorage",()=>D],75138)}];

//# debugId=f3f10682-11ba-addd-148b-0f43aeb45515
//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_8e82d4e0.js.map