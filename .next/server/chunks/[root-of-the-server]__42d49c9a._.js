;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="9fb0e374-1808-387c-f1f2-9396a3b726b0")}catch(e){}}();
module.exports=[193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},29173,(e,t,r)=>{t.exports=e.x("@prisma/client",()=>require("@prisma/client"))},254799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},124594,e=>{"use strict";var t=e.i(29173);process.env.DATABASE_URL||(process.env.DATABASE_URL="file:./data/dev.db");let r=global.__prisma||new t.PrismaClient({log:["error"]});e.s(["prisma",0,r])},967291,e=>{"use strict";let t=new Set(["authorization","cookie","set-cookie","stripe-signature","secret","token","password","apiKey","apikey","client_secret"]);function r(e,r,a){let s={level:e,event:String(r||"").slice(0,80),ts:new Date().toISOString(),...function e(r,a=0){if(a>4)return"[TRUNCATED]";if(null==r)return r;if(Array.isArray(r))return r.slice(0,20).map(t=>e(t,a+1));if("object"!=typeof r)return r;let s={};for(let[n,i]of Object.entries(r)){let r=String(n),o=r.toLowerCase();if(t.has(o)||o.includes("secret")||o.includes("token")||o.includes("password")){s[r]=null==i?i:("string"==typeof i&&i.length,"[REDACTED]");continue}s[r]=e(i,a+1)}return s}(a&&"object"==typeof a?a:{})};"error"===e?console.error(s):"warn"===e?console.warn(s):console.log(s)}function a(e,t){r("info",e,t)}function s(e,t){r("warn",e,t)}function n(e,t){r("error",e,t)}e.s(["logError",()=>n,"logInfo",()=>a,"logWarn",()=>s])},657194,e=>{"use strict";var t=e.i(89171),r=e.i(254799);let a=new Map;function s(e,s){var n,i;let o,d,u,l=Date.now(),c=`${s.keyPrefix}:${(n=s.keySuffix,o=e.headers.get("x-forwarded-for")||"",d=o.split(",")[0]?.trim()||e.headers.get("x-real-ip")||"unknown",u=e.headers.get("user-agent")||"unknown",i=`${d}|${u}|${n||""}`,r.default.createHash("sha256").update(i).digest("hex").slice(0,24))}`,p=a.get(c);if(!p||p.resetAt<=l)return a.set(c,{count:1,resetAt:l+s.windowMs}),null;if(p.count+=1,p.count>s.limit){let e=Math.max(1,Math.ceil((p.resetAt-l)/1e3));return t.NextResponse.json({error:s.message||"Too many requests. Please try again shortly."},{status:429,headers:{"retry-after":String(e)}})}return null}e.s(["rateLimit",()=>s])},666680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},685750,e=>{"use strict";let t,r;var a=e.i(124594);let s=Number.isFinite(r=(t=process.env.CREDITS_EXPIRY_DAYS)?Number(t):NaN)&&r>0?Math.floor(r):730;async function n(e){let t=await a.prisma.credits.findUnique({where:{userId:e}});return t||await a.prisma.credits.create({data:{userId:e,balance:0,expiresAt:null}})}async function i(){return{totalUsersWithCredits:await a.prisma.credits.count(),totalCredits:(await a.prisma.credits.aggregate({_sum:{balance:!0}}))._sum.balance??0}}async function o(e){let t=await a.prisma.credits.findUnique({where:{userId:e}});if(!t)return null;if(!t.expiresAt)return t;let r=new Date;return t.expiresAt.getTime()>r.getTime()?t:await a.prisma.credits.update({where:{userId:e},data:{balance:0}})}async function d(e){return a.prisma.creditUsageEvent.create({data:{userId:e.userId,toolId:e.toolId,consumed:e.consumed,units:e.units,freeUnits:e.freeUnits,paidUnits:e.paidUnits,runId:e.runId||null,baseFree:!!e.baseFree,estimatedCredits:Math.max(0,Math.round(Number(e.estimatedCredits)||0)),actualCredits:Math.max(0,Math.round(Number(e.actualCredits)||0)),meteringUnit:e.meteringUnit||"ms",durationMs:Math.max(0,Math.round(Number(e.durationMs)||0)),inputBytes:Math.max(0,Math.round(Number(e.inputBytes)||0)),outputBytes:Math.max(0,Math.round(Number(e.outputBytes)||0)),freeTierAppliedMs:Math.max(0,Math.round(Number(e.freeTierAppliedMs)||0)),paidMs:Math.max(0,Math.round(Number(e.paidMs)||0))}})}async function u(e,t=50){return a.prisma.creditUsageEvent.findMany({where:{userId:e},orderBy:{occurredAt:"desc"},take:Math.max(1,Math.min(200,t))})}function l(e=new Date){let t;return(t=new Date(e)).setDate(t.getDate()+s),t}async function c(e){let t=Math.max(0,Math.round(Number(e.credits)||0));return a.prisma.creditLot.create({data:{userId:e.userId,credits:t,amountCredits:t,remainingCredits:t,source:e.source,stripeEventId:e.stripeEventId||null,stripePriceId:e.stripePriceId||null,stripeCheckoutSessionId:e.stripeCheckoutSessionId||null,stripePaymentIntentId:e.stripePaymentIntentId||null,expiresAt:e.expiresAt||null}})}async function p(e){let t=Math.max(0,Math.round(Number(e.credits)||0));if(!t)return{ok:!1,balance:null};let r=l(new Date);return await a.prisma.$transaction(async a=>{let s=await a.credits.findUnique({where:{userId:e.userId}}),n=(s?.balance??0)+t,i=await a.credits.upsert({where:{userId:e.userId},update:{balance:n,expiresAt:s?.expiresAt&&s.expiresAt>r?s.expiresAt:r},create:{userId:e.userId,balance:n,expiresAt:r}});return await a.creditLot.create({data:{userId:e.userId,credits:t,amountCredits:t,remainingCredits:t,source:e.source,stripeEventId:e.stripeEventId||null,stripePriceId:e.stripePriceId||null,stripeCheckoutSessionId:e.stripeCheckoutSessionId||null,stripePaymentIntentId:e.stripePaymentIntentId||null,expiresAt:r}}),{ok:!0,balance:i.balance}})}e.s(["computeNewExpiry",()=>l,"createCreditLot",()=>c,"createCreditUsageEvent",()=>d,"enforceCreditExpiry",()=>o,"getCreditsAggregate",()=>i,"getOrCreateCredits",()=>n,"grantCredits",()=>p,"listCreditUsage",()=>u])},749649,e=>{"use strict";let t={"mentor-query":{toolId:"mentor-query",maxInputBytesFreeAnon:1e3,maxInputBytesFreeAuthed:6e3,maxRunMsHardCap:6e4,freeMsPerDayAuthed:3e4,freeMsPerDayAnon:8e3,creditsPerMsPaid:1e-4,allowAnonymous:!0,allowAuthed:!0},"whois-summary":{toolId:"whois-summary",maxInputBytesFreeAnon:300,maxInputBytesFreeAuthed:2e3,maxRunMsHardCap:2e4,freeMsPerDayAuthed:6e4,freeMsPerDayAnon:15e3,creditsPerMsPaid:5e-5,allowAnonymous:!0,allowAuthed:!0},"templates-request-download":{toolId:"templates-request-download",maxInputBytesFreeAnon:600,maxInputBytesFreeAuthed:2e3,maxRunMsHardCap:3e4,freeMsPerDayAuthed:2e4,freeMsPerDayAnon:0,creditsPerMsPaid:1e-4,allowAnonymous:!1,allowAuthed:!0},"sandbox-echo":{toolId:"sandbox-echo",maxInputBytesFreeAnon:2e3,maxInputBytesFreeAuthed:1e4,maxRunMsHardCap:15e3,freeMsPerDayAuthed:2e4,freeMsPerDayAnon:1e4,creditsPerMsPaid:1e-4,allowAnonymous:!0,allowAuthed:!0},"code-runner":{toolId:"code-runner",maxInputBytesFreeAnon:6500,maxInputBytesFreeAuthed:6500,maxRunMsHardCap:8e3,freeMsPerDayAuthed:2e4,freeMsPerDayAnon:1e4,creditsPerMsPaid:1e-4,allowAnonymous:!0,allowAuthed:!0}};function r(e){return t[e]||null}let a={"dns-email-security-dashboard":{toolId:"dns-email-security-dashboard",label:"DNS email security",computeClass:"B",typicalInputBytes:120,typicalSteps:1,guidance:["Shorter inputs reduce retries.","Repeated checks of the same domain usually add little value. Try a different domain or a different tool."],scenarios:[{title:"Typical runs",estimateNote:"Most runs are small and fit in the free tier.",mediumRunsPerTenCredits:120,browserOnlyCostsZero:!1}]},"https-redirect-checker":{toolId:"https-redirect-checker",label:"HTTPS redirect checker",computeClass:"B",typicalInputBytes:200,typicalSteps:6,guidance:["Short redirect chains cost less.","If you only need the final destination, do one check per key entry page."],scenarios:[{title:"Redirect chains",estimateNote:"Costs rise with chain length.",mediumRunsPerTenCredits:80}]},"website-security-lab":{toolId:"website-security-lab",label:"Website security lab",computeClass:"B",typicalInputBytes:240,typicalSteps:6,guidance:["Test one representative URL per site, then expand.","Avoid long redirect chains or many subpaths unless needed."]},"email-header-phishing-lab":{toolId:"email-header-phishing-lab",label:"Email header lab",computeClass:"B",typicalInputBytes:6e3,typicalSteps:1,guidance:["Paste headers only, not the message body.","Trim the header block to the relevant hops if it is extremely long."]},"phishing-link-explainer":{toolId:"phishing-link-explainer",label:"Phishing link explainer",computeClass:"B",typicalInputBytes:300,typicalSteps:2,guidance:["Short URLs and fewer redirects reduce work.","Run a second check only if the context changed."]},"third-party-script-viewer":{toolId:"third-party-script-viewer",label:"Third party script viewer",computeClass:"B",typicalInputBytes:200,typicalSteps:4,guidance:["Use one representative page per application area.","Focus on scripts that run on authenticated pages first."]},"dns-lookup":{toolId:"dns-lookup",label:"DNS lookup",computeClass:"B",typicalInputBytes:120,typicalSteps:1,guidance:["Use one hostname at a time."]},"tls-inspect":{toolId:"tls-inspect",label:"TLS inspect",computeClass:"B",typicalInputBytes:120,typicalSteps:1,guidance:["Use a hostname rather than an IP.","Retry only after you confirm the service is up."]},"whois-summary":{toolId:"whois-summary",label:"WHOIS summary",computeClass:"B",typicalInputBytes:120,typicalSteps:1,guidance:["Compare results with context and expected registrant."]},"ip-reputation":{toolId:"ip-reputation",label:"IP reputation",computeClass:"B",typicalInputBytes:60,typicalSteps:1,guidance:["Combine with logs and behavioural indicators."]},"mentor-query":{toolId:"mentor-query",label:"Mentor",computeClass:"B",typicalInputBytes:2e3,typicalSteps:6,guidance:["Ask one focused question at a time.","Include the page link so the match is tighter.","Shorter questions usually respond faster."]},"templates-request-download":{toolId:"templates-request-download",label:"Template download request",computeClass:"B",typicalInputBytes:800,typicalSteps:3,guidance:["Choose one template at a time.","Keep the requested use clear and short."]},"model-forge-train":{toolId:"model-forge-train",label:"Model Forge training",computeClass:"B",typicalInputBytes:25e4,typicalSteps:200,fileLimits:{freeMaxBytes:358400,paidMaxBytes:2097152,absoluteMaxBytes:4194304},guidance:["Start with fewer rows and fewer epochs.","Try one target column at a time.","Avoid high-cardinality text columns in a tabular demo."],scenarios:[{title:"Small CSV",estimateNote:"A small CSV with light training usually fits in the free tier.",mediumRunsPerTenCredits:40},{title:"Bigger dataset",estimateNote:"Larger datasets and more iterations can exceed the free tier.",largeRunCredits:2}]},"software-tradeoff-sim":{toolId:"software-tradeoff-sim",label:"Engineering trade-off simulator",computeClass:"A",typicalInputBytes:400,typicalSteps:50,guidance:["Keep constraints realistic.","Change one variable at a time so you can explain causality.","Write down the decision rule you are using."]},"data-roadmap-sim":{toolId:"data-roadmap-sim",label:"Data and digitalisation roadmap simulator",computeClass:"A",typicalInputBytes:600,typicalSteps:60,guidance:["Keep the first pass simple: purpose, owners, and controls.","Improve quality at source before building bigger dashboards.","Write down your decision rule."]},"cyber-risk-sim":{toolId:"cyber-risk-sim",label:"Cyber risk mapping simulator",computeClass:"A",typicalInputBytes:700,typicalSteps:70,guidance:["Start with one asset and one realistic threat.","Pick controls you can operate and measure.","Write the acceptance criteria for residual risk."]},"ai-prompt-compare":{toolId:"ai-prompt-compare",label:"Prompt comparison playground",computeClass:"A",typicalInputBytes:2e3,typicalSteps:40,guidance:["Compare small prompt changes only.","Write what success looks like before you run.","Treat results as illustrative, not definitive."]},"ai-consistency-test":{toolId:"ai-consistency-test",label:"Output consistency tester",computeClass:"A",typicalInputBytes:2500,typicalSteps:80,guidance:["Run a few samples first, then increase.","Separate prompt quality from model randomness.","Log both the prompt and the settings."]},"ai-bias-sim":{toolId:"ai-bias-sim",label:"Bias scenario explorer",computeClass:"A",typicalInputBytes:1500,typicalSteps:90,guidance:["Bias often comes from data and labels, not intent.","Check base rates before blaming the model.","Always define who is harmed by errors."]},"ai-behaviour-compare":{toolId:"ai-behaviour-compare",label:"Model behaviour comparison (simulated)",computeClass:"A",typicalInputBytes:2200,typicalSteps:70,guidance:["Compare behaviours, not vibes.","Look for quiet failures and edge cases.","Decide when not to use AI."]},"ai-story-generator":{toolId:"ai-story-generator",label:"Story generator (safe demo)",computeClass:"A",typicalInputBytes:160,typicalSteps:40,guidance:["Keep prompts short for cheaper runs.","Add detail gradually.","Use child-friendly language for child projects."]},"ai-homework-helper":{toolId:"ai-homework-helper",label:"Homework helper (safe demo)",computeClass:"A",typicalInputBytes:220,typicalSteps:55,guidance:["Write the exact equation if possible.","Ask for steps, not just answers.","Check the final answer by substitution."]},"ai-support-bot":{toolId:"ai-support-bot",label:"Support bot (safe demo)",computeClass:"A",typicalInputBytes:220,typicalSteps:55,guidance:["Keep one intent per message (return/refund/delivery).","Avoid sensitive personal data in demos.","Save strong replies as templates."]},"studio-help-assistant":{toolId:"studio-help-assistant",label:"Studios help assistant",computeClass:"A",typicalInputBytes:420,typicalSteps:70,guidance:["Ask one clear question at a time.","Paste your requirements to tailor examples.","Use the light preset for cheaper runs."]}};function s(e){return e&&a[e]||null}e.s(["COMPUTE_TIER",0,{freeUnitsPerRun:7500,freeUnitsPerSession:3e4,creditUnitsPerCredit:25e3},"getJobRunnerToolLimits",()=>r,"getToolComputeProfile",()=>s])},699384,e=>{"use strict";var t=e.i(124594);async function r(e){return t.prisma.project.create({data:{ownerId:e.ownerId,workspaceSessionId:e.workspaceSessionId,title:e.title,topic:e.topic}})}async function a(e){let r=t.prisma.project,a=e.ownerId?{ownerId:e.ownerId}:{ownerId:null,workspaceSessionId:e.workspaceSessionId};return e.q&&(a.title={contains:e.q}),r.findMany({where:a,orderBy:{updatedAt:"desc"},take:50})}async function s(e){return t.prisma.project.findUnique({where:{id:e.projectId},include:{runs:{orderBy:{startedAt:"desc"}},notes:{orderBy:{createdAt:"desc"}}}})}async function n(e){return t.prisma.run.create({data:{projectId:e.projectId,toolId:e.toolId,status:e.status,startedAt:new Date,inputJson:e.inputJson??null}})}async function i(e){return t.prisma.run.update({where:{id:e.runId},data:{status:e.status,finishedAt:new Date,outputJson:e.outputJson??null,metricsJson:e.metricsJson??null,errorJson:e.errorJson??null}})}async function o(e){return t.prisma.note.create({data:{projectId:e.projectId,runId:e.runId,content:e.content.slice(0,8e3)}})}async function d(e){return t.prisma.project.updateMany({where:{ownerId:null,workspaceSessionId:e.workspaceSessionId},data:{ownerId:e.ownerId}})}e.s(["claimWorkspace",()=>d,"createNote",()=>o,"createProject",()=>r,"createRun",()=>n,"getProject",()=>s,"listProjects",()=>a,"updateRun",()=>i])},300794,(e,t,r)=>{t.exports=e.x("node:dns/promises",()=>require("node:dns/promises"))},576071,e=>{"use strict";var t=e.i(666680);function r(e=new Date){return e.toISOString().slice(0,10)}function a(e){var r;let a=(e.headers.get("x-forwarded-for")||"").split(",")[0]?.trim()||e.headers.get("x-real-ip")||"",s=e.headers.get("user-agent")||"";return a?(r=`${a}|${s}`.slice(0,400),t.default.createHash("sha256").update(r).digest("hex")):null}e.s(["anonKeyFromRequest",()=>a,"getDayUtc",()=>r])},512602,294667,903944,e=>{"use strict";var t=e.i(124594),r=e.i(576071),a=e.i(749649);class s extends Error{code;constructor(e,t){super(t),this.code=e}}function n(){return Date.now()}function i(e){let t="number"==typeof e?e:Number(e);return Number.isFinite(t)?Math.max(0,Math.round(t)):0}async function o(e,r,a,s){let n=t.prisma.jobEvent;await n.create({data:{jobId:e,level:r,message:a,data:s??null}})}async function d(e){return t.prisma.dailyUsage.upsert({where:{dayUtc_userId_anonKey_toolId:{dayUtc:e.dayUtc,userId:e.userId,anonKey:e.anonKey,toolId:e.toolId}},create:{dayUtc:e.dayUtc,userId:e.userId,anonKey:e.anonKey,toolId:e.toolId,usedMs:0,usedCredits:0,requestCount:0,lastRequestAt:null},update:{}})}async function u(e){var u;let l=String(e.toolId||"").trim(),c=(0,a.getJobRunnerToolLimits)(l);if(!c)throw Error("UNKNOWN_TOOL");let p=e.userId||null,m=e.anonKey||(p?null:(0,r.anonKeyFromRequest)(e.req));if(p&&!c.allowAuthed||!p&&!c.allowAnonymous)throw Error("TOOL_DENIED");if(!p&&!m)throw Error("ANON_KEY_REQUIRED");let h=null==e.inputBytes?null:i(e.inputBytes),y=p?c.maxInputBytesFreeAuthed:c.maxInputBytesFreeAnon;if(null!=h&&h>y)throw Error("INPUT_TOO_LARGE");let f=e.idempotencyKey?String(e.idempotencyKey).trim():null,g=t.prisma.job;if(f){let e=await g.findUnique({where:{idempotencyKey:f}});if(e&&"succeeded"===e.status)return{jobId:e.id,status:e.status,durationMs:i(e.durationMs),freeTierAppliedMs:i(e.freeTierAppliedMs),chargedCredits:i(e.chargedCredits),remainingFreeMsToday:0,result:e.resultJson};if(e&&"running"===e.status)return{jobId:e.id,status:e.status,durationMs:i(e.durationMs),freeTierAppliedMs:i(e.freeTierAppliedMs),chargedCredits:i(e.chargedCredits),remainingFreeMsToday:0}}let w=String((await g.create({data:{userId:p,anonKey:m,toolId:l,status:"queued",inputBytes:h,requestId:e.requestId?String(e.requestId).slice(0,120):null,idempotencyKey:f},select:{id:!0}})).id);await o(w,"info","job_queued",{toolId:l});let I=(0,r.getDayUtc)(),M=await d({dayUtc:I,userId:p,anonKey:m,toolId:null}),b=await d({dayUtc:I,userId:p,anonKey:m,toolId:l}),x=i(b.requestCount);if(x>=200)return await g.update({where:{id:w},data:{status:"denied",errorCode:"RATE_LIMITED",finishedAt:new Date}}),await o(w,"warn","job_denied_rate_limit",{requestCount:x}),{jobId:w,status:"denied",durationMs:0,freeTierAppliedMs:0,chargedCredits:0,remainingFreeMsToday:0};let A=Math.max(0,(p?c.freeMsPerDayAuthed:c.freeMsPerDayAnon)-i(b.usedMs));await g.update({where:{id:w},data:{status:"running",startedAt:new Date}}),await o(w,"info","job_started",{});let C=n();try{let r=await e.execute({jobId:w}),a=(u={durationMs:Math.min(c.maxRunMsHardCap,Math.max(0,n()-C)),freeRemainingMsAtStart:A,creditsPerMsPaid:c.creditsPerMsPaid,maxRunMsHardCap:c.maxRunMsHardCap},function(e){let{durationMs:t,freeRemainingMsAtStart:r,creditsPerMsPaid:a,maxRunMsHardCap:s}=e,n=Math.max(0,Math.min(Number(t||0),Number(s||0)||0)),i=Math.min(n,Math.max(0,Number(r||0))),o=Math.max(0,n-i),d=Math.max(0,Number(a||0)),u=o>0?Math.max(1,Math.ceil(o*d)):0;return{durationMs:n,freeTierAppliedMs:i,paidMs:o,chargedCredits:u}}(u)),s=Math.max(0,A-a.freeTierAppliedMs);return await t.prisma.$transaction(async e=>{let t=e.dailyUsage,s=e.job;await t.update({where:{id:b.id},data:{usedMs:i(b.usedMs)+a.durationMs,usedCredits:i(b.usedCredits)+a.chargedCredits,requestCount:i(b.requestCount)+1,lastRequestAt:new Date}}),await t.update({where:{id:M.id},data:{usedMs:i(M.usedMs)+a.durationMs,usedCredits:i(M.usedCredits)+a.chargedCredits,requestCount:i(M.requestCount)+1,lastRequestAt:new Date}}),await s.update({where:{id:w},data:{status:"succeeded",finishedAt:new Date,durationMs:a.durationMs,freeTierAppliedMs:a.freeTierAppliedMs,chargedCredits:a.chargedCredits,resultJson:function(e,t=16e3){try{let r=JSON.stringify(e);if(Buffer.byteLength(r,"utf8")>t)return null;return JSON.parse(r)}catch{return null}}(r)}})}),await o(w,"info","job_succeeded",{durationMs:a.durationMs,chargedCredits:a.chargedCredits}),{jobId:w,status:"succeeded",durationMs:a.durationMs,freeTierAppliedMs:a.freeTierAppliedMs,chargedCredits:a.chargedCredits,remainingFreeMsToday:s,result:r}}catch(r){let e=Math.min(c.maxRunMsHardCap,Math.max(0,n()-C));if(r instanceof s)return await g.update({where:{id:w},data:{status:"denied",finishedAt:new Date,durationMs:e,errorCode:r.code,errorMessage:String(r.message||"").slice(0,500)}}),await o(w,"warn","job_denied",{code:r.code}),{jobId:w,status:"denied",durationMs:e,freeTierAppliedMs:0,chargedCredits:0,remainingFreeMsToday:A};let t={code:"string"==typeof r?.code?r.code:"JOB_FAILED",message:"string"==typeof r?.message?r.message.slice(0,500):"Job failed",stack:"string"==typeof r?.stack?r.stack.slice(0,2e3):null};return await g.update({where:{id:w},data:{status:"failed",finishedAt:new Date,durationMs:e,errorCode:t.code,errorMessage:t.message,errorStack:t.stack}}),await o(w,"error","job_failed",{code:t.code}),{jobId:w,status:"failed",durationMs:e,freeTierAppliedMs:0,chargedCredits:0,remainingFreeMsToday:A}}}async function l(e){let r=t.prisma.jobEvent;await r.create({data:{jobId:e.jobId,level:e.level,message:e.message,data:e.data??null}})}function c(e){let t;if(!e||"object"!=typeof e)return{ok:!1,error:"Invalid payload."};let r=e.language;if("js"!==r&&"py"!==r)return{ok:!1,error:"Unknown language."};let a="string"==typeof e.code?e.code:"";return a?a.length>6e3?{ok:!1,error:"Code is too large."}:(t=String(a||"").toLowerCase(),("py"===r?["socket","urllib","requests","http.client","subprocess","os.system","open("]:["fetch","xmlhttprequest","websocket","require(","import ","import(","process.","deno."]).find(e=>t.includes(e.toLowerCase()))||0)?{ok:!1,error:"Network and host access APIs are not available in this sandbox."}:{ok:!0,value:{language:r,code:a,input:"string"==typeof e.input?e.input:""}}:{ok:!1,error:"Missing code."}}e.s(["runWithMetering",()=>u],512602),e.s(["validateCodeRunnerPayloadTs",()=>c],294667);var p=e.i(685750),m=e.i(300794);class h extends Error{code="SAFE_FETCH_BLOCKED";constructor(e){super(e)}}class y extends Error{code="SAFE_FETCH_TIMEOUT";constructor(e){super(e)}}let f=new Set(["169.254.169.254"]);function g(e){let t=/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.exec(e);if(!t)return!1;let r=Number(t[1]),a=Number(t[2]);return 10===r||127===r||0===r||169===r&&254===a||192===r&&168===a||172===r&&a>=16&&a<=31||100===r&&a>=64&&a<=127||!1}async function w(e,t){let r;if("localhost"===(r=e.hostname.toLowerCase())||"127.0.0.1"===r||"::1"===r||r.endsWith(".localhost")||f.has(e.hostname))throw new h("Blocked host");if(g(e.hostname))throw new h("Blocked IP range");try{for(let t of(await m.default.lookup(e.hostname,{all:!0,verbatim:!0})))if("string"==typeof t?.address&&(f.has(t.address)||g(t.address)))throw new h("Blocked IP range")}catch{throw new h("Unable to resolve host")}}async function I(e,t){let r=e.body?.getReader?.();if(!r){let r=Buffer.from(await e.arrayBuffer());if(r.byteLength>t)throw new h("Response too large");return r}let a=[],s=0;for(;;){let{done:e,value:n}=await r.read();if(e)break;if(n){if((s+=n.byteLength)>t)throw new h("Response too large");a.push(n)}}return Buffer.concat(a.map(e=>Buffer.from(e)))}async function M(e,t){let r=new URL(e),a=!!t.allowHttp||!!t.allowHttpInDev&&!1;if("https:"!==r.protocol&&!(a&&"http:"===r.protocol))throw new h("Blocked protocol");await w(r,!!t.allowLocalhostInDev);let s=new AbortController,n=setTimeout(()=>s.abort(),Math.max(1,t.overallTimeoutMs));try{let e=await fetch(r.toString(),{...t,redirect:"manual",signal:s.signal}),a=await I(e,t.maxResponseBytes);return{res:e,body:a}}catch(e){if(e?.name==="AbortError")throw new y("Request timed out");throw e}finally{clearTimeout(n)}}let b="This feature is not available yet. We are preparing the secure compute runner.";async function x(e){let t=process.env.RUNNER_BASE_URL||"";if(!t)return{ok:!1,metrics:{runMs:0},error:{code:"RUNNER_NOT_CONFIGURED",message:b}};let r=new URL("/run",t).toString(),a=Math.max(1,Math.min(2e5,e.limits.maxOutputBytes)),s=Math.max(1,Math.min(3e4,e.limits.maxRunMs)),n=e?.limits?.maxSteps,i=Date.now();try{let{res:t,body:o}=await M(r,{method:"POST",headers:{"content-type":"application/json","x-job-id":e.jobId,"x-tool-id":e.toolId},body:JSON.stringify({...e,limits:{...e.limits,maxOutputBytes:a,maxRunMs:s,maxSteps:n}}),maxResponseBytes:a,overallTimeoutMs:s+1500,allowHttpInDev:!0,allowLocalhostInDev:!0}),d=JSON.parse(o.toString("utf8"));if(!d||"boolean"!=typeof d.ok)return{ok:!1,metrics:{runMs:Date.now()-i},error:{code:"RUNNER_BAD_RESPONSE",message:"Runner returned an invalid response."}};if(!t.ok)return{ok:!1,metrics:d.metrics||{runMs:Date.now()-i},error:d.error||{code:"RUNNER_ERROR",message:"Runner returned an error."},stderr:d.stderr};return d}catch(t){let e=Date.now()-i;if(t instanceof h)return{ok:!1,metrics:{runMs:e},error:{code:t.code,message:"Runner request blocked."}};if(t instanceof y)return{ok:!1,metrics:{runMs:e},error:{code:t.code,message:"Runner request timed out."}};return{ok:!1,metrics:{runMs:e},error:{code:"RUNNER_UNAVAILABLE",message:b}}}}async function A(e){return await x(e)}async function C(e){let r=Date.now(),s=String(e.toolId||"").trim(),n=(0,a.getJobRunnerToolLimits)(s);if(!n)return{result:null,metrics:{cpuMs:0,memoryMb:0,wallTimeMs:0,aborted:!1}};let i=Math.max(1,Math.min(n.maxRunMsHardCap,Math.round(e.limits.maxRunMs))),o=Math.max(1,Math.min(2e5,Math.round(e.limits.maxOutputBytes))),d=Math.max(1,Math.min(256,Math.round(e.limits.maxMemoryMb))),u="number"==typeof e.limits.maxSteps?Math.max(1,Math.min(1e6,Math.round(e.limits.maxSteps))):void 0;if(e.userId){let a=await (0,p.getOrCreateCredits)(e.userId),o=new Date().toISOString().slice(0,10),d=t.prisma.dailyUsage,u=await d.findUnique({where:{dayUtc_userId_anonKey_toolId:{dayUtc:o,userId:e.userId,anonKey:null,toolId:s}}}).catch(()=>null),l="number"==typeof u?.usedMs?u.usedMs:0,c=Math.max(0,i-Math.max(0,n.freeMsPerDayAuthed-l)),m=c>0?Math.ceil(c*n.creditsPerMsPaid):0;if(m>0&&(a.balance??0)<m)return{result:{ok:!1,error:{code:"INSUFFICIENT_CREDITS",message:"Not enough credits for the selected limits."}},metrics:{cpuMs:0,memoryMb:0,wallTimeMs:Date.now()-r,aborted:!1}}}let l=await A({toolId:s,jobId:"n/a",payload:e.inputs,limits:{maxRunMs:i,maxOutputBytes:o,maxMemoryMb:d,maxSteps:u}}),c=Date.now()-r,m="number"==typeof l.metrics?.runMs?l.metrics.runMs:c,h="number"==typeof l.metrics?.peakMemoryMb?l.metrics.peakMemoryMb:void 0,y=l.error?.code==="SAFE_FETCH_TIMEOUT"||l.error?.code==="TIMEOUT";return console.log("compute:run",{toolId:s,wallTimeMs:c,cpuMs:m,memoryMb:h??d,aborted:y,ok:l.ok}),{result:l,metrics:{cpuMs:Math.max(0,Math.round(m)),memoryMb:Math.max(0,Math.round(h??d)),wallTimeMs:Math.max(0,Math.round(c)),aborted:y}}}let R="This feature is not available yet. We are preparing the secure compute runner.",k={"mentor-query":async({jobId:e,payload:t})=>({jobId:e,ok:!0,message:"mentor-query handler not implemented yet",echo:t?"received":"none"}),"whois-summary":async({jobId:e,payload:t})=>({jobId:e,ok:!0,message:"whois-summary handler not implemented yet",echo:t?"received":"none"}),"templates-request-download":async({jobId:e,payload:t})=>({jobId:e,ok:!0,message:"templates-request-download handler not implemented yet",echo:t?"received":"none"}),"sandbox-echo":async({jobId:e,payload:t,userId:r,anonKey:a,toolId:n})=>{let i=await C({toolId:n,userId:r,anonKey:a,inputs:t,limits:{maxRunMs:15e3,maxOutputBytes:2e5,maxMemoryMb:128,maxSteps:1e4}}),o=i.result;if(!o?.ok)throw new s(o?.error?.code||"RUNNER_NOT_AVAILABLE",o?.error?.message||R);return{ok:!0,stdout:String(o.stdout||""),metrics:o.metrics,compute:i.metrics}},"code-runner":async({jobId:e,payload:t,userId:r,anonKey:a,toolId:n})=>{let i=c(t);if(!i.ok)throw await l({jobId:e,level:"warn",message:"code_runner_rejected",data:{reason:i.error}}),new s("INVALID_INPUT",i.error);if("py"===i.value.language)throw await l({jobId:e,level:"warn",message:"python_coming_soon"}),new s("PYTHON_COMING_SOON","Python sandbox coming soon.");let o=await C({toolId:n,userId:r,anonKey:a,inputs:i.value,limits:{maxRunMs:8e3,maxOutputBytes:6e4,maxMemoryMb:128,maxSteps:2e5}}),d=o.result,u="string"==typeof d.stdout?d.stdout.slice(0,1200):"",p="string"==typeof d.stderr?d.stderr.slice(0,1200):"";if(await l({jobId:e,level:d.ok?"info":"warn",message:"code_runner_result",data:{ok:d.ok,runMs:d.metrics?.runMs||0,stdout:u,stderr:p,aborted:!!o.metrics.aborted}}),!d.ok)throw new s(d.error?.code||"RUNNER_NOT_AVAILABLE",d.error?.message||R);return{ok:!0,stdout:d.stdout||"",stderr:d.stderr||"",metrics:d.metrics,compute:o.metrics}}};function S(e){return k[e]||null}e.s(["getJobHandler",()=>S],903944)},716851,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),s=e.i(759756),n=e.i(561916),i=e.i(114444),o=e.i(837092),d=e.i(869741),u=e.i(316795),l=e.i(487718),c=e.i(995169),p=e.i(47587),m=e.i(666012),h=e.i(570101),y=e.i(626937),f=e.i(10372),g=e.i(193695);e.i(52474);var w=e.i(600220),I=e.i(89171),M=e.i(124594),b=e.i(512602),x=e.i(903944),A=e.i(699384);async function C(e){let t=Math.max(1,Math.min(25,e.limit)),r=M.prisma.job,a=await r.findMany({where:{status:"queued"},orderBy:{createdAt:"asc"},take:t,select:{id:!0,toolId:!0,userId:!0,anonKey:!0,inputBytes:!0,payloadJson:!0,idempotencyKey:!0,requestId:!0}}),s=[];for(let e of a){let t=String(e.id),a=String(e.toolId),n=(0,x.getJobHandler)(a);if(!n){await r.update({where:{id:t},data:{status:"failed",errorCode:"HANDLER_MISSING",errorMessage:"No handler registered"}}),s.push({jobId:t,status:"failed"});continue}try{await r.update({where:{id:t},data:{status:"running",startedAt:new Date}});let i=await (0,b.runWithMetering)({req:new Request("http://localhost/worker"),toolId:a,userId:e.userId?String(e.userId):null,anonKey:e.anonKey?String(e.anonKey):null,inputBytes:e.inputBytes??null,requestId:e.requestId?String(e.requestId):null,idempotencyKey:e.idempotencyKey?String(e.idempotencyKey):null,execute:async({jobId:t})=>n({jobId:t,toolId:a,userId:e.userId?String(e.userId):null,anonKey:e.anonKey?String(e.anonKey):null,payload:e.payloadJson})});await r.update({where:{id:t},data:{status:i.status,finishedAt:new Date,durationMs:i.durationMs,freeTierAppliedMs:i.freeTierAppliedMs,chargedCredits:i.chargedCredits,resultJson:i.result??null}});let o=e.payloadJson?.__workspace;o?.runId&&o?.projectId&&(await (0,A.updateRun)({runId:String(o.runId),status:i.status,outputJson:i.result??null,metricsJson:{durationMs:i.durationMs,freeTierAppliedMs:i.freeTierAppliedMs,chargedCredits:i.chargedCredits},errorJson:"succeeded"===i.status?null:{code:i.status,message:"Run did not succeed."}}).catch(()=>null),"string"==typeof o.note&&o.note.trim()&&await (0,A.createNote)({projectId:String(o.projectId),runId:String(o.runId),content:o.note.trim()}).catch(()=>null)),console.log("worker:job",{jobId:t,toolId:a,status:i.status,durationMs:i.durationMs,chargedCredits:i.chargedCredits}),s.push({jobId:t,status:i.status})}catch(e){await r.update({where:{id:t},data:{status:"failed",finishedAt:new Date,errorCode:"WORKER_FAILED",errorMessage:String(e?.message||"Worker failed").slice(0,500)}}),console.log("worker:job_failed",{jobId:t,toolId:a,message:String(e?.message||"unknown")}),s.push({jobId:t,status:"failed"})}}return{processedCount:s.length,processed:s}}var R=e.i(657194),k=e.i(967291);async function S(e){let t=(0,R.rateLimit)(e,{keyPrefix:"admin-worker-tick",limit:30,windowMs:6e4});if(t)return t;let r=process.env.ADMIN_WORKER_SECRET||"",a=e.headers.get("x-admin-worker-secret")||"";if(!r||a!==r)return I.NextResponse.json({error:"Forbidden"},{status:403});let s=await e.json().catch(()=>({})),n="number"==typeof s?.limit?s.limit:10,i=await C({limit:n});return(0,k.logInfo)("admin.worker_tick",{processedCount:i.processedCount,requestId:e.headers.get("x-request-id")||null}),I.NextResponse.json(i,{status:200})}e.s(["POST",()=>S],579353);var v=e.i(579353);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/run-worker-tick/route",pathname:"/api/admin/run-worker-tick",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/run-worker-tick/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:T,workUnitAsyncStorage:N,serverHooks:B}=E;function P(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:N})}async function _(e,t,a){E.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let I="/api/admin/run-worker-tick/route";I=I.replace(/\/index$/,"")||"/";let M=await E.prepare(e,t,{srcPage:I,multiZoneDraftMode:!1});if(!M)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:b,params:x,nextConfig:A,parsedUrl:C,isDraftMode:R,prerenderManifest:k,routerServerContext:S,isOnDemandRevalidate:v,revalidateOnlyGenerated:T,resolvedPathname:N,clientReferenceManifest:B,serverActionsManifest:P}=M,_=(0,d.normalizeAppPath)(I),q=!!(k.dynamicRoutes[_]||k.routes[N]),D=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,C,!1):t.end("This page could not be found"),null);if(q&&!R){let e=!!k.routes[N],t=k.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await D();throw new g.NoFallbackError}}let U=null;!q||E.isDev||R||(U="/index"===(U=N)?"/":U);let j=!0===E.isDev||!q,O=q&&!j;P&&B&&(0,i.setReferenceManifestsSingleton)({page:I,clientReferenceManifest:B,serverActionsManifest:P,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:P})});let L=e.method||"GET",F=(0,n.getTracer)(),H=F.getActiveScopeSpan(),K={params:x,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:j,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>E.onRequestError(e,t,a,S)},sharedContext:{buildId:b}},J=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),$=l.NextRequestAdapter.fromNodeNextRequest(J,(0,l.signalFromNodeResponse)(t));try{let i=async e=>E.handle($,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${L} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${I}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var n,d;let u=async({previousCacheEntry:r})=>{try{if(!o&&v&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let d=K.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let u=K.renderOpts.collectedTags;if(!q)return await (0,m.sendResponse)(J,W,n,K.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:v})},S),t}},l=await E.handleResponse({req:e,nextConfig:A,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:v,revalidateOnlyGenerated:T,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:o});if(!q)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",v?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,h.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&q||c.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,y.getCacheControlHeader)(l.cacheControl)),await (0,m.sendResponse)(J,W,new Response(l.value.body,{headers:c,status:l.value.status||200})),null};H?await d(H):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${L} ${I}`,kind:n.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},d))}catch(t){if(t instanceof g.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:O,isOnDemandRevalidate:v})}),q)throw t;return await (0,m.sendResponse)(J,W,new Response(null,{status:500})),null}}e.s(["handler",()=>_,"patchFetch",()=>P,"routeModule",()=>E,"serverHooks",()=>B,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>N],716851)}];

//# debugId=9fb0e374-1808-387c-f1f2-9396a3b726b0
//# sourceMappingURL=%5Broot-of-the-server%5D__42d49c9a._.js.map