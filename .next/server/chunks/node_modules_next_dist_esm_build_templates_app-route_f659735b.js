;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="5d347aea-6431-8076-2a0a-8d56352c6424")}catch(e){}}();
module.exports=[70488,e=>{"use strict";var t=e.i(747909),n=e.i(174017),r=e.i(996250),a=e.i(759756),o=e.i(561916),i=e.i(114444),s=e.i(837092),l=e.i(869741),u=e.i(316795),d=e.i(487718),c=e.i(995169),p=e.i(47587),m=e.i(666012),f=e.i(570101),R=e.i(626937),h=e.i(10372),g=e.i(193695);e.i(52474);var y=e.i(600220),w=e.i(89171),C=e.i(757660),x=e.i(568212),E=e.i(657194),O=e.i(576071),S=e.i(124594),v=e.i(749649);async function I(e){let t=String(e.toolId||"").trim();if(!(0,v.getJobRunnerToolLimits)(t))throw Error("UNKNOWN_TOOL");let n=S.prisma.job;if(e.idempotencyKey){let t=await n.findUnique({where:{idempotencyKey:e.idempotencyKey}});if(t)return{jobId:String(t.id),status:String(t.status)}}let r=await n.create({data:{toolId:t,userId:e.userId,anonKey:e.anonKey,inputBytes:e.inputBytes??null,status:"queued",idempotencyKey:e.idempotencyKey,requestId:e.requestId,payloadJson:function(e,t=16e3){try{let n=JSON.stringify(e);if(Buffer.byteLength(n,"utf8")>t)return null;return JSON.parse(n)}catch{return null}}(e.payload)},select:{id:!0,status:!0}});return{jobId:String(r.id),status:String(r.status)}}var A=e.i(512602),P=e.i(903944),b=e.i(294667),N=e.i(699384),k=e.i(857657),T=e.i(76657),j=e.i(967291);async function _(e){let t=await e.json().catch(()=>null),n="string"==typeof t?.toolId?t.toolId.trim():"",r=(0,E.rateLimit)(e,{keyPrefix:"jobs-create",limit:30,windowMs:6e4});if(r)return r;if("code-runner"===n){let t=(0,E.rateLimit)(e,{keyPrefix:"jobs-create-code-runner",limit:10,windowMs:6e4});if(t)return t}if(!n)return w.NextResponse.json({error:"Missing toolId"},{status:400});let a=(0,v.getJobRunnerToolLimits)(n);if(!a)return w.NextResponse.json({error:"Unknown toolId"},{status:400});let o=await (0,C.getServerSession)(x.authOptions).catch(()=>null),i=o?.user?.id||null,s=i?null:(0,O.anonKeyFromRequest)(e),l="string"==typeof t?.projectId?t.projectId.trim():"",u="string"==typeof t?.note?t.note.slice(0,8e3):"",d=null,c=null;if(!i){let t=function(e,t){for(let n of(e.headers.get("cookie")||"").split(";").map(e=>e.trim())){let e=n.indexOf("=");if(e<=0)continue;let r=n.slice(0,e),a=n.slice(e+1);if(r===t)return decodeURIComponent(a)}return null}(e,k.WORKSPACE_COOKIE.name),n=t?(0,k.verifyWorkspaceToken)(t):null,r=n||(0,k.newWorkspaceTokenRaw)();d=String((await (0,k.getOrCreateWorkspaceSession)({tokenRaw:r})).id),n||(c=r)}if(!i&&!a.allowAnonymous)return w.NextResponse.json({error:"Sign in required"},{status:401});if(!i&&!s)return w.NextResponse.json({error:"Anonymous key unavailable"},{status:400});let p="number"==typeof t?.inputBytes?Math.max(0,Math.round(t.inputBytes)):null,m="string"==typeof t?.idempotencyKey?t.idempotencyKey.trim():null,f=t?.mode==="inline"?"inline":"enqueue",R=t?.requestedComplexityPreset||"standard",h=e.headers.get("x-request-id")||null;if("code-runner"===n){let n=(0,E.rateLimit)(e,{keyPrefix:"code-runner",limit:10,windowMs:6e4});if(n)return n;let r=(0,b.validateCodeRunnerPayloadTs)(t?.payload);if(!r.ok)return w.NextResponse.json({error:r.error},{status:400})}let g=await (0,T.estimateRunCost)({req:e,userId:i,toolId:n,inputBytes:p??0,requestedComplexityPreset:R});if(!g.allowed){let t="light"===R?null:await (0,T.estimateRunCost)({req:e,userId:i,toolId:n,inputBytes:p??0,requestedComplexityPreset:"light"}),r=g.reason&&g.reason.toLowerCase().includes("sign in")?"Sign in to run paid compute.":g.reason&&g.reason.toLowerCase().includes("credits")?"Try the free tier mode, use a lighter preset, or reduce input size.":"Use a lighter preset or reduce input size.",a=g.reason&&g.reason.toLowerCase().includes("sign in")?"auth_required":g.reason&&g.reason.toLowerCase().includes("credits")?"credits_insufficient":(g.reason&&g.reason.toLowerCase().includes("too large"),"estimate_exceeded"),o={code:"RUN_BLOCKED",message:g.reason||"Run blocked.",hint:r};(0,j.logWarn)("compute.run_blocked",{toolId:n,userId:i||null,reason:g.reason||null});let s=w.NextResponse.json({error:o.message,code:o.code,failureReason:a,errorObj:o,estimate:g,alternativeFreeTier:t?.allowed?{preset:"light",estimate:t}:null},{status:402});return c&&s.headers.append("set-cookie",`${k.WORKSPACE_COOKIE.name}=${encodeURIComponent((0,k.signWorkspaceToken)(c))}; Path=/; HttpOnly; SameSite=Lax; Max-Age=${k.WORKSPACE_COOKIE.maxAgeSeconds}`),s}if("inline"===f){let r=(0,P.getJobHandler)(n);if(!r)return w.NextResponse.json({error:"Tool not available for inline execution"},{status:503});let a=null;if(l){let e=await (0,N.getProject)({projectId:l}),r=i?e?.ownerId===i:e?.ownerId==null&&e?.workspaceSessionId===d;if(!e||!r)return w.NextResponse.json({error:"Project not found."},{status:404});a=String((await (0,N.createRun)({projectId:l,toolId:n,status:"running",inputJson:t?.payload??null})).id)}let o=await (0,A.runWithMetering)({req:e,toolId:n,userId:i,anonKey:s,inputBytes:p,idempotencyKey:m,requestId:h,execute:async({jobId:e})=>r({jobId:e,toolId:n,userId:i,anonKey:s,payload:t?.payload??null})});a&&l&&(await (0,N.updateRun)({runId:a,status:o.status,outputJson:o.result??null,metricsJson:{durationMs:o.durationMs,freeTierAppliedMs:o.freeTierAppliedMs,chargedCredits:o.chargedCredits},errorJson:"succeeded"===o.status?null:{code:"JOB_FAILED",message:"Run did not succeed."}}),u.trim()&&await (0,N.createNote)({projectId:l,runId:a,content:u.trim()}));let f=w.NextResponse.json({...o,estimate:g},{status:200});return c&&f.headers.append("set-cookie",`${k.WORKSPACE_COOKIE.name}=${encodeURIComponent((0,k.signWorkspaceToken)(c))}; Path=/; HttpOnly; SameSite=Lax; Max-Age=${k.WORKSPACE_COOKIE.maxAgeSeconds}`),f}let y=null;if(l){let e=await (0,N.getProject)({projectId:l}),r=i?e?.ownerId===i:e?.ownerId==null&&e?.workspaceSessionId===d;if(!e||!r)return w.NextResponse.json({error:"Project not found."},{status:404});let a=await (0,N.createRun)({projectId:l,toolId:n,status:"queued",inputJson:t?.payload??null});y={projectId:l,runId:String(a.id),note:u.trim()||null}}let _=await I({toolId:n,userId:i,anonKey:s,inputBytes:p,idempotencyKey:m,requestId:h,payload:y?{...t?.payload??null,__workspace:y}:t?.payload??null});try{let e=S.prisma.job;_?.jobId&&await e.update({where:{id:String(_.jobId)},data:{estimatedCostCredits:g?.estimatedCredits??0}})}catch{}let K=w.NextResponse.json({..._,estimate:g},{status:200});return c&&K.headers.append("set-cookie",`${k.WORKSPACE_COOKIE.name}=${encodeURIComponent((0,k.signWorkspaceToken)(c))}; Path=/; HttpOnly; SameSite=Lax; Max-Age=${k.WORKSPACE_COOKIE.maxAgeSeconds}`),K}e.s(["POST",()=>_],709657);var K=e.i(709657);let M=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/jobs/create/route",pathname:"/api/jobs/create",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/jobs/create/route.ts",nextConfigOutput:"",userland:K}),{workAsyncStorage:q,workUnitAsyncStorage:U,serverHooks:L}=M;function H(){return(0,r.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:U})}async function W(e,t,r){M.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/jobs/create/route";w=w.replace(/\/index$/,"")||"/";let C=await M.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!C)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:x,params:E,nextConfig:O,parsedUrl:S,isDraftMode:v,prerenderManifest:I,routerServerContext:A,isOnDemandRevalidate:P,revalidateOnlyGenerated:b,resolvedPathname:N,clientReferenceManifest:k,serverActionsManifest:T}=C,j=(0,l.normalizeAppPath)(w),_=!!(I.dynamicRoutes[j]||I.routes[N]),K=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,S,!1):t.end("This page could not be found"),null);if(_&&!v){let e=!!I.routes[N],t=I.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(O.experimental.adapterPath)return await K();throw new g.NoFallbackError}}let q=null;!_||M.isDev||v||(q="/index"===(q=N)?"/":q);let U=!0===M.isDev||!_,L=_&&!U;T&&k&&(0,i.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:k,serverActionsManifest:T,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:T})});let H=e.method||"GET",W=(0,o.getTracer)(),$=W.getActiveScopeSpan(),D={params:E,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!O.experimental.authInterrupts},cacheComponents:!!O.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:O.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r)=>M.onRequestError(e,t,r,A)},sharedContext:{buildId:x}},B=new u.NodeNextRequest(e),J=new u.NodeNextResponse(t),F=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let i=async e=>M.handle(F,D).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=W.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${w}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var o,l;let u=async({previousCacheEntry:n})=>{try{if(!s&&P&&b&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(a);e.fetchMetrics=D.renderOpts.fetchMetrics;let l=D.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let u=D.renderOpts.collectedTags;if(!_)return await (0,m.sendResponse)(B,J,o,D.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[h.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==D.renderOpts.collectedRevalidate&&!(D.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&D.renderOpts.collectedRevalidate,r=void 0===D.renderOpts.collectedExpire||D.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:D.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await M.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:P})},A),t}},d=await M.handleResponse({req:e,nextConfig:O,cacheKey:q,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:b,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:s});if(!_)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",P?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&_||c.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,R.getCacheControlHeader)(d.cacheControl)),await (0,m.sendResponse)(B,J,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};$?await l($):await W.withPropagatedContext(e.headers,()=>W.trace(c.BaseServerSpan.handleRequest,{spanName:`${H} ${w}`,kind:o.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await M.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:P})}),_)throw t;return await (0,m.sendResponse)(B,J,new Response(null,{status:500})),null}}e.s(["handler",()=>W,"patchFetch",()=>H,"routeModule",()=>M,"serverHooks",()=>L,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>U],70488)}];

//# debugId=5d347aea-6431-8076-2a0a-8d56352c6424
//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_f659735b.js.map