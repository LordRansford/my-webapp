;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="f61dc5e5-a9a5-0ac2-28cf-69ea0673bb11")}catch(e){}}();
module.exports=[206761,e=>{"use strict";var t=e.i(89171),r=e.i(757660),s=e.i(568212),o=e.i(925820);async function i(e){if(!(0,o.getToolDefinition)(e))return t.NextResponse.json({error:"Tool not found",code:"TOOL_NOT_FOUND",action:"Check tool ID and try again"},{status:404});if((0,o.isClientSideOnly)(e))return{allowed:!0};if((0,o.toolRequiresAuth)(e)){let e=await (0,r.getServerSession)(s.authOptions);return e?.user?.id?{allowed:!0,userId:e.user.id}:t.NextResponse.json({error:"Authentication required",code:"AUTH_REQUIRED",reason:"This tool requires server-side execution, which needs an account",action:"Sign in to continue",signInUrl:"/api/auth/signin"},{status:401})}return{allowed:!0}}async function a(){let e=await (0,r.getServerSession)(s.authOptions);return e?.user?.id||null}e.s(["getUserIdFromSession",()=>a,"requireAuthForServerTools",()=>i])},161857,e=>{"use strict";function t(e,t,r,s){let o={level:e,event:t,requestId:r.requestId,route:r.route,...s,ts:new Date().toISOString()};"error"===e?console.error(t,o):"warn"===e?console.warn(t,o):console.info(t,o)}e.s(["logger",0,{debug:(e,r,s)=>t("debug",e,r,s),info:(e,r,s)=>t("info",e,r,s),warn:(e,r,s)=>t("warn",e,r,s),error:(e,r,s)=>t("error",e,r,s)}])},27315,e=>{"use strict";var t=e.i(522734),r=e.i(814747);let s=r.default.join(process.cwd(),"data","metrics"),o=r.default.join(s,"tool-execution-metrics.jsonl");function i(e){try{t.default.existsSync(s)||t.default.mkdirSync(s,{recursive:!0});let r={...e,id:`${Date.now()}-${Math.random().toString(36).substring(7)}`,timestamp:new Date().toISOString()},i=JSON.stringify(r)+"\n";t.default.appendFileSync(o,i,"utf-8")}catch(e){console.error("Failed to record tool metric:",e)}}function a(e,r,s){try{if(!t.default.existsSync(o))return n();let i=t.default.readFileSync(o,"utf-8").trim().split("\n").filter(Boolean).map(e=>JSON.parse(e));if(e&&(i=i.filter(t=>t.toolId===e)),r&&(i=i.filter(e=>new Date(e.timestamp)>=r)),s&&(i=i.filter(e=>new Date(e.timestamp)<=s)),0===i.length)return n();let a=i.map(e=>e.durationMs).sort((e,t)=>e-t),l=i.filter(e=>e.success),u=i.filter(e=>!e.success),c=i.filter(e=>e.timeout).length,d=i.filter(e=>(e.retryCount||0)>0).length,h={};u.forEach(e=>{let t=e.errorCode||e.errorType||"unknown";h[t]=(h[t]||0)+1});let f=i.reduce((e,t)=>e+t.creditCharged,0);return{totalExecutions:i.length,successfulExecutions:l.length,failedExecutions:u.length,averageDurationMs:a.reduce((e,t)=>e+t,0)/a.length,p50DurationMs:a[Math.floor(.5*a.length)]||0,p95DurationMs:a[Math.floor(.95*a.length)]||0,p99DurationMs:a[Math.floor(.99*a.length)]||0,totalCreditsCharged:f,averageCreditsPerExecution:f/i.length,errorBreakdown:h,timeoutRate:c/i.length,retryRate:d/i.length}}catch(e){return console.error("Failed to get tool performance stats:",e),n()}}function n(){return{totalExecutions:0,successfulExecutions:0,failedExecutions:0,averageDurationMs:0,p50DurationMs:0,p95DurationMs:0,p99DurationMs:0,totalCreditsCharged:0,averageCreditsPerExecution:0,errorBreakdown:{},timeoutRate:0,retryRate:0}}function l(e,r,s){try{if(!t.default.existsSync(o))return{totalExecutions:0,toolsUsed:[],totalCreditsSpent:0,averageExecutionTime:0,mostUsedTool:null};let i=t.default.readFileSync(o,"utf-8").trim().split("\n").filter(Boolean).map(e=>JSON.parse(e)).filter(t=>t.userId===e);r&&(i=i.filter(e=>new Date(e.timestamp)>=r)),s&&(i=i.filter(e=>new Date(e.timestamp)<=s));let a={},n=0,l=0;i.forEach(e=>{a[e.toolId]=(a[e.toolId]||0)+1,n+=e.creditCharged,l+=e.durationMs});let u=Object.keys(a),c=u.length>0?u.reduce((e,t)=>a[e]>a[t]?e:t):null;return{totalExecutions:i.length,toolsUsed:u,totalCreditsSpent:n,averageExecutionTime:i.length>0?l/i.length:0,mostUsedTool:c}}catch(e){return console.error("Failed to get user tool stats:",e),{totalExecutions:0,toolsUsed:[],totalCreditsSpent:0,averageExecutionTime:0,mostUsedTool:null}}}e.s(["getToolPerformanceStats",()=>a,"getUserToolStats",()=>l,"recordToolMetric",()=>i])},370735,e=>{"use strict";var t=e.i(254799);let r=new Map;function s(e,r){let s=JSON.stringify(r,Object.keys(r||{}).sort()),o=t.default.createHash("sha256").update(`${e}:${s}`).digest("hex").slice(0,16);return`tool:${e}:${o}`}function o(e){let t=r.get(e);return t?Date.now()>t.expiresAt?(r.delete(e),null):(t.hitCount++,t.value):null}function i(e,t,s=3e5){if(r.size>=1e3){let e=Array.from(r.entries());e.sort((e,t)=>e[1].createdAt-t[1].createdAt);let t=Math.ceil(100);for(let s=0;s<t;s++)r.delete(e[s][0])}let o=Date.now();r.set(e,{key:e,value:t,expiresAt:o+s,createdAt:o,hitCount:0})}function a(){let e=0,t=0;return r.forEach(r=>{e+=r.hitCount,t++}),{size:r.size,maxSize:1e3,hitRate:t>0?e/t:0,totalHits:e,totalEntries:t}}function n(e,t){if(t&&"object"==typeof t&&"error"in t)return!1;if(t&&"object"==typeof t){let e=JSON.stringify(t);if([/password/i,/token/i,/secret/i,/key/i,/credential/i,/auth/i].some(t=>t.test(e)))return!1}return["data-studio-schema","data-studio-catalog","cyber-studio-vulnerability-scanner"].includes(e)}e.s(["generateCacheKey",()=>s,"getCacheStats",()=>a,"getCached",()=>o,"setCached",()=>i,"shouldCache",()=>n])},1863,e=>{"use strict";var t=e.i(89171),r=e.i(254799),s=e.i(657194),o=e.i(206761),i=e.i(925820),a=e.i(98085),n=e.i(333248),l=e.i(648389),u=e.i(161857),c=e.i(27315),d=e.i(370735);let h={csp:"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:;",frameOptions:"DENY",contentTypeNosniff:!0,referrerPolicy:"strict-origin-when-cross-origin",permissionsPolicy:"geolocation=(), microphone=(), camera=()",hsts:{maxAge:31536e3,includeSubDomains:!0,preload:!1}};function f(e,t={}){let r={...h,...t};if(r.csp&&e.headers.set("Content-Security-Policy",r.csp),r.frameOptions&&e.headers.set("X-Frame-Options",r.frameOptions),r.contentTypeNosniff&&e.headers.set("X-Content-Type-Options","nosniff"),r.referrerPolicy&&e.headers.set("Referrer-Policy",r.referrerPolicy),r.permissionsPolicy&&e.headers.set("Permissions-Policy",r.permissionsPolicy),r.hsts){let t=`max-age=${r.hsts.maxAge}`;r.hsts.includeSubDomains&&(t+="; includeSubDomains"),r.hsts.preload&&(t+="; preload"),e.headers.set("Strict-Transport-Security",t)}return e.headers.set("X-XSS-Protection","1; mode=block"),e.headers.set("X-DNS-Prefetch-Control","off"),e.headers.set("X-Download-Options","noopen"),e.headers.set("X-Permitted-Cross-Domain-Policies","none"),e}let p={failureThreshold:5,successThreshold:2,timeoutMs:6e4,resetTimeoutMs:3e5},m=new Map;class g{key;options;state;constructor(e,t={}){this.key=e,this.options={...p,...t};const r=m.get(e);this.state=r||{state:"closed",failures:0,successes:0,lastFailureTime:null,nextAttemptTime:null},r||m.set(e,this.state)}async execute(e){if(this.updateState(),"open"===this.state.state)throw new y(`Circuit breaker is open for ${this.key}. Retry after ${this.getRetryAfter()}ms`);try{let t=await e();return this.recordSuccess(),t}catch(e){throw this.recordFailure(),e}}isOpen(){return this.updateState(),"open"===this.state.state}getRetryAfter(){return"open"===this.state.state&&this.state.nextAttemptTime?Math.max(0,this.state.nextAttemptTime-Date.now()):0}getState(){return this.updateState(),this.state.state}getStats(){return this.updateState(),{state:this.state.state,failures:this.state.failures,successes:this.state.successes,lastFailureTime:this.state.lastFailureTime,nextAttemptTime:this.state.nextAttemptTime}}reset(){this.state={state:"closed",failures:0,successes:0,lastFailureTime:null,nextAttemptTime:null},m.set(this.key,this.state)}updateState(){let e=Date.now();this.state.lastFailureTime&&e-this.state.lastFailureTime>this.options.resetTimeoutMs&&(this.state.failures=0,this.state.lastFailureTime=null),"open"===this.state.state&&this.state.nextAttemptTime&&e>=this.state.nextAttemptTime&&(this.state.state="half-open",this.state.successes=0,this.state.nextAttemptTime=null)}recordSuccess(){"half-open"===this.state.state?(this.state.successes++,this.state.successes>=this.options.successThreshold&&(this.state.state="closed",this.state.failures=0,this.state.successes=0)):"closed"===this.state.state&&(this.state.failures=Math.max(0,this.state.failures-1))}recordFailure(){this.state.failures++,this.state.lastFailureTime=Date.now(),"half-open"===this.state.state?(this.state.state="open",this.state.nextAttemptTime=Date.now()+this.options.timeoutMs,this.state.successes=0):"closed"===this.state.state&&this.state.failures>=this.options.failureThreshold&&(this.state.state="open",this.state.nextAttemptTime=Date.now()+this.options.timeoutMs)}}class y extends Error{constructor(e){super(e),this.name="CircuitBreakerOpenError"}}function T(e,t){let r=Date.now(),s=r-e.phaseStartTime;e.phaseDurations[e.phase]=s,e.phase=t,e.phaseStartTime=r}function x(e){e.endTime=Date.now(),e.durationMs=e.endTime-e.startTime,T(e,e.phase)}function E(e,t){let r={requestId:e.requestId,route:`/api/tools/${e.toolId}`},s={toolId:e.toolId,userId:e.userId,durationMs:e.durationMs,phaseDurations:e.phaseDurations,creditEstimate:e.creditEstimate,creditCharged:e.creditCharged,success:t,errorType:e.errorType,errorCode:e.errorCode};t?u.logger.info("tool_execution_completed",r,s):u.logger.error("tool_execution_failed",r,s)}async function w(e,t,r){return Promise.race([e,new Promise((e,s)=>setTimeout(()=>s(Error(`${r} (timeout: ${t}ms)`)),t))])}async function C(e,t,r=100){let s=null;for(let o=0;o<=t;o++)try{return await e()}catch(i){let e=(s=i instanceof Error?i:Error(String(i))).message.toLowerCase();if(e.includes("invalid")||e.includes("not found")||e.includes("unauthorized")||e.includes("forbidden")||e.includes("insufficient")||e.includes("limit exceeded")||o===t)throw s;await new Promise(e=>setTimeout(e,r*(o+1)))}throw s||Error("Retry failed")}function D(e){return async function(h){let{toolId:p,executeTool:m,rateLimitKey:y,rateLimitWindow:D,timeoutMs:S=3e4,enableRetry:_=!1,maxRetries:I=1}=e,R=r.default.randomUUID(),M=Date.now(),O=null,N=null,A=(0,s.rateLimit)(h,{keyPrefix:y||`tool-${p}`,limit:10,windowMs:D||6e4});if(A)return u.logger.warn("rate_limit_exceeded",{requestId:R,route:`/api/tools/${p}`},{toolId:p,ip:h.headers.get("x-forwarded-for")||"unknown"}),A;try{var v,P,F;let e;if(!(0,i.getToolDefinition)(p))return u.logger.error("tool_not_found",{requestId:R,route:`/api/tools/${p}`},{toolId:p}),f(t.NextResponse.json({error:"Tool not found",code:"TOOL_NOT_FOUND",requestId:R},{status:404}));if((0,i.isClientSideOnly)(p))return u.logger.warn("client_side_only_tool",{requestId:R,route:`/api/tools/${p}`},{toolId:p}),f(t.NextResponse.json({error:"This tool runs client-side only",code:"CLIENT_SIDE_ONLY",message:"No server execution needed for this tool",requestId:R},{status:400}));let s=await (0,o.requireAuthForServerTools)(p);if(s instanceof t.NextResponse)return u.logger.warn("auth_required",{requestId:R,route:`/api/tools/${p}`},{toolId:p}),s;v=N=s.userId,e=Date.now(),O={requestId:R,toolId:p,userId:v,startTime:e,phase:"rate_limit",phaseStartTime:e,phaseDurations:{}};let y=await h.json().catch(()=>null),D=(0,d.generateCacheKey)(p,y),A=(0,d.getCached)(D);if(A)return u.logger.info("cache_hit",{requestId:R,route:`/api/tools/${p}`},{toolId:p,userId:N,cacheKey:D}),f(t.NextResponse.json({success:!0,runId:r.default.randomUUID(),requestId:R,result:A,credits:{estimated:0,charged:0,balance:await (0,n.getCreditBalance)(N)},executionTime:Date.now()-M,cached:!0}));if(T(O,"credit_check"),!y||"object"!=typeof y)return O&&(O.errorType="validation",O.errorCode="INVALID_BODY",x(O),E(O,!1)),u.logger.warn("invalid_request_body",{requestId:R,route:`/api/tools/${p}`},{toolId:p}),f(t.NextResponse.json({error:"Invalid request body",code:"INVALID_BODY",requestId:R},{status:400}));let U=await (0,a.estimateCredits)(p,y.requestedLimits);if(!U)return O&&(O.errorType="system",O.errorCode="ESTIMATE_FAILED",x(O),E(O,!1)),u.logger.error("credit_estimate_failed",{requestId:R,route:`/api/tools/${p}`},{toolId:p,userId:N}),f(t.NextResponse.json({error:"Failed to estimate credits",code:"ESTIMATE_FAILED",requestId:R},{status:500}));O&&(O.creditEstimate=U.typical),(0,l.logCreditEvent)({type:"credit_estimate_requested",userId:N,toolId:p,credits:U.typical,metadata:{min:U.min,max:U.max,explanation:U.explanation}});let b=await (0,a.hasSufficientCredits)(N,U.max);if(!b.sufficient)return(0,l.logCreditEvent)({type:"insufficient_credits",userId:N,toolId:p,credits:U.max,balance:b.balance,metadata:{shortfall:b.shortfall}}),f(t.NextResponse.json({error:"Insufficient credits",code:"INSUFFICIENT_CREDITS",balance:b.balance,required:U.max,shortfall:b.shortfall,action:"Purchase credits or upgrade your plan",purchaseUrl:"/account/credits"},{status:402}));let $=await (0,a.getUserSpendLimits)(N),k=await (0,a.validateSpendLimits)(N,U.max,$);if(!k.allowed)return(0,l.logCreditEvent)({type:"spend_limit_exceeded",userId:N,toolId:p,credits:U.max,metadata:{reason:k.reason,limits:$}}),f(t.NextResponse.json({error:"Spend limit exceeded",code:"SPEND_LIMIT_EXCEEDED",reason:k.reason,action:k.action},{status:429}));(0,l.logCreditEvent)({type:"tool_execution_allowed",userId:N,toolId:p,credits:U.typical,metadata:{estimatedMax:U.max}}),T(O,"execution");let j=!1,L={cpuMs:0,memMb:0,durationMs:0},q=null;if(!N)throw Error("User ID is required but was not found");try{let e,r=(P=`tool:${p}`,F={failureThreshold:5,timeoutMs:6e4},new g(P,F)),s=()=>r.execute(()=>w(m(N,y),S,"Tool execution exceeded timeout"));try{e=_?await C(s,I):await s()}catch(e){if("CircuitBreakerOpenError"===e.name)return O&&(O.errorType="system",O.errorCode="CIRCUIT_BREAKER_OPEN",x(O),E(O,!1)),u.logger.warn("circuit_breaker_open",{requestId:R,route:`/api/tools/${p}`},{toolId:p,userId:N}),f(t.NextResponse.json({error:"Service temporarily unavailable",code:"CIRCUIT_BREAKER_OPEN",message:e.message,requestId:R,retryAfter:Math.ceil(r.getRetryAfter()/1e3)},{status:503,headers:{"Retry-After":String(Math.ceil(r.getRetryAfter()/1e3))}}));throw e}q=e.result,L=e.actualUsage,j=e.platformError||!1}catch(r){j=!0;let e=r instanceof Error?r.message:"Unknown error",t=e.includes("timeout");throw O&&(O.errorType=t?"timeout":"execution",O.errorCode=t?"EXECUTION_TIMEOUT":"EXECUTION_FAILED",x(O),(0,c.recordToolMetric)({toolId:p,userId:N,requestId:R,success:!1,durationMs:O.durationMs||Date.now()-M,phaseDurations:O.phaseDurations,creditEstimate:U.typical,creditCharged:0,errorType:O.errorType,errorCode:O.errorCode,timeout:t})),(0,l.logCreditEvent)({type:"tool_execution_failed",userId:N,toolId:p,metadata:{error:e,timeout:t,requestId:R}}),u.logger.error("tool_execution_error",{requestId:R,route:`/api/tools/${p}`},{toolId:p,userId:N,error:e,isTimeout:t}),r}T(O,"charging");let B=(0,a.computeAuthoritativeCharge)(p,L,j),X=r.default.randomUUID();if(O&&(O.creditCharged=B.charge),B.refunded)return O&&(O.errorType="platform",O.errorCode="PLATFORM_ERROR",x(O),E(O,!1)),u.logger.error("platform_error_refund",{requestId:R,route:`/api/tools/${p}`},{toolId:p,userId:N,reason:B.reason}),f(t.NextResponse.json({error:"Platform error",code:"PLATFORM_ERROR",message:B.reason,refunded:!0,requestId:R},{status:500}));if(B.charge>0)try{await (0,n.consumeCredits)(N,B.charge,p,X,{estimated:U.typical,actual:B.charge,usage:L,requestId:R})}catch(e){return O&&(O.errorType="system",O.errorCode="CREDIT_PROCESSING_ERROR",x(O),E(O,!1)),(0,l.logCreditEvent)({type:"tool_execution_failed",userId:N,toolId:p,runId:X,metadata:{error:"Credit processing failed",requestId:R}}),u.logger.error("credit_processing_failed",{requestId:R,route:`/api/tools/${p}`},{toolId:p,userId:N,runId:X,error:e instanceof Error?e.message:"Unknown error"}),f(t.NextResponse.json({error:"Credit processing failed",code:"CREDIT_PROCESSING_ERROR",message:"Your credits were not charged. Please try again.",requestId:R},{status:500}))}let z=await (0,n.getCreditBalance)(N);return(0,l.logCreditEvent)({type:"tool_execution_completed",userId:N,toolId:p,runId:X,credits:B.charge,balance:z,metadata:{usage:L,estimated:U.typical,requestId:R,durationMs:Date.now()-M}}),T(O,"complete"),x(O),E(O,!0),(0,c.recordToolMetric)({toolId:p,userId:N,requestId:R,success:!0,durationMs:O.durationMs,phaseDurations:O.phaseDurations,creditEstimate:U.typical,creditCharged:B.charge}),(0,d.shouldCache)(p,q)&&((0,d.setCached)(D,q,3e5),u.logger.debug("cache_set",{requestId:R,route:`/api/tools/${p}`},{toolId:p,cacheKey:D})),f(t.NextResponse.json({success:!0,runId:X,requestId:R,result:q,credits:{estimated:U.typical,charged:B.charge,balance:z},executionTime:Date.now()-M,metrics:{phaseDurations:O.phaseDurations,totalDuration:O.durationMs}}))}catch(s){let e=s instanceof Error?s.message:"Unknown error",r=s instanceof Error&&s.code?s.code:"INTERNAL_ERROR";return O&&(O.errorType="unhandled",O.errorCode=r,x(O),E(O,!1)),u.logger.error("tool_execution_unhandled_error",{requestId:R,route:`/api/tools/${p}`},{toolId:p,userId:N||"unknown",error:e,errorCode:r}),f(t.NextResponse.json({error:"Internal server error",code:r,message:e,requestId:R},{status:s instanceof Error&&s.status?s.status:500}))}}}e.s(["createToolExecutionHandler",()=>D],1863)}];

//# debugId=f61dc5e5-a9a5-0ac2-28cf-69ea0673bb11
//# sourceMappingURL=src_a52a25c7._.js.map