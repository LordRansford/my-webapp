{
  "version": 3,
  "sources": [],
  "debugId": "5724a34c-c53a-079c-79d5-f338b4183045",
  "sections": [
    {"offset": {"line": 1, "column": 0}, "map": {"version":3,"sources":["../../../src/lib/credits/store.ts","../../../src/lib/credits/deductFromLots.ts","../../../src/lib/billing/estimateRunCost.ts","../../../src/config/computeLimits.ts","../../../src/lib/billing/freeTier.ts","../../../src/lib/billing/creditsConfig.core.js","../../../src/lib/tools/runWithMetering.ts"],"sourcesContent":["import { prisma } from \"@/lib/db/prisma\";\n\nconst DEFAULT_CREDIT_EXPIRY_DAYS = 365 * 2; // 24 months (recommended default)\nconst CREDIT_EXPIRY_DAYS = (() => {\n  const raw = process.env.CREDITS_EXPIRY_DAYS;\n  const n = raw ? Number(raw) : NaN;\n  return Number.isFinite(n) && n > 0 ? Math.floor(n) : DEFAULT_CREDIT_EXPIRY_DAYS;\n})();\n\nfunction addDays(date: Date, days: number) {\n  const d = new Date(date);\n  d.setDate(d.getDate() + days);\n  return d;\n}\n\nexport async function getOrCreateCredits(userId: string) {\n  const existing = await prisma.credits.findUnique({ where: { userId } });\n  if (existing) return existing;\n  return await prisma.credits.create({ data: { userId, balance: 0, expiresAt: null } });\n}\n\nexport async function getCreditsAggregate() {\n  const totalUsersWithCredits = await prisma.credits.count();\n  const sum = await prisma.credits.aggregate({ _sum: { balance: true } });\n  return {\n    totalUsersWithCredits,\n    totalCredits: sum._sum.balance ?? 0,\n  };\n}\n\nexport async function enforceCreditExpiry(userId: string) {\n  const credits = await prisma.credits.findUnique({ where: { userId } });\n  if (!credits) return null;\n  if (!credits.expiresAt) return credits;\n  const now = new Date();\n  if (credits.expiresAt.getTime() > now.getTime()) return credits;\n  // Expired: reset to zero but keep record.\n  return await prisma.credits.update({ where: { userId }, data: { balance: 0 } });\n}\n\nexport async function createCreditUsageEvent(input: {\n  userId: string;\n  toolId: string;\n  consumed: number;\n  units: number;\n  freeUnits: number;\n  paidUnits: number;\n  runId?: string | null;\n  baseFree?: boolean;\n  estimatedCredits?: number;\n  actualCredits?: number;\n  meteringUnit?: string;\n  durationMs?: number;\n  inputBytes?: number;\n  outputBytes?: number;\n  freeTierAppliedMs?: number;\n  paidMs?: number;\n}) {\n  return prisma.creditUsageEvent.create({\n    data: {\n      userId: input.userId,\n      toolId: input.toolId,\n      consumed: input.consumed,\n      units: input.units,\n      freeUnits: input.freeUnits,\n      paidUnits: input.paidUnits,\n      runId: input.runId || null,\n      baseFree: Boolean(input.baseFree),\n      estimatedCredits: Math.max(0, Math.round(Number(input.estimatedCredits) || 0)),\n      actualCredits: Math.max(0, Math.round(Number(input.actualCredits) || 0)),\n      meteringUnit: input.meteringUnit || \"ms\",\n      durationMs: Math.max(0, Math.round(Number(input.durationMs) || 0)),\n      inputBytes: Math.max(0, Math.round(Number(input.inputBytes) || 0)),\n      outputBytes: Math.max(0, Math.round(Number(input.outputBytes) || 0)),\n      freeTierAppliedMs: Math.max(0, Math.round(Number(input.freeTierAppliedMs) || 0)),\n      paidMs: Math.max(0, Math.round(Number(input.paidMs) || 0)),\n    },\n  });\n}\n\nexport async function listCreditUsage(userId: string, limit = 50) {\n  return prisma.creditUsageEvent.findMany({\n    where: { userId },\n    orderBy: { occurredAt: \"desc\" },\n    take: Math.max(1, Math.min(200, limit)),\n  });\n}\n\nexport function computeNewExpiry(from = new Date()) {\n  return addDays(from, CREDIT_EXPIRY_DAYS);\n}\n\nexport async function createCreditLot(input: {\n  userId: string;\n  credits: number;\n  source: string;\n  stripeEventId?: string | null;\n  stripePriceId?: string | null;\n  stripeCheckoutSessionId?: string | null;\n  stripePaymentIntentId?: string | null;\n  expiresAt?: Date | null;\n}) {\n  const credits = Math.max(0, Math.round(Number(input.credits) || 0));\n  return prisma.creditLot.create({\n    data: {\n      userId: input.userId,\n      credits,\n      amountCredits: credits,\n      remainingCredits: credits,\n      source: input.source,\n      stripeEventId: input.stripeEventId || null,\n      stripePriceId: input.stripePriceId || null,\n      stripeCheckoutSessionId: input.stripeCheckoutSessionId || null,\n      stripePaymentIntentId: input.stripePaymentIntentId || null,\n      expiresAt: input.expiresAt || null,\n    },\n  });\n}\n\nexport async function grantCredits(input: {\n  userId: string;\n  credits: number;\n  source: string;\n  stripeEventId?: string | null;\n  stripePriceId?: string | null;\n  stripeCheckoutSessionId?: string | null;\n  stripePaymentIntentId?: string | null;\n}) {\n  const creditsToAdd = Math.max(0, Math.round(Number(input.credits) || 0));\n  if (!creditsToAdd) return { ok: false as const, balance: null as number | null };\n\n  const expiresAt = computeNewExpiry(new Date());\n\n  const result = await prisma.$transaction(async (tx) => {\n    const current = await tx.credits.findUnique({ where: { userId: input.userId } });\n    const currentBalance = current?.balance ?? 0;\n    const nextBalance = currentBalance + creditsToAdd;\n\n    const updated = await tx.credits.upsert({\n      where: { userId: input.userId },\n      update: {\n        balance: nextBalance,\n        // Keep the furthest expiry (simple model; lots are for audit trail).\n        expiresAt: current?.expiresAt && current.expiresAt > expiresAt ? current.expiresAt : expiresAt,\n      },\n      create: {\n        userId: input.userId,\n        balance: nextBalance,\n        expiresAt,\n      },\n    });\n\n    await tx.creditLot.create({\n      data: {\n        userId: input.userId,\n        credits: creditsToAdd,\n        amountCredits: creditsToAdd,\n        remainingCredits: creditsToAdd,\n        source: input.source,\n        stripeEventId: input.stripeEventId || null,\n        stripePriceId: input.stripePriceId || null,\n        stripeCheckoutSessionId: input.stripeCheckoutSessionId || null,\n        stripePaymentIntentId: input.stripePaymentIntentId || null,\n        expiresAt,\n      },\n    });\n\n    return { ok: true as const, balance: updated.balance };\n  });\n\n  return result;\n}\n\n\n","import { prisma } from \"@/lib/db/prisma\";\n\nexport async function deductCreditsFromLots(params: { userId: string; credits: number }) {\n  const creditsToDeduct = Math.max(0, Math.round(Number(params.credits) || 0));\n  if (!creditsToDeduct) return { ok: true as const, remainingBalance: null as number | null };\n\n  return prisma.$transaction(async (tx) => {\n    const userId = params.userId;\n    const creditsRow = await tx.credits.findUnique({ where: { userId } });\n    const balance = creditsRow?.balance ?? 0;\n    if (balance < creditsToDeduct) {\n      return { ok: false as const, remainingBalance: balance };\n    }\n\n    // Prefer earliest expiry first, then oldest purchasedAt.\n    const lots = await tx.creditLot.findMany({\n      where: {\n        userId,\n        OR: [{ remainingCredits: { gt: 0 } }, { remainingCredits: 0, credits: { gt: 0 } }],\n      },\n      orderBy: [{ expiresAt: \"asc\" }, { purchasedAt: \"asc\" }, { createdAt: \"asc\" }],\n      take: 200,\n    });\n\n    let remaining = creditsToDeduct;\n    for (const lot of lots) {\n      if (remaining <= 0) break;\n      const available = Math.max(0, lot.remainingCredits || lot.credits || 0);\n      if (!available) continue;\n      const take = Math.min(available, remaining);\n      remaining -= take;\n      await tx.creditLot.update({\n        where: { id: lot.id },\n        data: {\n          remainingCredits: Math.max(0, available - take),\n          amountCredits: lot.amountCredits && lot.amountCredits > 0 ? lot.amountCredits : lot.credits,\n        },\n      });\n    }\n\n    if (remaining > 0) {\n      return { ok: false as const, remainingBalance: balance };\n    }\n\n    const updated = await tx.credits.update({\n      where: { userId },\n      data: { balance: balance - creditsToDeduct },\n    });\n\n    return { ok: true as const, remainingBalance: updated.balance };\n  });\n}\n\n\n","import { prisma } from \"@/lib/db/prisma\";\nimport { getToolComputeProfile } from \"@/config/computeLimits\";\nimport {\n  CREDIT_MS_PER_1,\n  FREE_TIER_MS_PER_DAY,\n  MAX_RUN_MS_HARD_CAP,\n  MAX_UPLOAD_BYTES_FREE,\n  MAX_UPLOAD_BYTES_PAID,\n} from \"@/lib/billing/creditsConfig\";\nimport { getAnonFreeMsRemainingToday, getUserFreeMsRemainingToday } from \"@/lib/billing/freeTier\";\n\nexport type ComplexityPreset = \"light\" | \"standard\" | \"heavy\";\n\nfunction clampInt(n: unknown, min: number, max: number) {\n  const v = typeof n === \"number\" ? n : Number(n);\n  if (!Number.isFinite(v)) return min;\n  return Math.max(min, Math.min(max, Math.round(v)));\n}\n\nfunction estimateDurationMs(params: { toolId: string; inputBytes: number; preset: ComplexityPreset }) {\n  const profile = getToolComputeProfile(params.toolId);\n  const base = profile ? Math.max(200, profile.typicalSteps * 120) : 600;\n  const inputFactor = profile ? Math.max(0.5, params.inputBytes / Math.max(1, profile.typicalInputBytes)) : Math.max(0.5, params.inputBytes / 1000);\n  const presetFactor = params.preset === \"light\" ? 0.6 : params.preset === \"heavy\" ? 1.8 : 1.0;\n  return clampInt(base * inputFactor * presetFactor, 50, MAX_RUN_MS_HARD_CAP);\n}\n\nexport async function estimateRunCost(params: {\n  req: Request;\n  userId: string | null;\n  toolId: string;\n  inputBytes: number;\n  requestedComplexityPreset: ComplexityPreset;\n}) {\n  const toolId = String(params.toolId || \"\").trim();\n  const inputBytes = clampInt(params.inputBytes, 0, 25_000_000);\n  const preset = params.requestedComplexityPreset;\n\n  const estimatedDurationMs = estimateDurationMs({ toolId, inputBytes, preset });\n\n  if (estimatedDurationMs > MAX_RUN_MS_HARD_CAP) {\n    return {\n      allowed: false as const,\n      reason: \"This run is too large for safety limits. Reduce input size or use a lighter preset.\",\n      estimatedDurationMs,\n      estimatedCredits: 0,\n      freeTierRemainingMs: 0,\n      willChargeCredits: false,\n      requiredCreditsIfAny: 0,\n    };\n  }\n\n  const userId = params.userId;\n  const freeTierRemainingMs = userId ? await getUserFreeMsRemainingToday(userId) : getAnonFreeMsRemainingToday(params.req);\n\n  // Upload hard limits. Anonymous users get smaller cap and cannot go paid.\n  const maxUpload = userId ? MAX_UPLOAD_BYTES_PAID : MAX_UPLOAD_BYTES_FREE;\n  if (inputBytes > maxUpload) {\n    return {\n      allowed: false as const,\n      reason: \"Input is too large for this run. Reduce the size and try again.\",\n      estimatedDurationMs,\n      estimatedCredits: 0,\n      freeTierRemainingMs,\n      willChargeCredits: false,\n      requiredCreditsIfAny: 0,\n    };\n  }\n\n  const paidMsEstimate = Math.max(0, estimatedDurationMs - freeTierRemainingMs);\n  const estimatedCredits = paidMsEstimate > 0 ? Math.ceil(paidMsEstimate / CREDIT_MS_PER_1) : 0;\n  const willChargeCredits = estimatedCredits > 0;\n\n  if (!userId && willChargeCredits) {\n    return {\n      allowed: false as const,\n      reason: \"Sign in to run beyond the free tier. Free usage stays free.\",\n      estimatedDurationMs,\n      estimatedCredits,\n      freeTierRemainingMs,\n      willChargeCredits: true,\n      requiredCreditsIfAny: estimatedCredits,\n    };\n  }\n\n  if (userId && willChargeCredits) {\n    const creditsRow = await prisma.credits.findUnique({ where: { userId } });\n    const balance = creditsRow?.balance ?? 0;\n\n    // Safety buffer so actual runtime spikes don't cause surprise overspend.\n    const buffered = Math.ceil(estimatedCredits * 1.25);\n    if (balance < buffered) {\n      return {\n        allowed: false as const,\n        reason: \"Not enough credits for the expected paid portion. Use a lighter preset or reduce input size.\",\n        estimatedDurationMs,\n        estimatedCredits,\n        freeTierRemainingMs,\n        willChargeCredits: true,\n        requiredCreditsIfAny: buffered,\n      };\n    }\n  }\n\n  return {\n    allowed: true as const,\n    reason: null as string | null,\n    estimatedDurationMs,\n    estimatedCredits,\n    freeTierRemainingMs,\n    willChargeCredits,\n    requiredCreditsIfAny: estimatedCredits,\n    freeTierMsPerDay: FREE_TIER_MS_PER_DAY,\n    creditMsPer1: CREDIT_MS_PER_1,\n  };\n}\n\n\n","export type ComputeClass = \"A\" | \"B\" | \"C\";\n\nexport type ComputeTier = {\n  freeUnitsPerRun: number;\n  freeUnitsPerSession: number;\n  creditUnitsPerCredit: number;\n};\n\n/**\n * Job Runner compute limits (server-side execution).\n *\n * This is separate from UI-oriented compute profiles above. The Job Runner needs\n * hard caps and free-tier accounting in milliseconds, plus per-tool allowlists.\n */\nexport type JobRunnerToolLimits = {\n  toolId: string;\n  maxInputBytesFreeAnon: number;\n  maxInputBytesFreeAuthed: number;\n  maxRunMsHardCap: number;\n  freeMsPerDayAuthed: number;\n  freeMsPerDayAnon: number;\n  creditsPerMsPaid: number;\n  allowAnonymous: boolean;\n  allowAuthed: boolean;\n};\n\nconst SECOND_MS = 1000;\n\nexport const JOB_RUNNER_TOOL_LIMITS: Record<string, JobRunnerToolLimits> = {\n  \"mentor-query\": {\n    toolId: \"mentor-query\",\n    maxInputBytesFreeAnon: 1_000,\n    maxInputBytesFreeAuthed: 6_000,\n    maxRunMsHardCap: 60 * SECOND_MS,\n    freeMsPerDayAuthed: 30 * SECOND_MS,\n    freeMsPerDayAnon: 8 * SECOND_MS,\n    creditsPerMsPaid: 1 / (10 * SECOND_MS), // 1 credit per 10s paid\n    allowAnonymous: true,\n    allowAuthed: true,\n  },\n  \"whois-summary\": {\n    toolId: \"whois-summary\",\n    maxInputBytesFreeAnon: 300,\n    maxInputBytesFreeAuthed: 2_000,\n    maxRunMsHardCap: 20 * SECOND_MS,\n    freeMsPerDayAuthed: 60 * SECOND_MS,\n    freeMsPerDayAnon: 15 * SECOND_MS,\n    creditsPerMsPaid: 1 / (20 * SECOND_MS), // 1 credit per 20s paid\n    allowAnonymous: true,\n    allowAuthed: true,\n  },\n  \"templates-request-download\": {\n    toolId: \"templates-request-download\",\n    maxInputBytesFreeAnon: 600,\n    maxInputBytesFreeAuthed: 2_000,\n    maxRunMsHardCap: 30 * SECOND_MS,\n    freeMsPerDayAuthed: 20 * SECOND_MS,\n    freeMsPerDayAnon: 0,\n    creditsPerMsPaid: 1 / (10 * SECOND_MS),\n    allowAnonymous: false,\n    allowAuthed: true,\n  },\n  \"sandbox-echo\": {\n    toolId: \"sandbox-echo\",\n    maxInputBytesFreeAnon: 2_000,\n    maxInputBytesFreeAuthed: 10_000,\n    maxRunMsHardCap: 15 * SECOND_MS,\n    freeMsPerDayAuthed: 20 * SECOND_MS,\n    freeMsPerDayAnon: 10 * SECOND_MS,\n    creditsPerMsPaid: 1 / (10 * SECOND_MS),\n    allowAnonymous: true,\n    allowAuthed: true,\n  },\n  \"code-runner\": {\n    toolId: \"code-runner\",\n    maxInputBytesFreeAnon: 6_500,\n    maxInputBytesFreeAuthed: 6_500,\n    maxRunMsHardCap: 8 * SECOND_MS,\n    freeMsPerDayAuthed: 20 * SECOND_MS,\n    freeMsPerDayAnon: 10 * SECOND_MS,\n    creditsPerMsPaid: 1 / (10 * SECOND_MS),\n    allowAnonymous: true,\n    allowAuthed: true,\n  },\n};\n\nexport function getJobRunnerToolLimits(toolId: string): JobRunnerToolLimits | null {\n  return JOB_RUNNER_TOOL_LIMITS[toolId] || null;\n}\n\nexport type ToolFileLimits = {\n  freeMaxBytes: number;\n  paidMaxBytes: number;\n  absoluteMaxBytes: number;\n};\n\nexport type ToolComputeProfile = {\n  toolId: string;\n  label: string;\n  computeClass: ComputeClass;\n  typicalInputBytes: number;\n  typicalSteps: number;\n  fileLimits?: ToolFileLimits;\n  guidance: string[];\n  scenarios?: Array<{\n    title: string;\n    estimateNote: string;\n    mediumRunsPerTenCredits?: number;\n    largeRunCredits?: number;\n    browserOnlyCostsZero?: boolean;\n  }>;\n};\n\n// These are \"compute units\", not money. The UI should describe them as an estimate.\n// We keep the free tier slightly below typical browser tolerance to avoid freezes on weaker devices.\nexport const COMPUTE_TIER: ComputeTier = {\n  freeUnitsPerRun: 7_500,\n  freeUnitsPerSession: 30_000,\n  creditUnitsPerCredit: 25_000,\n};\n\nconst MB = 1024 * 1024;\n\nexport const TOOL_COMPUTE_PROFILES: Record<string, ToolComputeProfile> = {\n  // Security dashboards (server-assisted, bounded).\n  \"dns-email-security-dashboard\": {\n    toolId: \"dns-email-security-dashboard\",\n    label: \"DNS email security\",\n    computeClass: \"B\",\n    typicalInputBytes: 120,\n    typicalSteps: 1,\n    guidance: [\"Shorter inputs reduce retries.\", \"Repeated checks of the same domain usually add little value. Try a different domain or a different tool.\"],\n    scenarios: [{ title: \"Typical runs\", estimateNote: \"Most runs are small and fit in the free tier.\", mediumRunsPerTenCredits: 120, browserOnlyCostsZero: false }],\n  },\n  \"https-redirect-checker\": {\n    toolId: \"https-redirect-checker\",\n    label: \"HTTPS redirect checker\",\n    computeClass: \"B\",\n    typicalInputBytes: 200,\n    typicalSteps: 6,\n    guidance: [\"Short redirect chains cost less.\", \"If you only need the final destination, do one check per key entry page.\"],\n    scenarios: [{ title: \"Redirect chains\", estimateNote: \"Costs rise with chain length.\", mediumRunsPerTenCredits: 80 }],\n  },\n  \"website-security-lab\": {\n    toolId: \"website-security-lab\",\n    label: \"Website security lab\",\n    computeClass: \"B\",\n    typicalInputBytes: 240,\n    typicalSteps: 6,\n    guidance: [\"Test one representative URL per site, then expand.\", \"Avoid long redirect chains or many subpaths unless needed.\"],\n  },\n  \"email-header-phishing-lab\": {\n    toolId: \"email-header-phishing-lab\",\n    label: \"Email header lab\",\n    computeClass: \"B\",\n    typicalInputBytes: 6_000,\n    typicalSteps: 1,\n    guidance: [\"Paste headers only, not the message body.\", \"Trim the header block to the relevant hops if it is extremely long.\"],\n  },\n  \"phishing-link-explainer\": {\n    toolId: \"phishing-link-explainer\",\n    label: \"Phishing link explainer\",\n    computeClass: \"B\",\n    typicalInputBytes: 300,\n    typicalSteps: 2,\n    guidance: [\"Short URLs and fewer redirects reduce work.\", \"Run a second check only if the context changed.\"],\n  },\n  \"third-party-script-viewer\": {\n    toolId: \"third-party-script-viewer\",\n    label: \"Third party script viewer\",\n    computeClass: \"B\",\n    typicalInputBytes: 200,\n    typicalSteps: 4,\n    guidance: [\"Use one representative page per application area.\", \"Focus on scripts that run on authenticated pages first.\"],\n  },\n\n  // API tools (server assisted).\n  \"dns-lookup\": { toolId: \"dns-lookup\", label: \"DNS lookup\", computeClass: \"B\", typicalInputBytes: 120, typicalSteps: 1, guidance: [\"Use one hostname at a time.\"] },\n  \"tls-inspect\": { toolId: \"tls-inspect\", label: \"TLS inspect\", computeClass: \"B\", typicalInputBytes: 120, typicalSteps: 1, guidance: [\"Use a hostname rather than an IP.\", \"Retry only after you confirm the service is up.\"] },\n  \"whois-summary\": { toolId: \"whois-summary\", label: \"WHOIS summary\", computeClass: \"B\", typicalInputBytes: 120, typicalSteps: 1, guidance: [\"Compare results with context and expected registrant.\"] },\n  \"ip-reputation\": { toolId: \"ip-reputation\", label: \"IP reputation\", computeClass: \"B\", typicalInputBytes: 60, typicalSteps: 1, guidance: [\"Combine with logs and behavioural indicators.\"] },\n\n  // Mentor (server assisted, bounded).\n  \"mentor-query\": {\n    toolId: \"mentor-query\",\n    label: \"Mentor\",\n    computeClass: \"B\",\n    typicalInputBytes: 2_000,\n    typicalSteps: 6,\n    guidance: [\"Ask one focused question at a time.\", \"Include the page link so the match is tighter.\", \"Shorter questions usually respond faster.\"],\n  },\n\n  // Template access evaluation (server assisted, bounded).\n  \"templates-request-download\": {\n    toolId: \"templates-request-download\",\n    label: \"Template download request\",\n    computeClass: \"B\",\n    typicalInputBytes: 800,\n    typicalSteps: 3,\n    guidance: [\"Choose one template at a time.\", \"Keep the requested use clear and short.\"],\n  },\n\n  // AI Studio (Model Forge): local training but metered for predictable limits and future paid tiers.\n  \"model-forge-train\": {\n    toolId: \"model-forge-train\",\n    label: \"Model Forge training\",\n    computeClass: \"B\",\n    typicalInputBytes: 250_000,\n    typicalSteps: 200,\n    fileLimits: { freeMaxBytes: 350 * 1024, paidMaxBytes: 2 * MB, absoluteMaxBytes: 4 * MB },\n    guidance: [\"Start with fewer rows and fewer epochs.\", \"Try one target column at a time.\", \"Avoid high-cardinality text columns in a tabular demo.\"],\n    scenarios: [\n      { title: \"Small CSV\", estimateNote: \"A small CSV with light training usually fits in the free tier.\", mediumRunsPerTenCredits: 40 },\n      { title: \"Bigger dataset\", estimateNote: \"Larger datasets and more iterations can exceed the free tier.\", largeRunCredits: 2 },\n    ],\n  },\n\n  // Software Development Studio: trade-off simulator is local-first and low compute by default.\n  \"software-tradeoff-sim\": {\n    toolId: \"software-tradeoff-sim\",\n    label: \"Engineering trade-off simulator\",\n    computeClass: \"A\",\n    typicalInputBytes: 400,\n    typicalSteps: 50,\n    guidance: [\"Keep constraints realistic.\", \"Change one variable at a time so you can explain causality.\", \"Write down the decision rule you are using.\"],\n  },\n\n  // Data and Digitalisation Studio: lightweight governance-led simulators (local only).\n  \"data-roadmap-sim\": {\n    toolId: \"data-roadmap-sim\",\n    label: \"Data and digitalisation roadmap simulator\",\n    computeClass: \"A\",\n    typicalInputBytes: 600,\n    typicalSteps: 60,\n    guidance: [\"Keep the first pass simple: purpose, owners, and controls.\", \"Improve quality at source before building bigger dashboards.\", \"Write down your decision rule.\"],\n  },\n\n  // Cybersecurity Studio: lightweight risk/control mapping simulator (local).\n  \"cyber-risk-sim\": {\n    toolId: \"cyber-risk-sim\",\n    label: \"Cyber risk mapping simulator\",\n    computeClass: \"A\",\n    typicalInputBytes: 700,\n    typicalSteps: 70,\n    guidance: [\"Start with one asset and one realistic threat.\", \"Pick controls you can operate and measure.\", \"Write the acceptance criteria for residual risk.\"],\n  },\n\n  // Responsible AI Studio: lightweight, illustrative tools (local only).\n  \"ai-prompt-compare\": {\n    toolId: \"ai-prompt-compare\",\n    label: \"Prompt comparison playground\",\n    computeClass: \"A\",\n    typicalInputBytes: 2_000,\n    typicalSteps: 40,\n    guidance: [\"Compare small prompt changes only.\", \"Write what success looks like before you run.\", \"Treat results as illustrative, not definitive.\"],\n  },\n  \"ai-consistency-test\": {\n    toolId: \"ai-consistency-test\",\n    label: \"Output consistency tester\",\n    computeClass: \"A\",\n    typicalInputBytes: 2_500,\n    typicalSteps: 80,\n    guidance: [\"Run a few samples first, then increase.\", \"Separate prompt quality from model randomness.\", \"Log both the prompt and the settings.\"],\n  },\n  \"ai-bias-sim\": {\n    toolId: \"ai-bias-sim\",\n    label: \"Bias scenario explorer\",\n    computeClass: \"A\",\n    typicalInputBytes: 1_500,\n    typicalSteps: 90,\n    guidance: [\"Bias often comes from data and labels, not intent.\", \"Check base rates before blaming the model.\", \"Always define who is harmed by errors.\"],\n  },\n  \"ai-behaviour-compare\": {\n    toolId: \"ai-behaviour-compare\",\n    label: \"Model behaviour comparison (simulated)\",\n    computeClass: \"A\",\n    typicalInputBytes: 2_200,\n    typicalSteps: 70,\n    guidance: [\"Compare behaviours, not vibes.\", \"Look for quiet failures and edge cases.\", \"Decide when not to use AI.\"],\n  },\n\n  // AI Studio project compute demos (server metered, deterministic).\n  \"ai-story-generator\": {\n    toolId: \"ai-story-generator\",\n    label: \"Story generator (safe demo)\",\n    computeClass: \"A\",\n    typicalInputBytes: 160,\n    typicalSteps: 40,\n    guidance: [\"Keep prompts short for cheaper runs.\", \"Add detail gradually.\", \"Use child-friendly language for child projects.\"],\n  },\n  \"ai-homework-helper\": {\n    toolId: \"ai-homework-helper\",\n    label: \"Homework helper (safe demo)\",\n    computeClass: \"A\",\n    typicalInputBytes: 220,\n    typicalSteps: 55,\n    guidance: [\"Write the exact equation if possible.\", \"Ask for steps, not just answers.\", \"Check the final answer by substitution.\"],\n  },\n  \"ai-support-bot\": {\n    toolId: \"ai-support-bot\",\n    label: \"Support bot (safe demo)\",\n    computeClass: \"A\",\n    typicalInputBytes: 220,\n    typicalSteps: 55,\n    guidance: [\"Keep one intent per message (return/refund/delivery).\", \"Avoid sensitive personal data in demos.\", \"Save strong replies as templates.\"],\n  },\n\n  \"studio-help-assistant\": {\n    toolId: \"studio-help-assistant\",\n    label: \"Studios help assistant\",\n    computeClass: \"A\",\n    typicalInputBytes: 420,\n    typicalSteps: 70,\n    guidance: [\"Ask one clear question at a time.\", \"Paste your requirements to tailor examples.\", \"Use the light preset for cheaper runs.\"],\n  },\n};\n\nexport function getToolComputeProfile(toolId?: string | null): ToolComputeProfile | null {\n  if (!toolId) return null;\n  return TOOL_COMPUTE_PROFILES[toolId] || null;\n}\n\nexport function getToolFileLimits(toolId?: string | null): ToolFileLimits | null {\n  const p = getToolComputeProfile(toolId);\n  return p?.fileLimits || null;\n}\n\nexport function formatBytes(bytes: number) {\n  if (!Number.isFinite(bytes) || bytes <= 0) return \"0 B\";\n  if (bytes < 1024) return `${Math.round(bytes)} B`;\n  if (bytes < MB) return `${Math.round(bytes / 1024)} KB`;\n  return `${(bytes / MB).toFixed(1)} MB`;\n}\n\n\n","import crypto from \"node:crypto\";\nimport { prisma } from \"@/lib/db/prisma\";\nimport { FREE_TIER_MS_PER_DAY } from \"@/lib/billing/creditsConfig\";\n\nfunction startOfDayUtc(d = new Date()) {\n  const x = new Date(d);\n  x.setUTCHours(0, 0, 0, 0);\n  return x;\n}\n\nexport async function getUserFreeMsUsedToday(userId: string): Promise<number> {\n  const since = startOfDayUtc();\n  const rows = await prisma.creditUsageEvent.findMany({\n    where: { userId, occurredAt: { gte: since } },\n    select: { freeTierAppliedMs: true },\n    take: 10_000,\n  });\n  return rows.reduce((sum, r) => sum + (Number(r.freeTierAppliedMs) || 0), 0);\n}\n\nexport async function getUserFreeMsRemainingToday(userId: string): Promise<number> {\n  const used = await getUserFreeMsUsedToday(userId);\n  return Math.max(0, FREE_TIER_MS_PER_DAY - used);\n}\n\n// Anonymous free tier tracker: in-memory, ephemeral, TTL.\ntype Bucket = { usedMs: number; resetAt: number };\nconst anonBuckets = new Map<string, Bucket>();\n\nfunction hash(value: string) {\n  return crypto.createHash(\"sha256\").update(value).digest(\"hex\").slice(0, 24);\n}\n\nexport function getAnonKey(req: Request) {\n  const forwarded = req.headers.get(\"x-forwarded-for\") || \"\";\n  const ip = forwarded.split(\",\")[0]?.trim() || req.headers.get(\"x-real-ip\") || \"unknown\";\n  const ua = req.headers.get(\"user-agent\") || \"unknown\";\n  return hash(`${ip}|${ua}`);\n}\n\nexport function getAnonFreeMsRemainingToday(req: Request): number {\n  const now = Date.now();\n  const key = getAnonKey(req);\n  const dayReset = startOfDayUtc(new Date(now + 24 * 60 * 60 * 1000)).getTime(); // next UTC midnight\n  const existing = anonBuckets.get(key);\n  if (!existing || existing.resetAt <= now) {\n    anonBuckets.set(key, { usedMs: 0, resetAt: dayReset });\n    return FREE_TIER_MS_PER_DAY;\n  }\n  return Math.max(0, FREE_TIER_MS_PER_DAY - existing.usedMs);\n}\n\nexport function addAnonUsageMs(req: Request, durationMs: number) {\n  const now = Date.now();\n  const key = getAnonKey(req);\n  const dayReset = startOfDayUtc(new Date(now + 24 * 60 * 60 * 1000)).getTime();\n  const existing = anonBuckets.get(key);\n  if (!existing || existing.resetAt <= now) {\n    anonBuckets.set(key, { usedMs: Math.max(0, Math.round(durationMs)), resetAt: dayReset });\n    return;\n  }\n  existing.usedMs += Math.max(0, Math.round(durationMs));\n}\n\n\n","function intFromEnv(name, fallback) {\n  const raw = process.env[name];\n  const n = raw ? Number(raw) : NaN;\n  return Number.isFinite(n) && n >= 0 ? Math.floor(n) : fallback;\n}\n\nexport const FREE_TIER_MS_PER_DAY = intFromEnv(\"FREE_TIER_MS_PER_DAY\", 60_000);\nexport const CREDIT_MS_PER_1 = intFromEnv(\"CREDIT_MS_PER_1\", 10_000);\nexport const MAX_RUN_MS_HARD_CAP = intFromEnv(\"MAX_RUN_MS_HARD_CAP\", 300_000);\nexport const MAX_UPLOAD_BYTES_FREE = intFromEnv(\"MAX_UPLOAD_BYTES_FREE\", 300 * 1024);\nexport const MAX_UPLOAD_BYTES_PAID = intFromEnv(\"MAX_UPLOAD_BYTES_PAID\", 2 * 1024 * 1024);\n\n\n","import crypto from \"node:crypto\";\nimport { prisma } from \"@/lib/db/prisma\";\nimport { estimateRunCost, type ComplexityPreset } from \"@/lib/billing/estimateRunCost\";\nimport { CREDIT_MS_PER_1, MAX_RUN_MS_HARD_CAP } from \"@/lib/billing/creditsConfig\";\nimport { addAnonUsageMs, getAnonFreeMsRemainingToday, getUserFreeMsRemainingToday } from \"@/lib/billing/freeTier\";\nimport { deductCreditsFromLots } from \"@/lib/credits/deductFromLots\";\nimport { createCreditUsageEvent, getOrCreateCredits } from \"@/lib/credits/store\";\nimport { getToolComputeProfile } from \"@/config/computeLimits\";\nimport type { UnifiedRunReceipt } from \"@/lib/compute/receipts\";\n\nexport type RunReceipt = UnifiedRunReceipt;\n\nfunction nowMs() {\n  return Date.now();\n}\n\nfunction safeInt(n: unknown) {\n  const v = typeof n === \"number\" ? n : Number(n);\n  return Number.isFinite(v) ? Math.max(0, Math.round(v)) : 0;\n}\n\nexport async function runWithMetering<T>(params: {\n  req: Request;\n  userId: string | null;\n  toolId: string;\n  inputBytes: number;\n  requestedComplexityPreset: ComplexityPreset;\n  execute: () => Promise<{ output: T; outputBytes?: number }>;\n}): Promise<{ ok: true; receipt: RunReceipt; output: T } | { ok: false; status: number; message: string; estimate: any }> {\n  const runId = crypto.randomUUID();\n  const toolId = String(params.toolId || \"\").trim();\n  const inputBytes = safeInt(params.inputBytes);\n\n  const estimate = await estimateRunCost({\n    req: params.req,\n    userId: params.userId,\n    toolId,\n    inputBytes,\n    requestedComplexityPreset: params.requestedComplexityPreset,\n  });\n\n  if (!estimate.allowed) {\n    return { ok: false, status: 400, message: estimate.reason || \"Run not allowed\", estimate };\n  }\n\n  // Establish free tier remaining at start for deterministic accounting.\n  const freeTierRemainingAtStart = params.userId\n    ? await getUserFreeMsRemainingToday(params.userId)\n    : getAnonFreeMsRemainingToday(params.req);\n\n  if (estimate.willChargeCredits && !params.userId) {\n    return { ok: false, status: 401, message: \"Sign in required for runs above the free tier.\", estimate };\n  }\n\n  // Execute tool\n  const start = nowMs();\n  const result = await params.execute();\n  const durationMs = Math.min(MAX_RUN_MS_HARD_CAP, Math.max(0, nowMs() - start));\n\n  const outputBytes = safeInt(result.outputBytes);\n  const freeTierAppliedMs = Math.min(durationMs, freeTierRemainingAtStart);\n  const paidMs = Math.max(0, durationMs - freeTierAppliedMs);\n  const creditsCharged = paidMs > 0 ? Math.ceil(paidMs / CREDIT_MS_PER_1) : 0;\n\n  const profile = getToolComputeProfile(toolId);\n  const guidanceTips = profile?.guidance?.slice(0, 4) || [\n    \"Reduce input size.\",\n    \"Use the light preset.\",\n    \"Limit iterations or scope.\",\n    \"Use sampling for large datasets.\",\n  ];\n\n  if (!params.userId) {\n    // Anonymous: record ephemeral usage only.\n    addAnonUsageMs(params.req, freeTierAppliedMs);\n    const receipt: RunReceipt = {\n      runId,\n      toolId,\n      mode: \"compute\",\n      durationMs,\n      inputBytes,\n      outputBytes,\n      freeTierAppliedMs,\n      paidMs: 0,\n      creditsCharged: 0,\n      remainingCredits: null,\n      guidanceTips,\n    };\n    return { ok: true, receipt, output: result.output };\n  }\n\n  const userId = params.userId;\n  await getOrCreateCredits(userId);\n\n  let remainingCredits: number | null = null;\n\n  // Append-only usage ledger: always write a CreditUsageEvent. Deduct credits transactionally when needed.\n  if (creditsCharged > 0) {\n    const deducted = await deductCreditsFromLots({ userId, credits: creditsCharged });\n    if (!deducted.ok) {\n      // No partial charges; treat as not allowed.\n      return {\n        ok: false,\n        status: 402,\n        message: \"Insufficient credits for the paid portion. Use a lighter preset or reduce input size.\",\n        estimate,\n      };\n    }\n    remainingCredits = deducted.remainingBalance;\n  } else {\n    const row = await prisma.credits.findUnique({ where: { userId } });\n    remainingCredits = row?.balance ?? 0;\n  }\n\n  await createCreditUsageEvent({\n    userId,\n    toolId,\n    consumed: creditsCharged,\n    units: durationMs,\n    freeUnits: freeTierAppliedMs,\n    paidUnits: paidMs,\n    runId,\n    baseFree: creditsCharged === 0,\n    estimatedCredits: estimate.estimatedCredits || 0,\n    actualCredits: creditsCharged,\n    meteringUnit: \"ms\",\n    durationMs,\n    inputBytes,\n    outputBytes,\n    freeTierAppliedMs,\n    paidMs,\n  });\n\n  const receipt: RunReceipt = {\n    runId,\n    toolId,\n    mode: \"compute\",\n    durationMs,\n    inputBytes,\n    outputBytes,\n    freeTierAppliedMs,\n    paidMs,\n    creditsCharged,\n    remainingCredits,\n    guidanceTips,\n  };\n\n  return { ok: true, receipt, output: result.output };\n}\n\n\n"],"names":[],"mappings":"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"}}]
}