;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="bea1d68b-f63c-c4fd-53b9-9b4a6c5c9ac6")}catch(e){}}();
module.exports=[814747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},522734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},8018,e=>{"use strict";var t=e.i(822880);let r=process.env.STRIPE_SECRET_KEY,a=null;function s(){if(a)return a;let e=r||"sk_test_dummy";if(e.startsWith("sk_live"))throw Error("Live Stripe keys are not allowed. Use test keys only.");return a=new t.default(e,{apiVersion:"2025-12-15.clover"})}e.s(["getStripeClient",()=>s])},896241,e=>{"use strict";function t(){if("true"!==process.env.STRIPE_ENABLED)return null;let e=process.env.STRIPE_SECRET_KEY||"",t=process.env.STRIPE_WEBHOOK_SECRET||"",r=process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY||"",a=process.env.STRIPE_DONATION_PRODUCT_ID;return{secretKey:e,webhookSecret:t,publishableKey:r,donationProductId:a,donationPriceIds:process.env.STRIPE_DONATION_PRICE_IDS?process.env.STRIPE_DONATION_PRICE_IDS.split(",").map(e=>e.trim()).filter(Boolean):void 0}}e.s(["getStripeEnv",()=>t])},196037,e=>{"use strict";var t=e.i(954116),r=e.i(206761),a=e.i(8018),s=e.i(896241),i=e.i(333248),n=e.i(648389);async function o(e){let i=await (0,r.getUserIdFromSession)();if(!i)return{error:"Authentication required",code:"AUTH_REQUIRED"};let o=t.CREDIT_PACKS.find(t=>t.id===e);if(!o)return{error:"Credit pack not found",code:"PACK_NOT_FOUND"};if(!(0,s.getStripeEnv)()){let t=`checkout_${Date.now()}_${i}`,r=`/account/credits/checkout?session=${t}&pack=${e}`;return{sessionId:t,url:r,packId:o.id,credits:o.credits,price:o.price}}try{let e=(0,a.getStripeClient)(),t=process.env.NEXT_PUBLIC_BASE_URL||process.env.VERCEL_URL?`https://${process.env.VERCEL_URL}`:"http://localhost:3000";(0,n.logCreditEvent)({type:"credit_purchase_initiated",userId:i,credits:o.credits,metadata:{packId:o.id,price:o.price}});let r=await e.checkout.sessions.create({mode:"payment",payment_method_types:["card"],line_items:[{price_data:{currency:"gbp",product_data:{name:`${o.label} Credit Pack`,description:`${o.credits.toLocaleString()} credits`},unit_amount:Math.round(100*o.price)},quantity:1}],metadata:{userId:i,packId:o.id,credits:o.credits.toString(),type:"credit_purchase"},success_url:`${t}/account/credits/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${t}/account/credits?canceled=true`,customer_email:void 0});return{sessionId:r.id,url:r.url||`${t}/account/credits`,packId:o.id,credits:o.credits,price:o.price}}catch(e){return console.error("Stripe checkout session creation failed:",e),{error:"Failed to create checkout session",code:"CHECKOUT_FAILED"}}}async function d(e){let t=e.metadata?.userId,r=e.metadata?.packId,a=e.metadata?.credits;if(!t||!r||!a)return{success:!1,error:"Missing required metadata in checkout session"};let s=parseInt(a,10);if(isNaN(s)||s<=0)return{success:!1,error:"Invalid credits amount in metadata"};try{let a=await (0,i.addCredits)(t,s,"purchase",{packId:r,stripeSessionId:e.id,amountPaid:e.amount_total?e.amount_total/100:void 0});if(a.success)return(0,n.logCreditEvent)({type:"credit_purchase_completed",userId:t,credits:s,balance:a.newBalance,metadata:{packId:r,stripeSessionId:e.id}}),{success:!0,creditsGranted:s};return(0,n.logCreditEvent)({type:"credit_purchase_failed",userId:t,metadata:{packId:r,stripeSessionId:e.id,error:"Failed to grant credits"}}),{success:!1,error:"Failed to grant credits"}}catch(a){return console.error("Credit purchase webhook processing failed:",a),(0,n.logCreditEvent)({type:"credit_purchase_failed",userId:t,metadata:{packId:r,stripeSessionId:e.id,error:a instanceof Error?a.message:"Unknown error"}}),{success:!1,error:a instanceof Error?a.message:"Unknown error"}}}e.s(["createCheckoutSession",()=>o,"handleCreditPurchaseWebhook",()=>d])},951743,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),s=e.i(759756),i=e.i(561916),n=e.i(114444),o=e.i(837092),d=e.i(869741),c=e.i(316795),l=e.i(487718),u=e.i(995169),p=e.i(47587),h=e.i(666012),E=e.i(570101),f=e.i(626937),_=e.i(10372),m=e.i(193695);e.i(52474);var R=e.i(600220),v=e.i(89171),I=e.i(822880),w=e.i(124594),g=e.i(967291),y=e.i(196037);async function C(e){let t=process.env.STRIPE_SECRET_KEY||"",r=process.env.STRIPE_WEBHOOK_SECRET||"";if(!t||!r)return new v.NextResponse("ok",{status:200});let a=new I.default(t),s=await e.text(),i=e.headers.get("stripe-signature");(0,g.logInfo)("stripe.webhook.received",{hasSignature:!!i,requestId:e.headers.get("x-request-id")||null});let n={type:"unknown"};try{n=a.webhooks.constructEvent(s,i||"",r)}catch{}"unknown"===n.type?(0,g.logWarn)("stripe.webhook.unverified",{hasSignature:!!i}):(0,g.logInfo)("stripe.webhook.verified",{type:String(n.type||"unknown")});try{let e=n;if(e?.id&&"string"==typeof e.id){let t=w.prisma.stripeWebhookEvent;await t.create({data:{stripeEventId:e.id,eventType:String(e.type||"unknown"),receivedAt:new Date}})}}catch{}if("checkout.session.completed"===n.type&&"data"in n){let e=n.data.object;if("credit_purchase"===("string"==typeof e.metadata?.type?e.metadata.type:""))try{let t=await (0,y.handleCreditPurchaseWebhook)({id:e.id,metadata:e.metadata||{},amount_total:e.amount_total||void 0});t.success?(0,g.logInfo)("stripe.credit_purchase.completed",{userId:e.metadata?.userId||null,credits:t.creditsGranted||0,sessionId:e.id}):(0,g.logWarn)("stripe.credit_purchase.failed",{userId:e.metadata?.userId||null,error:t.error||"Unknown error",sessionId:e.id})}catch(t){(0,g.logWarn)("stripe.credit_purchase.error",{error:t instanceof Error?t.message:"Unknown error",sessionId:e.id})}}if("checkout.session.completed"!==n.type)return new v.NextResponse("ok",{status:200});let o=w.prisma.certificateEntitlement,d=w.prisma.purchase;if(await d.findUnique({where:{stripeEventId:n.id}}))return new v.NextResponse("ok",{status:200});let c=n.data.object,l="string"==typeof c.metadata?.userId?c.metadata.userId:"",u="string"==typeof c.metadata?.type?c.metadata.type:"",p="string"==typeof c.metadata?.courseId?c.metadata.courseId:"";if("certificate"===u&&c.id){try{let e=await o.findFirst({where:{stripeSessionId:c.id}});e&&"eligible"!==e.status&&"issued"!==e.status&&await o.update({where:{id:e.id},data:{status:"eligible"}});let t=w.prisma.auditEvent;await t.create({data:{actorUserId:e?.userId||null,action:"CERT_PAYMENT_CONFIRMED",entityType:"certificate",entityId:e?.id||null,details:{courseId:e?.courseId||p||null,stripeSessionId:c.id},ip:null,userAgent:null}})}catch{}return new v.NextResponse("ok",{status:200})}let h="string"==typeof c.metadata?.productId?c.metadata.productId:"";if(!l||!h||!c.id)return new v.NextResponse("ok",{status:200});try{await d.create({data:{userId:l,productId:h,stripeSessionId:c.id,stripeEventId:n.id,status:"paid"}})}catch(e){e?.code}return new v.NextResponse("ok",{status:200})}e.s(["POST",()=>C],250842);var S=e.i(250842);let k=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/stripe/webhook/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:T,workUnitAsyncStorage:P,serverHooks:x}=k;function b(){return(0,a.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:P})}async function N(e,t,a){k.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/stripe/webhook/route";v=v.replace(/\/index$/,"")||"/";let I=await k.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!I)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:g,nextConfig:y,parsedUrl:C,isDraftMode:S,prerenderManifest:T,routerServerContext:P,isOnDemandRevalidate:x,revalidateOnlyGenerated:b,resolvedPathname:N,clientReferenceManifest:A,serverActionsManifest:O}=I,U=(0,d.normalizeAppPath)(v),D=!!(T.dynamicRoutes[U]||T.routes[N]),q=async()=>((null==P?void 0:P.render404)?await P.render404(e,t,C,!1):t.end("This page could not be found"),null);if(D&&!S){let e=!!T.routes[N],t=T.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await q();throw new m.NoFallbackError}}let H=null;!D||k.isDev||S||(H="/index"===(H=N)?"/":H);let M=!0===k.isDev||!D,$=D&&!M;O&&A&&(0,n.setReferenceManifestsSingleton)({page:v,clientReferenceManifest:A,serverActionsManifest:O,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:O})});let K=e.method||"GET",L=(0,i.getTracer)(),F=L.getActiveScopeSpan(),B={params:g,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>k.onRequestError(e,t,a,P)},sharedContext:{buildId:w}},j=new c.NodeNextRequest(e),W=new c.NodeNextResponse(t),V=l.NextRequestAdapter.fromNodeNextRequest(j,(0,l.signalFromNodeResponse)(t));try{let n=async e=>k.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${K} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${K} ${v}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var i,d;let c=async({previousCacheEntry:r})=>{try{if(!o&&x&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await n(s);e.fetchMetrics=B.renderOpts.fetchMetrics;let d=B.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let c=B.renderOpts.collectedTags;if(!D)return await (0,h.sendResponse)(j,W,i,B.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(i.headers);c&&(t[_.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,a=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:x})},P),t}},l=await k.handleResponse({req:e,nextConfig:y,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:b,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!D)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",x?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,E.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&D||u.delete(_.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(j,W,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};F?await d(F):await L.withPropagatedContext(e.headers,()=>L.trace(u.BaseServerSpan.handleRequest,{spanName:`${K} ${v}`,kind:i.SpanKind.SERVER,attributes:{"http.method":K,"http.target":e.url}},d))}catch(t){if(t instanceof m.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:x})}),D)throw t;return await (0,h.sendResponse)(j,W,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>b,"routeModule",()=>k,"serverHooks",()=>x,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>P],951743)},118191,e=>{e.v(t=>Promise.all(["server/chunks/src_lib_credits_store_ts_40181bd8._.js"].map(t=>e.l(t))).then(()=>t(685750)))},119949,e=>{e.v(e=>Promise.resolve().then(()=>e(124594)))}];

//# debugId=bea1d68b-f63c-c4fd-53b9-9b4a6c5c9ac6
//# sourceMappingURL=%5Broot-of-the-server%5D__e42cc4a9._.js.map