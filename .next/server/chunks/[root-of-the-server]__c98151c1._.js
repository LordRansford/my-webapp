;!function(){try { var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof global?global:"undefined"!=typeof window?window:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&((e._debugIds|| (e._debugIds={}))[n]="0dd16781-082c-248e-6513-364a7ecb6d00")}catch(e){}}();
module.exports=[814747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},522734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},657194,e=>{"use strict";var t=e.i(89171),r=e.i(254799);let s=new Map;function i(e,i){var n,a;let o,u,l,d=Date.now(),c=`${i.keyPrefix}:${(n=i.keySuffix,o=e.headers.get("x-forwarded-for")||"",u=o.split(",")[0]?.trim()||e.headers.get("x-real-ip")||"unknown",l=e.headers.get("user-agent")||"unknown",a=`${u}|${l}|${n||""}`,r.default.createHash("sha256").update(a).digest("hex").slice(0,24))}`,p=s.get(c);if(!p||p.resetAt<=d)return s.set(c,{count:1,resetAt:d+i.windowMs}),null;if(p.count+=1,p.count>i.limit){let e=Math.max(1,Math.ceil((p.resetAt-d)/1e3));return t.NextResponse.json({error:i.message||"Too many requests. Please try again shortly."},{status:429,headers:{"retry-after":String(e)}})}return null}e.s(["rateLimit",()=>i])},663775,e=>{"use strict";var t=e.i(89171),r=e.i(757660),s=e.i(568212),i=e.i(324831);async function n(e="VIEW_SYSTEM"){let a=await (0,r.getServerSession)(s.authOptions).catch(()=>null);if(!a?.user)return{ok:!1,response:t.NextResponse.json({error:"Unauthorized"},{status:401})};try{let{role:t}=(0,i.requireAdminPermission)(a.user,e);return{ok:!0,session:a,role:t}}catch(r){let e="number"==typeof r?.status?r.status:403;return{ok:!1,response:t.NextResponse.json({error:"Forbidden"},{status:e})}}}e.s(["requireAdminJson",()=>n])},563502,e=>{"use strict";var t=e.i(254799);function r(e){return Math.round((Number(e)||0)/60*10)/10}function s(e){return Math.max(0,Math.round(60*(Number(e)||0)))}function i(e){if(!e||"object"!=typeof e)return{ok:!1,error:"State must be an object"};if(!Array.isArray(e.sections)||!Array.isArray(e.activity))return{ok:!1,error:"State must contain sections and activity arrays"};for(let t of e.sections){if(!t.trackId||!t.levelId||!t.sectionId)return{ok:!1,error:"Section missing identifiers"};if(0>Number(t.minutes))return{ok:!1,error:"Section minutes must be non-negative"}}for(let t of e.activity){if(!t.id||!t.trackId||!t.levelId||!t.sectionId||!t.timestamp)return{ok:!1,error:"Activity missing fields"};if(!Number.isFinite(Number(t.minutesDelta)))return{ok:!1,error:"Activity minutesDelta must be numeric"}}return{ok:!0}}function n(e){let r={...e,rulesVersion:"v1"},s=JSON.stringify(r),i=t.default.createHash("sha256").update(s).digest("hex");return{...r,hash:i}}function a(e,t){let s=(e?.activity||[]).filter(e=>e.trackId===t),i=s.reduce((e,t)=>e+(Number(t.minutesDelta)||0),0);return{trackId:t,totalMinutesFromActivity:i,totalHoursFromActivity:r(i),recent:s.slice(0,50).map(e=>({id:e.id,timestamp:e.timestamp,minutesDelta:e.minutesDelta,note:e.note||"",levelId:e.levelId,sectionId:e.sectionId}))}}e.s(["CPD_RULES_VERSION",0,"v1","buildEvidenceRecord",()=>n,"explainCredits",()=>a,"hoursToMinutes",()=>s,"minutesToHours",()=>r,"validateCpdState",()=>i])},228905,e=>{"use strict";var t=e.i(563502);function r(e){let r=(0,t.validateCpdState)(e);if(!r.ok)throw Error(r.error)}e.s(["validateCpdStateOrThrow",()=>r])},751012,e=>{"use strict";var t=e.i(747909),r=e.i(174017),s=e.i(996250),i=e.i(759756),n=e.i(561916),a=e.i(114444),o=e.i(837092),u=e.i(869741),l=e.i(316795),d=e.i(487718),c=e.i(995169),p=e.i(47587),h=e.i(666012),m=e.i(570101),f=e.i(626937),y=e.i(10372),v=e.i(193695);e.i(52474);var g=e.i(600220),w=e.i(89171),A=e.i(124594),S=e.i(663775),R=e.i(657194),b=e.i(400652);let I=new Set(["cybersecurity"]);function x(e){if(!e)return null;try{return JSON.parse(e)}catch{return null}}function $(e){return["A","B","C","D","E","F"][e]||String(e+1)}async function C(e,t){let r=await (0,S.requireAdminJson)("VIEW_USERS");if(!r.ok)return r.response;let s=r.session?.user;if(!s?.id)return w.NextResponse.json({error:"Unauthorized"},{status:401});let i=s.email||s.id,n=(0,R.rateLimit)(e,{keyPrefix:"admin-accreditation-bundle",limit:20,windowMs:6e4,keySuffix:i});if(n)return n;let{id:a}=await t.params,{searchParams:o}=new URL(e.url),u=String(o.get("courseId")||"cybersecurity").trim();if(!I.has(u))return w.NextResponse.json({error:"Invalid courseId"},{status:400});let l=process.env.NEXT_PUBLIC_SITE_URL||"https://www.ransfordsnotes.com",d=await A.prisma.userIdentity.findUnique({where:{id:a},select:{id:!0,email:!0,createdAt:!0,lastLoginAt:!0,lastActiveAt:!0}});if(!d)return w.NextResponse.json({error:"Not found"},{status:404});let c=await A.prisma.learnerProfile.findUnique({where:{userId:a},select:{certificateName:!0,lockedAt:!0}}).catch(()=>null),p=await A.prisma.cpdState.findUnique({where:{userId:a},select:{stateJson:!0,updatedAt:!0}}).catch(()=>null),h=x(p?.stateJson||null)||{sections:[],activity:[]},m="cybersecurity"===u?["foundations","applied","practice"]:[],f="cybersecurity"===u?"Cybersecurity":u,y=m.map(e=>(0,b.buildCourseEvidenceSummary)({courseId:"cybersecurity",levelId:e,courseTitle:f,learnerIdentifier:d.email,cpdState:h})),v=await A.prisma.assessmentAttempt.findMany({where:{userId:a,assessment:{courseId:u}},orderBy:{completedAt:"desc"},take:50,select:{id:!0,score:!0,passed:!0,timeSpent:!0,completedAt:!0,courseVersion:!0,assessment:{select:{levelId:!0}}}}),g=await A.prisma.certificate.findMany({where:{userId:a,courseId:{startsWith:`${u}:`}},orderBy:{issuedAt:"desc"},take:20,select:{id:!0,courseId:!0,courseVersion:!0,issuedAt:!0,certificateHash:!0,status:!0}}).catch(()=>[]),C=[];for(let e of(C.push("# Accreditation bundle"),C.push(""),C.push(`Course ${u}`),C.push(`Generated ${new Date().toISOString()}`),C.push(""),C.push("## Learner"),C.push(""),C.push(`User id ${d.id}`),C.push(`Email ${d.email}`),C.push(`Created ${d.createdAt.toISOString()}`),C.push(`Last login ${d.lastLoginAt.toISOString()}`),C.push(`Last active ${d.lastActiveAt.toISOString()}`),C.push(`Certificate name ${c?.certificateName||"Not set"}`),C.push(""),C.push("## CPD evidence summaries"),C.push(""),C.push(`CPD state updated ${p?.updatedAt?new Date(p.updatedAt).toISOString():"Not available"}`),C.push(""),y))C.push(`### ${e.levelId}`),C.push(""),C.push(`Estimated hours ${e.estimatedHours}`),C.push(`Recorded hours ${e.recordedHours}`),C.push(`Completion date ${e.completionDate||"Not completed"}`),C.push(`Sections completed ${e.evidenceSignals.sectionsCompleted}`),C.push(`Minutes logged ${e.evidenceSignals.minutesLogged}`),C.push(`Quizzes completed ${e.evidenceSignals.quizzesCompleted}`),C.push(`Tool events ${e.evidenceSignals.toolEvents}`),C.push("");for(let e of(C.push("## Assessment attempts"),C.push(""),C.push(`Total attempts ${v.length}`),C.push(""),v.slice(0,20)))C.push(`- Attempt ${e.id}`),C.push(`  Level ${e.assessment.levelId}`),C.push(`  Version ${e.courseVersion}`),C.push(`  Score ${e.score} percent`),C.push(`  Passed ${e.passed?"yes":"no"}`),C.push(`  Time spent seconds ${e.timeSpent}`),C.push(`  Completed ${e.completedAt.toISOString()}`),C.push("");if(C.push("## Certificates"),C.push(""),g.length)for(let e of g){let t=`${l}/verify/certificate/${encodeURIComponent(e.certificateHash)}`;C.push(`- ${e.courseId}`),C.push(`  Status ${e.status}`),C.push(`  Version ${e.courseVersion}`),C.push(`  Issued ${new Date(e.issuedAt).toISOString()}`),C.push(`  Verify ${t}`),C.push("")}else C.push("No certificates issued"),C.push("");let E=await A.prisma.assessmentAttempt.findFirst({where:{userId:a,assessment:{courseId:u,levelId:"practice"}},orderBy:{completedAt:"desc"},select:{id:!0,answers:!0,completedAt:!0,score:!0,passed:!0,courseVersion:!0,questionIds:!0}});if(E){let e=x(E.questionIds)||[],t=new Map((await A.prisma.question.findMany({where:{id:{in:Array.isArray(e)?e:[]}},select:{id:!0,question:!0,options:!0,correctAnswer:!0,explanation:!0},take:500})).map(e=>[e.id,e])),r=(Array.isArray(e)?e:[]).map(e=>String(e)).map(e=>t.get(e)).filter(Boolean),s=x(E.answers)||{};C.push("## Practice constructive feedback"),C.push(""),C.push(`Attempt ${E.id}`),C.push(`Completed ${E.completedAt.toISOString()}`),C.push(`Version ${E.courseVersion}`),C.push(`Score ${E.score} percent`),C.push(`Passed ${E.passed?"yes":"no"}`),C.push("");let i=1;for(let e of r){let t=s?.[e.id],r=function(e){if(null==e)return null;if("number"==typeof e||"string"==typeof e||Array.isArray(e))return e;if("object"==typeof e){let t=e.choice;if("number"==typeof t||"string"==typeof t||Array.isArray(t))return t}return null}(t),n=t&&"object"==typeof t&&"string"==typeof t.justification?String(t.justification):"",a=x(e.correctAnswer),o=x(e.options)||[],u="number"==typeof r?$(r):"Not answered",l="number"==typeof a?$(a):String(a),d="number"==typeof a&&"number"==typeof r&&a===r;if(C.push(`### Q${i}`),C.push(""),C.push(`Result ${d?"correct":"incorrect"}`),C.push(`Correct ${l}`),C.push(`Learner ${u}`),C.push(""),C.push("Question"),C.push(String(e.question||"").trim()),C.push(""),o.length){C.push("Options");for(let e=0;e<o.length;e+=1)C.push(`${$(e)}. ${String(o[e])}`);C.push("")}C.push("Learner reasoning"),C.push(n?n.trim():"No reasoning provided"),C.push(""),C.push("Model rationale"),C.push(String(e.explanation||"").trim()),C.push(""),i+=1}}let N=C.join("\n"),k=`accreditation-bundle-${u}-${d.email.replace(/[^a-z0-9._-]+/gi,"_")}.md`;return new w.NextResponse(N,{status:200,headers:{"Content-Type":"text/markdown; charset=utf-8","Content-Disposition":`attachment; filename="${k}"`}})}e.s(["GET",()=>C],854062);var E=e.i(854062);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/users/[id]/accreditation-bundle/route",pathname:"/api/admin/users/[id]/accreditation-bundle",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/users/[id]/accreditation-bundle/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:k,workUnitAsyncStorage:T,serverHooks:O}=N;function P(){return(0,s.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:T})}async function M(e,t,s){N.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/admin/users/[id]/accreditation-bundle/route";w=w.replace(/\/index$/,"")||"/";let A=await N.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:S,params:R,nextConfig:b,parsedUrl:I,isDraftMode:x,prerenderManifest:$,routerServerContext:C,isOnDemandRevalidate:E,revalidateOnlyGenerated:k,resolvedPathname:T,clientReferenceManifest:O,serverActionsManifest:P}=A,M=(0,u.normalizeAppPath)(w),q=!!($.dynamicRoutes[M]||$.routes[T]),_=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,I,!1):t.end("This page could not be found"),null);if(q&&!x){let e=!!$.routes[T],t=$.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await _();throw new v.NoFallbackError}}let D=null;!q||N.isDev||x||(D="/index"===(D=T)?"/":D);let U=!0===N.isDev||!q,H=q&&!U;P&&O&&(0,a.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:O,serverActionsManifest:P,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:P})});let j=e.method||"GET",L=(0,n.getTracer)(),V=L.getActiveScopeSpan(),F={params:R,prerenderManifest:$,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>N.onRequestError(e,t,s,C)},sharedContext:{buildId:S}},B=new l.NodeNextRequest(e),z=new l.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let a=async e=>N.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${j} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${w}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var n,u;let l=async({previousCacheEntry:r})=>{try{if(!o&&E&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await a(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let u=F.renderOpts.pendingWaitUntil;u&&s.waitUntil&&(s.waitUntil(u),u=void 0);let l=F.renderOpts.collectedTags;if(!q)return await (0,h.sendResponse)(B,z,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[y.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,s=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:E})},C),t}},d=await N.handleResponse({req:e,nextConfig:b,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:$,isRoutePPREnabled:!1,isOnDemandRevalidate:E,revalidateOnlyGenerated:k,responseGenerator:l,waitUntil:s.waitUntil,isMinimalMode:o});if(!q)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",E?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&q||c.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,f.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(B,z,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};V?await u(V):await L.withPropagatedContext(e.headers,()=>L.trace(c.BaseServerSpan.handleRequest,{spanName:`${j} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},u))}catch(t){if(t instanceof v.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:E})}),q)throw t;return await (0,h.sendResponse)(B,z,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>P,"routeModule",()=>N,"serverHooks",()=>O,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>T],751012)}];

//# debugId=0dd16781-082c-248e-6513-364a7ecb6d00
//# sourceMappingURL=%5Broot-of-the-server%5D__c98151c1._.js.map